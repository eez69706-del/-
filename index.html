<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الحضور والانصراف الذكي</title>
    
    <!-- مكتبات CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- أنماط مخصصة -->
    <style>


/* ===== متغيرات CSS ===== */
:root {
    --primary: #667eea;
    --primary-light: #8b9cff;
    --primary-dark: #5a67d8;
    --secondary: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    
    /* ألوان الوضع الفاتح */
    --light-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --light-card-bg: rgba(255, 255, 255, 0.95);
    --light-card-border: rgba(255, 255, 255, 0.3);
    --light-text: #1e293b;
    --light-label: #64748b;
    --light-input-bg: rgba(255, 255, 255, 0.95);
    --light-input-border: rgba(102, 126, 234, 0.2);
    --light-table-bg: rgba(255, 255, 255, 0.95);
    --light-table-border: rgba(255, 255, 255, 0.3);
    
    /* ألوان الوضع المظلم */
    --dark-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    --dark-card-bg: rgba(30, 41, 59, 0.9);
    --dark-card-border: rgba(255, 255, 255, 0.1);
    --dark-text: #e2e8f0;
    --dark-label: #94a3b8;
    --dark-input-bg: rgba(30, 41, 59, 0.9);
    --dark-input-border: rgba(255, 255, 255, 0.1);
    --dark-table-bg: rgba(30, 41, 59, 0.9);
    --dark-table-border: rgba(255, 255, 255, 0.1);
    
    /* متغيرات ديناميكية */
    --current-bg: var(--light-bg);
    --current-card-bg: var(--light-card-bg);
    --current-card-border: var(--light-card-border);
    --current-text: var(--light-text);
    --current-label: var(--light-label);
    --current-input-bg: var(--light-input-bg);
    --current-input-border: var(--light-input-border);
    --current-table-bg: var(--light-table-bg);
    --current-table-border: var(--light-table-border);
    --glass-bg: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
}

/* ===== إعادة الضبط الأساسي ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Cairo', sans-serif;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
}

html {
    scroll-behavior: smooth;
}

body {
    background: var(--current-bg);
    min-height: 100vh;
    position: relative;
    transition: all 0.5s ease;
    overflow-x: hidden;
    color: var(--current-text);
    line-height: 1.6;
}









/* زر الرجوع داخل لوحة التحكم */
.admin-home-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.admin-home-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

/* ===== تأثيرات الخلفية ===== */
body::before {
    content: '';
    position: fixed;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: 
        radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.3) 0%, transparent 50%);
    animation: rotate 20s linear infinite;
    pointer-events: none;
    z-index: -2;
}

body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
    pointer-events: none;
    z-index: -1;
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ===== الحاوية الرئيسية ===== */
.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 1;
}

/* ===== البطاقات الزجاجية ===== */
.stat-card {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    padding: 35px;
    border-radius: 24px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    text-align: center;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--current-card-border);
    color: var(--current-text);
    margin-bottom: 30px;
}

ل

.stat-card:hover::before {
    left: 100%;
}

.stat-card::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.5s;
}

.stat-card:hover::after {
    opacity: 1;
}

.stat-card:hover {
    transform: translateY(-15px) scale(1.03) rotateX(5deg);
    box-shadow: 
        0 20px 60px rgba(102, 126, 234, 0.3),
        0 0 0 1px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

.stat-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.3));
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(5deg); }
}

.stat-number {
    font-size: 3.5rem;
    font-weight: 900;
    margin: 20px 0;
    background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 50%, #f59e0b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    position: relative;
}

.stat-label {
    color: var(--current-label);
    font-size: 1.1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    position: relative;
}

/* ===== الأزرار الحديثة ===== */
.btn {
    padding: 16px 32px;
    border-radius: 16px;
    border: none;
    cursor: pointer;
    font-weight: 800;
    font-size: 1rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    color: white !important;
    text-decoration: none;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
    width: 300px;
    height: 300px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 
        0 8px 20px rgba(102, 126, 234, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-primary:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(102, 126, 234, 0.5),
        0 0 0 1px rgba(102, 126, 234, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    box-shadow: 
        0 8px 20px rgba(16, 185, 129, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-success:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(16, 185, 129, 0.5),
        0 0 0 1px rgba(16, 185, 129, 0.3);
}

.btn-danger {
    background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    box-shadow: 
        0 8px 20px rgba(239, 68, 68, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-danger:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(239, 68, 68, 0.5),
        0 0 0 1px rgba(239, 68, 68, 0.3);
}




/* تصميم زر الرجوع */
.btn-back {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
    transition: all 0.3s;
}

.btn-back:hover {
    transform: translateX(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}





.btn-warning {
    background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
    box-shadow: 
        0 8px 20px rgba(245, 158, 11, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-warning:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(245, 158, 11, 0.5),
        0 0 0 1px rgba(245, 158, 11, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    box-shadow: 
        0 8px 20px rgba(107, 114, 128, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(107, 114, 128, 0.5),
        0 0 0 1px rgba(107, 114, 128, 0.3);
}

.btn-sm {
    padding: 10px 20px;
    font-size: 0.875rem;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(1);
}

.btn:disabled:hover {
    transform: none;
}

/* ===== الإدخالات الزجاجية ===== */
.input-group {
    margin-bottom: 24px;
    position: relative;
}

.input-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 800;
    color: var(--current-text);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

input, textarea, select {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid var(--current-input-border);
    border-radius: 16px;
    font-size: 1rem;
    transition: all 0.4s;
    background: var(--current-input-bg);
    backdrop-filter: blur(10px);
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    color: var(--current-text);
}

input::placeholder,
textarea::placeholder,
select option {
    color: var(--current-label);
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 
        0 0 0 4px rgba(102, 126, 234, 0.15),
        0 8px 20px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
}

/* ===== الجداول الحديثة ===== */
.table-container {
    overflow-x: auto;
    border-radius: 20px;
    box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    background: var(--current-table-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--current-table-border);
    margin-bottom: 30px;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 600px;
}

th {
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    color: white !important;
    padding: 20px;
    text-align: right;
    font-weight: 900;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
}

th:first-child {
    border-top-right-radius: 20px;
}

th:last-child {
    border-top-left-radius: 20px;
}

td {
    padding: 18px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s;
    background: transparent;
    color: var(--current-text) !important;
}

tr:last-child td {
    border-bottom: none;
}

tr:hover td {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, transparent 100%);
    transform: translateX(-5px);
}

/* ===== الشارات الحديثة ===== */
.badge {
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 900;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    color: white !important;
}

.badge-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.badge-warning {
    background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
}

.badge-danger {
    background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
}

.badge-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

/* ===== التنبيهات الحديثة ===== */
.alert {
    padding: 18px 24px;
    border-radius: 16px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    font-weight: 700;
    box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-right: 5px solid;
    backdrop-filter: blur(10px);
    color: var(--current-text) !important;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}


.alert-success {
    background: linear-gradient(135deg, rgba(17, 153, 142, 0.15) 0%, rgba(56, 239, 125, 0.15) 100%);
    border-color: var(--secondary);
}


/* ============================= */
/* ===== إصلاح النصوص السوداء ===== */
/* ============================= */






body.dark-mode,
body.dark-mode .stat-label,
body.dark-mode .header p,
body.dark-mode .footer,
body.dark-mode .input-group label,
body.dark-mode .alert,
body.dark-mode .tab-btn:not(.active),
body.dark-mode .role-item:not(.selected),
body.dark-mode .employee-card,
body.dark-mode .stat-card,
body.dark-mode .modal-content,
body.dark-mode .navbar,
body.dark-mode .table-container,
body.dark-mode td,
body.dark-mode input,
body.dark-mode textarea,
body.dark-mode select {
    color: #ffffff !important;
}

/* إصلاح النصوص داخل العناصر */
body.dark-mode *:not(.btn):not(.badge):not(.role-badge):not(th):not(i):not(.fas):not(.fa) {
    color: #ffffff !important;
}

/* إصلاح النصوص داخل الجداول */
body.dark-mode table *:not(.btn):not(.badge) {
    color: #ffffff !important;
}

/* إصلاح النصوص في العناصر الديناميكية */
body.dark-mode [class*="text-"]:not(.btn):not(.badge):not(.role-badge) {
    color: #ffffff !important;
}

/* إصلاح النصوص في جميع البطاقات */
body.dark-mode .card,
body.dark-mode [class*="card"]:not(.btn):not(.badge) {
    color: #ffffff !important;
}

/* التأكيد على أن كلمات تسجيل الدخول والخروج والإجازات تكون بيضاء */
body.dark-mode .stat-card .stat-label,
body.dark-mode .btn span,
body.dark-mode .modal-content label,
body.dark-mode .employee-card p,
body.dark-mode .employee-card span {
    color: #ffffff !important;
}






.alert-error {
    background: linear-gradient(135deg, rgba(238, 9, 121, 0.15) 0%, rgba(255, 106, 0, 0.15) 100%);
    border-color: var(--danger);
}

.alert-info {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
    border-color: var(--info);
}



/* بس أيقونة طلبات الاستقالة تكون حمرا */



/* ===== النوافذ المنبثقة الحديثة ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(15px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.4s ease;
}

.modal.active {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    padding: 35px;
    border-radius: 24px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 0 1px var(--current-card-border);
    animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid var(--current-card-border);
    color: var(--current-text) !important;
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.7) translateY(30px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-close {
    position: absolute;
    top: 20px;
    left: 20px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--current-text);
}

/* ===== شاشة التحميل الحديثة ===== */
.loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--current-card-bg);
    backdrop-filter: blur(15px);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading.active {
    display: flex;
}

.spinner {
    width: 70px;
    height: 70px;
    border: 7px solid rgba(0, 0, 0, 0.1);
    border-top: 7px solid var(--primary);
    border-right: 7px solid var(--info);
    border-radius: 50%;
    animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    box-shadow: 
        0 0 30px rgba(102, 126, 234, 0.4),
        inset 0 0 20px rgba(102, 126, 234, 0.1);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ===== التبويبات الحديثة ===== */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 18px 28px;
    border: none;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    cursor: pointer;
    font-weight: 800;
    font-size: 1rem;
    transition: all 0.4s;
    position: relative;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--current-label) !important;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
    border-radius: 16px;
}

.tab-btn::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
    transform: scaleX(0);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 4px 4px 0 0;
}

.tab-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    color: var(--primary) !important;
    transform: translateY(-2px);
}

.tab-btn.active {
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    color: white !important;
    box-shadow: 
        0 4px 12px rgba(102, 126, 234, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.tab-btn.active::after {
    transform: scaleX(1);
}

.tab-content {
    display: none;
    animation: fadeInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.tab-content.active {
    display: block;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== رتب الموظفين الحديثة ===== */
.role-badge {
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 900;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    color: white !important;
}

.role-badge-admin {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.role-badge-manager {
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
}

.role-badge-employee {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

/* ===== عناصر الرتب ===== */
.role-item {
    background: var(--current-card-bg);
    backdrop-filter: blur(10px);
    border: 2px solid var(--current-input-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 12px;
    cursor: pointer;
    color: var(--current-text) !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.role-item:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    transform: translateX(-8px) scale(1.02);
    border-color: var(--primary);
    box-shadow: 
        0 8px 20px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.role-item.selected {
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%) !important;
    color: white !important;
    border-color: var(--primary);
    box-shadow: 
        0 12px 30px rgba(102, 126, 234, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    transform: translateX(-8px) scale(1.05);
}

/* ===== التوست الحديث ===== */
.toast {
    position: fixed;
    top: 30px;
    right: 30px;
    padding: 18px 28px;
    border-radius: 16px;
    color: white !important;
    font-weight: 800;
    z-index: 10000;
    animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.4s ease 2.7s forwards;
    box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    max-width: 400px;
}

.toast-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.toast-error {
    background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
}

.toast-info {
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
}

/* ===== إصلاح خلفيات البطاقات في الوضع المظلم ===== */
body.dark-mode .stat-card,
body.dark-mode .modal-content,
body.dark-mode .employee-card,
body.dark-mode .navbar,
body.dark-mode .footer,
body.dark-mode .role-item,
body.dark-mode .table-container,
body.dark-mode .card-hover,
body.dark-mode .bg-white,
body.dark-mode .rounded-xl,
body.dark-mode .rounded-2xl {
    background-color: var(--dark-card-bg) !important;
    border-color: var(--dark-card-border) !important;
}

/* إصلاح خلفيات العناصر البيضاء */
body.dark-mode div[class*="bg-white"],
body.dark-mode .bg-white {
    background-color: var(--dark-card-bg) !important;
}

/* إصلاح ألوان النصوص */
body.dark-mode .text-gray-800,
body.dark-mode .text-gray-700,
body.dark-mode .text-gray-600,
body.dark-mode .text-gray-500,
body.dark-mode .text-gray-400 {
    color: #e2e8f0 !important;
}

/* إصلاح خلفيات الأقسام */
body.dark-mode .bg-gradient-primary,
body.dark-mode .bg-gradient-secondary {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
}

/* إصلاح خلفيات العناصر الصغيرة */
body.dark-mode .bg-gray-100,
body.dark-mode .bg-gray-50,
body.dark-mode .bg-gray-200 {
    background-color: rgba(30, 41, 59, 0.5) !important;
}

/* إصلاح الحدود */
body.dark-mode .border,
body.dark-mode .border-gray-200,
body.dark-mode .border-t,
body.dark-mode .border-b {
    border-color: var(--dark-card-border) !important;
}









@keyframes slideInRight {
    from {
        transform: translateX(400px) scale(0.8);
        opacity: 0;
    }
    to {
        transform: translateX(0) scale(1);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from { 
        opacity: 1; 
        transform: translateX(0);
    }
    to { 
        opacity: 0; 
        transform: translateX(400px) scale(0.8);
    }
}

/* ===== زر الوضع الليلي الحديث ===== */
#darkModeToggle {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    color: white !important;
    border: none;
    font-size: 26px;
    z-index: 9999;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 
        0 10px 35px rgba(102, 126, 234, 0.5),
        inset 0 2px 0 rgba(255, 255, 255, 0.3);
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

#darkModeToggle:hover {
    transform: scale(1.2) rotate(180deg);
    box-shadow: 
        0 15px 50px rgba(102, 126, 234, 0.7),
        0 0 0 8px rgba(102, 126, 234, 0.1);
}

/* ===== بطاقات الموظفين ===== */
.employee-card {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    border: 1px solid var(--current-card-border);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    color: var(--current-text) !important;
}

.employee-card:hover {
    transform: translateY(-10px);
    box-shadow: 
        0 15px 40px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

/* ===== التنقل ===== */
.navbar {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    padding: 20px 30px;
    border-radius: 20px;
    margin-bottom: 30px;
    border: 1px solid var(--current-card-border);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    color: var(--current-text) !important;
}

.nav-links {
    display: flex;
    gap: 20px;
    list-style: none;
}

.nav-links a {
    color: var(--current-text) !important;
    text-decoration: none;
    font-weight: 700;
    padding: 10px 20px;
    border-radius: 12px;
    transition: all 0.3s;
}

.nav-links a:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
}

/* ===== الترويسة ===== */
.header {
    text-align: center;
    padding: 40px 0;
    margin-bottom: 40px;
}

.header h1 {
    font-size: 3rem;
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 20px;
    color: transparent !important;
}





.header p {
    color: var(--current-label) !important;
    font-size: 1.2rem;
}

/* ===== الشبكة ===== */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
}

/* ===== الفوتر ===== */
.footer {
    text-align: center;
    padding: 30px;
    margin-top: 50px;
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid var(--current-card-border);
    color: var(--current-label) !important;
}

/* ============================= */
/* ===== الوضع الليلي الكامل ===== */
/* ============================= */

body.dark-mode {
    --current-bg: var(--dark-bg);
    --current-card-bg: var(--dark-card-bg);
    --current-card-border: var(--dark-card-border);
    --current-text: var(--dark-text);
    --current-label: var(--dark-label);
    --current-input-bg: var(--dark-input-bg);
    --current-input-border: var(--dark-input-border);
    --current-table-bg: var(--dark-table-bg);
    --current-table-border: var(--dark-table-border);
}

/* قاعدة عامة للنصوص في الوضع المظلم */
body.dark-mode,
body.dark-mode .stat-card,
body.dark-mode .modal-content,
body.dark-mode .employee-card,
body.dark-mode .navbar,
body.dark-mode .footer,
body.dark-mode .role-item,
body.dark-mode .tab-btn:not(.active),
body.dark-mode input,
body.dark-mode textarea,
body.dark-mode select,
body.dark-mode .alert,
body.dark-mode td,
body.dark-mode .input-group label {
    color: var(--dark-text) !important;
}

/* إصلاح الأماكن التي قد تظهر بيضاء */
body.dark-mode [class*="white"],
body.dark-mode [class*="bg-white"],
body.dark-mode [style*="background-color: white"],
body.dark-mode [style*="background: white"],
body.dark-mode [style*="color: white"]:not(.btn):not(.badge):not(.role-badge):not(th) {
    background-color: var(--dark-card-bg) !important;
    color: var(--dark-text) !important;
}

/* إصلاح الحدود */
body.dark-mode .stat-card,
body.dark-mode .modal-content,
body.dark-mode .employee-card,
body.dark-mode .navbar,
body.dark-mode .footer,
body.dark-mode .role-item,
body.dark-mode .table-container,
body.dark-mode input,
body.dark-mode textarea,
body.dark-mode select {
    border-color: var(--dark-card-border) !important;
}

/* إصلاح التبويبات */
body.dark-mode .tab-btn:not(.active) {
    background: rgba(30, 41, 59, 0.9) !important;
    color: var(--dark-label) !important;
}

body.dark-mode .tab-btn:not(.active):hover {
    background: rgba(102, 126, 234, 0.2) !important;
    color: var(--dark-text) !important;
}

/* إصلاح الجداول */
body.dark-mode td {
    border-bottom-color: rgba(255, 255, 255, 0.1) !important;
}

/* إصلاح التسميات */
body.dark-mode .stat-label,
body.dark-mode .header p,
body.dark-mode .footer {
    color: var(--dark-label) !important;
}

/* إصلاح العناصر النشطة */
body.dark-mode .tab-btn.active,
body.dark-mode .role-item.selected {
    color: white !important;
}

/* إصلاح الظلال */
body.dark-mode .stat-card,
body.dark-mode .modal-content,
body.dark-mode .employee-card,
body.dark-mode .navbar,
body.dark-mode .footer,
body.dark-mode .role-item,
body.dark-mode .table-container,
body.dark-mode .tab-btn,
body.dark-mode input,
body.dark-mode textarea,
body.dark-mode select,
body.dark-mode .alert {
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
}

/* التأكيد على أن الأزرار والشعارات تبقى ملونة */
body.dark-mode .btn,
body.dark-mode .badge,
body.dark-mode .role-badge,
body.dark-mode th {
    color: white !important;
}



/* التأكيد على أن العناوين الكبيرة تبقى شفافة */
body.dark-mode .header h1,
body.dark-mode .stat-number,
body.dark-mode .stat-icon {
    color: transparent !important;
}

/* ===== التجاوب ===== */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .stat-card {
        padding: 25px;
    }
    
    .stat-number {
        font-size: 2.5rem;
    }
    
    .stat-icon {
        font-size: 3rem;
    }
    
    .btn {
        padding: 14px 24px;
        font-size: 0.9rem;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .grid {
        grid-template-columns: 1fr;
    }
    
    .nav-links {
        flex-direction: column;
        gap: 10px;
    }
    
    #darkModeToggle {
        width: 55px;
        height: 55px;
        bottom: 20px;
        left: 20px;
        font-size: 22px;
    }
}

@media (max-width: 480px) {
    .stat-card {
        padding: 20px;
    }
    
    .modal-content {
        padding: 25px;
        width: 95%;
    }
    
    .toast {
        right: 15px;
        left: 15px;
        max-width: none;
    }
}






 </style>
</head>
<link rel="icon" href="image.png">



    <!-- زر الوضع الليلي -->
    <button id="darkModeToggle" title="تبديل الوضع الليلي">
        <i class="fas fa-moon"></i>
    </button>

    <!-- شاشة التحميل -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>



<link rel="icon" href="https://www.w3.org/favicon.ico">


    
    <!-- الصفحة الرئيسية -->
    <div id="mainPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full card-hover">
            <div class="text-center mb-10 logo-container">
                <div class="text-6xl mb-6 text-blue-600">
                    <i class="fas fa-user-clock"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-gray-800 mb-2">تسجيل الدخول</h1>
                <p class="text-gray-600">سجل دخولك لبدء استخدام النظام</p>
            </div>
            
            <!-- رسالة تنبيه -->
            <div id="mainAlert" class="alert hidden"></div>
            
            <!-- نموذج تسجيل الدخول -->
            <form id="loginForm">
                <div class="input-group">
                    <label for="loginPhone" class="flex items-center gap-2">
                        <i class="fas fa-phone text-blue-600"></i>
                        رقم الجوال
                    </label>
                    <input type="tel" id="loginPhone" placeholder=" 05xxxxxxxx " required 
                           pattern="05[0-9]{8}" class="focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="input-group">
                    <label for="loginPassword" class="flex items-center gap-2">
                        <i class="fas fa-lock text-blue-600"></i>
                        كلمة المرور
                    </label>
                    <input type="password" id="loginPassword" placeholder= "ادخل كلمة المرور" required
                           minlength="6" class="focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button type="submit" class="btn btn-primary w-full text-lg py-3 mb-4 btn-pulse">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
            
                
                <button onclick="openModal('forgotModal')" class="btn btn-warning w-full py-3">
                    <i class="fas fa-key"></i>
                    نسيت كلمة المرور
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-gray-500 text-sm">
                </p>
            </div>
        </div>
    </div>

    <!-- لوحة المستخدم العادي -->
    <div id="userPanel" class="min-h-screen hidden">
        <!-- شريط التنقل -->
        <div class="bg-gradient-primary text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">
                        <i class="fas fa-user-clock ml-2"></i>
                        لوحة التحكم
                    </h1>
                    <p class="text-sm opacity-90" id="userGreeting">مرحباً</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="currentTime" class="text-sm"></span>
                    <span class="role-badge" id="userRoleBadge"></span>
                    <button onclick="logout()" class="btn btn-danger text-sm">
                        <i class="fas fa-sign-out-alt"></i>
                        خروج
                    </button>
                </div>
            </div>
        </div>
        




        <div class="container mx-auto p-4">
            <!-- بطاقة معلومات المستخدم -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 card-hover">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-2xl font-bold text-gray-800" id="userDisplayName"></h2>
                        <div class="flex flex-wrap items-center gap-4 mt-2">
                            <span class="text-gray-600" id="userDisplayDepartment"></span>
                            <span class="text-gray-500" id="userDisplayPhone"></span>
                            <span class="role-badge" id="userRoleDisplay"></span>
                        </div>
                        <div class="mt-3">
                            <span class="text-gray-700" id="userCurrentRank">الرتبة الحالية: </span>
                            <span class="text-blue-600 font-bold" id="userRankName"></span>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl mb-2" id="userStatusIcon">⭕</div>
                        <span class="badge" id="userStatusText">غير مسجل</span>
                    </div>
                </div>
            </div>

            <!-- إحصائيات سريعة -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="userStatsSection">
                <div class="stat-card">
                    <div class="stat-icon text-blue-500">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-number text-blue-600" id="userDays">0</div>
                    <div class="stat-label">أيام الحضور</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-green-500">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number text-green-600" id="userHours">0</div>
                    <div class="stat-label">إجمالي الساعات</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-purple-500">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-number text-purple-600" id="userAvg">0</div>
                    <div class="stat-label">متوسط يومي</div>
                </div>
            </div>
            
            <!-- أزرار التحكم -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="attendanceSection">
                <div class="bg-white rounded-xl shadow p-6 card-hover">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-sign-in-alt ml-2"></i>
                        تسجيل الدخول
                    </h3>
                    <p class="text-gray-600 mb-4">سجل دخولك لبدء العمل</p>
                    <button id="attendanceLoginBtn" onclick="attendanceLogin()" 
                            class="btn btn-success w-full py-3">
                        <i class="fas fa-door-open"></i>
                        تسجيل دخول
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow p-6 card-hover">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-sign-out-alt ml-2"></i>
                        تسجيل الخروج
                    </h3>
                    <p class="text-gray-600 mb-4">سجل خروجك بعد انتهاء العمل</p>
                    <button id="attendanceLogoutBtn" onclick="openModal('logoutModal')" 
                            class="btn btn-danger w-full py-3" disabled>
                        <i class="fas fa-door-closed"></i>
                        تسجيل خروج
                    </button>
                </div>
            </div>
            
            <!-- خدمات إضافية -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="requestsSection">
                <div class="bg-white rounded-xl shadow p-6 card-hover" id="leaveRequestSection">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-umbrella-beach ml-2"></i>
                        طلب إجازة
                    </h3>
                    <p class="text-gray-600 mb-4">تقديم طلب للحصول على إجازة</p>
                    <button onclick="openModal('leaveModal')" class="btn btn-warning w-full py-3">
                        <i class="fas fa-file-export"></i>
                        تقديم طلب
                    </button>
                </div>
                

                
                <div class="bg-white rounded-xl shadow p-6 card-hover" id="resignRequestSection">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-file-signature ml-2"></i>
                        طلب استقالة
                    </h3>
                    <p class="text-gray-600 mb-4">تقديم طلب استقالة من العمل</p>
                    <button onclick="openModal('resignModal')" class="btn btn-danger w-full py-3">
                        <i class="fas fa-file-contract"></i>
                        تقديم طلب
                    </button>
                </div>
            </div>


            
            
            <!-- قسم سجلي -->
            <div class="employee-section">
                <div class="section-title">
                    <i class="fas fa-history text-blue-600"></i>
                    <span>سجلي وطلباتي</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-4 rounded-lg transition-colors">
                        <div class="flex items-center gap-3">
<div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-4 rounded-lg transition-colors">
                                <i class="fas fa-umbrella-beach text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">طلبات الإجازة</h4>
                                <p id="myLeaveCount" class="text-gray-500">0 طلب</p>
                            </div>
                        </div>
                    </div>
                    

                    
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-4 rounded-lg transition-colors">
                        <div class="flex items-center gap-3">
<div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-4 rounded-lg transition-colors">
                                <i class="fas fa-file-signature text-red-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">طلبات الاستقالة</h4>
                                <p id="myResignCount" class="text-gray-500">0 طلب</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- محتوى الطلبات -->
                <div id="myRequestsContent">
                    <!-- سيتم عرض الطلبات هنا -->
                </div>
            </div>
            
            <!-- سجل الحضور الأخير -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover" id="attendanceHistorySection">
                <h3 class="text-xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-history ml-2"></i>
                    سجل الحضور الأخير
                </h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>وقت الدخول</th>
                                <th>وقت الخروج</th>
                                <th>المدة</th>
                            </tr>
                        </thead>
                        <tbody id="userAttendanceTable">
                            <!-- سيتم ملؤها بالبيانات -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- قسم المشرفين -->
            <div id="supervisorSection" class="hidden">
                <div class="bg-white rounded-xl shadow-lg mb-6">
                    <div class="border-b">
                        <div class="flex overflow-x-auto">
                            <button onclick="showSupervisorTab('teamAttendance')" 
                                    class="tab-btn active px-6 py-3 whitespace-nowrap">
                                <i class="fas fa-users ml-2"></i>
                                حضور الفريق
                            </button>
                            <button onclick="showSupervisorTab('teamRequests')" 
                                    class="tab-btn px-6 py-3 whitespace-nowrap">
                                <i class="fas fa-file-alt ml-2"></i>
                                طلبات الفريق
                            </button>
                            <button onclick="showSupervisorTab('teamRanks')" 
                                    class="tab-btn px-6 py-3 whitespace-nowrap">
                                <i class="fas fa-user-tag ml-2"></i>
                                رتب الفريق
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div id="teamAttendanceTab" class="tab-content active">
                            <h4 class="text-lg font-bold mb-4">حضور فريق العمل</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>الموظف</th>
                                            <th>القسم</th>
                                            <th>الدخول</th>
                                            <th>الخروج</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamAttendanceTable">
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="teamRequestsTab" class="tab-content">
                            <h4 class="text-lg font-bold mb-4">طلبات فريق العمل</h4>
                            <div class="flex gap-2 mb-4">
                                <button onclick="filterTeamRequests('الاجازات')" class="btn btn-sm btn-info">الإجازات</button>
                                <button onclick="filterTeamRequests('الترقيات')" class="btn btn-sm btn-success">الترقيات</button>
                                <button onclick="filterTeamRequests('الاستقالات')" class="btn btn-sm btn-danger">الاستقالات</button>
                                <button onclick="filterTeamRequests('الكل')" class="btn btn-sm btn-secondary">الكل</button>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>الموظف</th>
                                            <th>نوع الطلب</th>
                                            <th>السبب</th>
                                            <th>التاريخ</th>
                                            <th>الحالة</th>
                                            <th>الإجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamRequestsTable">
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="teamRanksTab" class="tab-content">
                            <h4 class="text-lg font-bold mb-4">رتب فريق العمل</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>الموظف</th>
                                            <th>الرتبة الحالية</th>
                                            <th>تاريخ التعيين</th>
                                            <th>آخر ترقية</th>
                                            <th>الإجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamRanksTable">
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- لوحة المدير -->
    <div id="adminPanel" class="min-h-screen hidden">
        <!-- شريط التنقل -->
        <div class="bg-gradient-secondary text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">
                        <i class="fas fa-crown ml-2"></i>
                        لوحة تحكم المدير
                    </h1>
                    <p class="text-sm opacity-90" id="adminGreeting">مرحباً</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="adminCurrentTime" class="text-sm"></span>
                    <button onclick="showPage('userPage')" class="btn bg-white text-purple-600 text-sm" 
                            id="userViewBtn">
                        <i class="fas fa-user"></i>
                        لوحتي الشخصية
                    </button>
                    <button onclick="logout()" class="btn btn-danger text-sm">
                        <i class="fas fa-sign-out-alt"></i>
                        خروج
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto p-4">
            <!-- إحصائيات سريعة -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-icon text-blue-500">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number text-blue-600" id="adminTotalUsers">0</div>
                    <div class="stat-label">إجمالي الموظفين</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-yellow-500">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number text-yellow-600" id="adminActiveUsers">0</div>
                    <div class="stat-label">مسجلين الآن</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-green-500">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-number text-green-600" id="adminPendingRequests">0</div>
                    <div class="stat-label">طلبات معلقة</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-red-500">
                        <i class="fas fa-user-tag"></i>
                    </div>
                    <div class="stat-number text-red-600" id="adminRankChanges">0</div>
                    <div class="stat-label">طلبات ترقية</div>
                </div>
            </div>
            
            <!-- تبويبات التحكم -->
            <div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="border-b">
                    <div class="flex overflow-x-auto">
                        <button onclick="showAdminTab('users')" 
                                class="tab-btn active px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-users ml-2"></i>
                            الموظفين والصلاحيات
                        </button>
                        <button onclick="showAdminTab('roles')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-user-tag ml-2"></i>
                            إدارة الرتب
                        </button>
                        <button onclick="showAdminTab('attendance')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-history ml-2"></i>
                            سجلات الحضور
                        </button>
                        <button onclick="showAdminTab('requests')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-file-alt ml-2"></i>
                            طلبات الموظفين
                        </button>
                        <button onclick="showAdminTab('promotions')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-chart-line ml-2"></i>
                            الترقيات والتعيينات
                        </button>
                        <button onclick="showAdminTab('reports')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-chart-pie ml-2"></i>
                            تقارير الحضور
                        </button>
                    </div>
                </div>
                
                <!-- محتوى التبويبات -->
                <div class="p-6">
                    <!-- تبويب الموظفين -->
                    <div id="usersTab" class="tab-content active">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold">إدارة الموظفين والصلاحيات</h2>
                            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                <input type="text" id="searchUsers" placeholder="🔍 ابحث عن موظف..." 
                                       class="border rounded-lg p-2 flex-1 min-w-[200px]">
                                <button onclick="openModal('registerModal')" class="btn btn-success">
                                    <i class="fas fa-user-plus ml-2"></i>
                                    إضافة موظف
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>الدور</th>
                                        <th>الرتبة</th>
                                        <th>رقم الجوال</th>
                                        <th>الحالة</th>
                                        <th>الصلاحيات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUsersTable">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تبويب إدارة الرتب -->
                    <div id="rolesTab" class="tab-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold">إدارة الرتب والصلاحيات</h2>
                            <div class="flex gap-2">
                                <button onclick="openModal('addRoleModal')" class="btn btn-success">
                                    <i class="fas fa-plus ml-2"></i>
                                    إضافة رتبة جديدة
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4">الرتب الحالية في النظام</h3>
                                <div id="rolesList" class="space-y-3">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4" id="editingRoleTitle">تعديل صلاحيات الرتبة</h3>
                                <div class="input-group">
                                    <label>اسم الرتبة:</label>
                                    <input type="text" id="editRoleName" class="border rounded-lg p-2" disabled>
                                </div>
                                
                                <div class="permission-group mt-4">
                                    <h4 class="font-bold mb-3">الصلاحيات المتاحة:</h4>
                                    <div id="rolePermissionsList" class="space-y-2">
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </div>
                                </div>
                                
                                <div class="flex gap-2 mt-4">
                                    <button onclick="saveRolePermissions()" class="btn btn-primary flex-1" 
                                            id="saveRoleBtn">
                                        <i class="fas fa-save ml-2"></i>
                                        حفظ التعديلات
                                    </button>
                                    <button onclick="deleteRole()" class="btn btn-danger" id="deleteRoleBtn" 
                                            disabled>
                                        <i class="fas fa-trash ml-2"></i>
                                        حذف الرتبة
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- قسم تعيين الرتب للموظفين -->
                        <div class="bg-white rounded-xl shadow p-6 card-hover mt-6">
                            <h3 class="text-lg font-bold mb-4">تعيين الرتب للموظفين</h3>
                            <div class="input-group">
                                <label>اختر موظف:</label>
                                <select id="selectEmployee" class="border rounded-lg p-2" onchange="loadEmployeeCurrentRank()">
                                    <option value="">-- اختر موظف --</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>الرتبة الحالية:</label>
                                <input type="text" id="employeeCurrentRank" class="border rounded-lg p-2" disabled>
                            </div>
                            <div class="input-group">
                                <label>اختر الرتبة الجديدة:</label>
                                <select id="assignNewRank" class="border rounded-lg p-2">
                                    <option value="">-- اختر الرتبة --</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>سبب التغيير:</label>
                                <textarea id="rankChangeReason" rows="2" class="border rounded-lg p-2" placeholder="سبب تغيير الرتبة..."></textarea>
                            </div>
                            <button onclick="assignRankToEmployee()" class="btn btn-success w-full mt-2">
                                <i class="fas fa-user-tag ml-2"></i>
                                تعيين الرتبة
                            </button>
                        </div>
                    </div>
                    
                    <!-- تبويب سجلات الحضور -->
                    <div id="attendanceTab" class="tab-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold">سجلات الحضور والانصراف</h2>
                            <div class="flex gap-2 w-full md:w-auto">
                                <input type="text" id="searchAttendance" placeholder="🔍 ابحث في السجلات..." 
                                       class="border rounded-lg p-2 flex-1 min-w-[200px]">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>الموظف</th>
                                        <th>الرتبة</th>
                                        <th>التاريخ</th>
                                        <th>الدخول</th>
                                        <th>الخروج</th>
                                        <th>المدة</th>
                                        <th>تقرير الخروج</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="adminAttendanceTable">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تبويب طلبات الموظفين -->
                    <div id="requestsTab" class="tab-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold">طلبات الموظفين</h2>
                            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                <select id="filterRequestType" class="border rounded-lg p-2" 
                                        onchange="filterRequests()">
                                    <option value="">جميع الطلبات</option>
                                    <option value="إجازة">طلبات الإجازة</option>
                                    <option value="استقالة">طلبات الاستقالة</option>
                                </select>
                                <select id="filterRequestStatus" class="border rounded-lg p-2" 
                                        onchange="filterRequests()">
                                    <option value="">جميع الحالات</option>
                                    <option value="معلق">معلقة</option>
                                    <option value="مقبول">مقبولة</option>
                                    <option value="مرفوض">مرفوضة</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>الموظف</th>
                                        <th>الرتبة</th>
                                        <th>نوع الطلب</th>
                                        <th>السبب / التفاصيل</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="adminRequestsTable">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تبويب الترقيات والتعيينات -->
                    <div id="promotionsTab" class="tab-content">
                        <h2 class="text-xl font-bold mb-4">الترقيات والتعيينات</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4">طلبات الترقية المعلقة</h3>
                                <div id="pendingPromotionsList">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4">تعيين رتبة جديدة</h3>
                                <div class="input-group">
                                    <label>اختر موظف:</label>
                                    <select id="promotionEmployee" class="border rounded-lg p-2">
                                        <option value="">-- اختر موظف --</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>الرتبة الجديدة:</label>
                                    <select id="promotionNewRank" class="border rounded-lg p-2">
                                        <option value="">-- اختر الرتبة --</option>
                                        <option value="employee">موظف عادي</option>
                                        <option value="supervisor">مشرف</option>
                                        <option value="manager">مدير قسم</option>
                                        <option value="admin">مدير نظام</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>سبب الترقية:</label>
                                    <textarea id="promotionReason" rows="3" class="border rounded-lg p-2" placeholder="سبب الترقية..."></textarea>
                                </div>
                                <button onclick="promoteEmployee()" class="btn btn-success w-full mt-2">
                                    <i class="fas fa-chart-line ml-2"></i>
                                    تنفيذ الترقية
                                </button>
                            </div>
                        </div>


                        
                        
                        <div class="bg-white rounded-xl shadow p-6 card-hover">
                            <h3 class="text-lg font-bold mb-4">سجل الترقيات</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>الموظف</th>
                                            <th>الرتبة السابقة</th>
                                            <th>الرتبة الجديدة</th>
                                            <th>سبب التغيير</th>
                                            <th>التاريخ</th>
                                            <th>منفذ الترقية</th>
                                        </tr>
                                    </thead>
                                    <tbody id="promotionHistoryTable">
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    


                    <!-- تبويب تقارير الحضور -->
                    <div id="reportsTab" class="tab-content">
                        <h2 class="text-xl font-bold mb-4">تقارير وإحصائيات الحضور</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4">🏆 أفضل 5 موظفين (حسب ساعات العمل)</h3>
                                <div id="topEmployeesList">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4">📊 إحصائيات الرتب</h3>
                                <div id="rankStats">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow p-6 card-hover mb-6">
                            <h3 class="text-lg font-bold mb-4">📅 تقرير الحضور اليومي</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block mb-2">من تاريخ:</label>
                                    <input type="date" id="reportFromDate" class="border rounded-lg p-2 w-full">
                                </div>
                                <div>
                                    <label class="block mb-2">إلى تاريخ:</label>
                                    <input type="date" id="reportToDate" class="border rounded-lg p-2 w-full">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateAttendanceReport()" class="btn btn-primary w-full">
                                        <i class="fas fa-download ml-2"></i>
                                        إنشاء التقرير
                                    </button>
                                </div>
                            </div>
                            <div id="attendanceReportResult">
                                <!-- سيتم عرض التقرير هنا -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== النوافذ المنبثقة ===== -->
    
    <!-- نافذة إنشاء حساب جديد -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">إنشاء حساب جديد</h3>
            <form id="registerForm">
                <div class="input-group">
                    <label for="registerName" class="flex items-center gap-2">
                        <i class="fas fa-user text-blue-600"></i>
                        الاسم الكامل
                    </label>
                    <input type="text" id="registerName" placeholder="أدخل اسمك الكامل" required>
                </div>
                
                <div class="input-group">
                    <label for="registerPhone" class="flex items-center gap-2">
                        <i class="fas fa-phone text-blue-600"></i>
                        رقم الجوال
                    </label>
                    <input type="tel" id="registerPhone" placeholder="05xxxxxxxx" required
                           pattern="05[0-9]{8}">
                    <small class="text-gray-500 text-sm">يبدأ بـ 05 ويتكون من 10 أرقام</small>
                </div>
                
                <div class="permission-group">
                    <h4 class="font-bold mb-3">الصلاحيات الممنوحة:</h4>
                    <div id="permissionsPreview">
                        <!-- سيتم ملؤها تلقائياً -->
                    </div>
                </div>
                
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle"></i>
                    جميع الحسابات الجديدة تكون "موظف عادي". يمكن للمدير تعديل الصلاحيات لاحقاً.
                </div>
                
                <div class="input-group">
                    <label for="registerPassword" class="flex items-center gap-2">
                        <i class="fas fa-lock text-blue-600"></i>
                        كلمة المرور
                    </label>
                    <input type="password" id="registerPassword" placeholder="6 أحرف على الأقل" 
                           minlength="6" required>
                </div>
                
                <div class="input-group">
                    <label for="registerConfirmPassword" class="flex items-center gap-2">
                        <i class="fas fa-lock text-blue-600"></i>
                        تأكيد كلمة المرور
                    </label>
                    <input type="password" id="registerConfirmPassword" placeholder="أعد إدخال كلمة المرور" 
                           minlength="6" required>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-success flex-1">إنشاء الحساب</button>
                    <button type="button" onclick="closeModal('registerModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة رتبة جديدة -->
    <div id="addRoleModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">إضافة رتبة جديدة</h3>
            <form id="addRoleForm">
                <div class="input-group">
                    <label for="newRoleName" class="flex items-center gap-2">
                        <i class="fas fa-user-tag text-blue-600"></i>
                        اسم الرتبة
                    </label>
                    <input type="text" id="newRoleName" placeholder="مثال: مشرف تقني" required>
                </div>
                
                <div class="input-group">
                    <label for="newRoleKey" class="flex items-center gap-2">
                        <i class="fas fa-key text-blue-600"></i>
                        مفتاح الرتبة (بالإنجليزية)
                    </label>
                    <input type="text" id="newRoleKey" placeholder="مثال: tech_supervisor" required>
                    <small class="text-gray-500 text-sm">يجب أن يكون بالإنجليزية بدون مسافات</small>
                </div>
                
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle"></i>
                    يمكنك تعديل الصلاحيات بعد إنشاء الرتبة
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-success flex-1">إنشاء الرتبة</button>
                    <button type="button" onclick="closeModal('addRoleModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة تعديل الصلاحيات -->
    <div id="editPermissionsModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">إدارة صلاحيات الموظف</h3>
            <div class="mb-4">
                <p><strong>الموظف:</strong> <span id="editUserName" class="font-bold"></span></p>
                <p><strong>الدور الحالي:</strong> <span id="editUserRole" class="badge badge-info"></span></p>
            </div>
            
            <div class="permission-group">
                <h4 class="font-bold mb-3">الصلاحيات المتاحة:</h4>
                <div id="permissionsList">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="savePermissions()" class="btn btn-primary flex-1">حفظ التعديلات</button>
                <button onclick="closeModal('editPermissionsModal')" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة نسيت كلمة المرور -->
    <div id="forgotModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">استعادة كلمة المرور</h3>
            <form id="forgotForm">
                <div class="input-group">
                    <label for="forgotPhone" class="flex items-center gap-2">
                        <i class="fas fa-phone text-blue-600"></i>
                        رقم الجوال
                    </label>
                    <input type="tel" id="forgotPhone" placeholder="05xxxxxxxx" required>
                </div>
                
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle"></i>
                    سيتم إرسال كلمة المرور الحالية إلى رقم الجوال المسجل
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-warning flex-1">إرسال كلمة المرور</button>
                    <button type="button" onclick="closeModal('forgotModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة تسجيل الخروج من الحضور -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">تسجيل الخروج</h3>
            <form id="logoutForm">
                <div class="input-group">
                    <label class="flex items-center gap-2">
                        <i class="fas fa-file-alt text-blue-600"></i>
                        تقرير العمل اليومي
                    </label>
                    <textarea id="logoutReport" rows="4" placeholder="ماذا أنجزت اليوم؟" required></textarea>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-danger flex-1">تأكيد الخروج</button>
                    <button type="button" onclick="closeModal('logoutModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة طلب إجازة -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">طلب إجازة</h3>
            <form id="leaveForm">
                <div class="input-group">
                    <label class="flex items-center gap-2">
                        <i class="fas fa-sticky-note text-blue-600"></i>
                        سبب الإجازة
                    </label>
                    <textarea id="leaveReason" rows="3" required></textarea>
                </div>
                <div class="input-group">
                    <label class="flex items-center gap-2">
                        <i class="fas fa-clock text-blue-600"></i>
                        المدة
                    </label>
                    <input type="text" id="leaveDuration" placeholder="مثال: 3 أيام" required>
                </div>
                <div class="input-group">
                    <label class="flex items-center gap-2">
                        <i class="fas fa-calendar text-blue-600"></i>
                        تاريخ البدء
                    </label>
                    <input type="date" id="leaveStartDate" required>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-warning flex-1">إرسال الطلب</button>
                    <button type="button" onclick="closeModal('leaveModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    

    
    <!-- نافذة طلب استقالة -->
    <div id="resignModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">طلب استقالة</h3>
            <form id="resignForm">
                <div class="input-group">
                    <label class="flex items-center gap-2">
                        <i class="fas fa-sticky-note text-blue-600"></i>
                        سبب الاستقالة
                    </label>
                    <textarea id="resignReason" rows="4" required></textarea>
                </div>
                <div class="input-group">
                    <label class="flex items-center gap-2">
                        <i class="fas fa-calendar text-blue-600"></i>
                        تاريخ إنهاء العمل
                    </label>
                    <input type="date" id="resignEndDate" required>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-danger flex-1">إرسال الطلب</button>
                    <button type="button" onclick="closeModal('resignModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة تأكيد تسجيل الدخول -->
    <div id="confirmLoginModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">تأكيد تسجيل الدخول</h3>
            <p class="mb-6">هل أنت متأكد من تسجيل الدخول الآن؟</p>
            <div class="flex gap-2">
                <button onclick="confirmAttendanceLogin()" class="btn btn-success flex-1">
                    نعم، سجل دخول
                </button>
                <button onclick="closeModal('confirmLoginModal')" class="btn btn-secondary flex-1">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة معالجة الطلب -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">معالجة الطلب</h3>
            <p class="mb-4" id="processMessage"></p>
            <div class="input-group" id="processReasonField" style="display: none;">
                <label>سبب الرفض (اختياري):</label>
                <textarea id="rejectReason" rows="3" placeholder="اذكر سبب الرفض..."></textarea>
            </div>
            <div class="flex gap-2">
                <button onclick="processRequest('مقبول')" class="btn btn-success flex-1">✅ قبول</button>
                <button onclick="showRejectReason()" class="btn btn-danger flex-1">❌ رفض</button>
                <button onclick="closeModal('processModal')" class="btn btn-secondary flex-1">إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تفاصيل الطلب -->
    <div id="requestDetailsModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" id="requestDetailsTitle">تفاصيل الطلب</h3>
            <div id="requestDetailsContent">
                <!-- سيتم ملؤها بالبيانات -->
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="closeModal('requestDetailsModal')" class="btn btn-secondary flex-1">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تفاصيل تقرير الخروج -->
    <div id="reportDetailsModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">تقرير العمل اليومي</h3>
            <div class="report-box mb-4" id="reportDetailsContent">
                <!-- سيتم ملؤها بالبيانات -->
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal('reportDetailsModal')" class="btn btn-secondary flex-1">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تأكيد الحذف -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">تأكيد الحذف</h3>
            <p class="mb-6" id="deleteMessage"></p>
            <div class="flex gap-2">
                <button onclick="confirmDelete()" class="btn btn-danger flex-1">نعم، احذف</button>
                <button onclick="closeModal('deleteModal')" class="btn btn-secondary flex-1">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- سكربت النظام -->
    <script>
        // ===== المتغيرات العامة =====
        // ===== في بداية السكربت مع المتغيرات الأخرى =====
let currentUser = null;
let currentSession = null;
let users = [];
let sessions = [];
let requests = [];
let logs = [];
let promotions = [];
let userToDelete = null;
let requestToProcess = null;
let userToEditPermissions = null;
let editingPermissions = {};
let customRoles = {}; 
let currentEditingRole = null;  //


        
        // ===== تعريف الصلاحيات لكل دور =====
        
        // ===== تعريف أسماء الصلاحيات =====
        const permissionNames = {
            attendance: "تسجيل الحضور والانصراف",
            leave: "تقديم طلبات إجازة",
            resign: "تقديم طلبات استقالة",
            viewHistory: "عرض سجل الحضور الشخصي",
            viewStats: "عرض الإحصائيات الشخصية",
            viewTeamAttendance: "عرض حضور فريق العمل",
            viewTeamRequests: "عرض طلبات فريق العمل",
            addUsers: "إضافة موظفين جدد",
            editPermissions: "تعديل صلاحيات الموظفين",
            viewAllAttendance: "عرض جميع سجلات الحضور",
            processRequests: "معالجة طلبات الموظفين",
            viewReports: "عرض التقارير والإحصائيات",
            deleteUsers: "حذف الموظفين من النظام",
        };
        
        // ===== دوال إدارة التخزين =====
        function saveData() {
            localStorage.setItem('attendance_users', JSON.stringify(users));
            localStorage.setItem('attendance_sessions', JSON.stringify(sessions));
            localStorage.setItem('attendance_requests', JSON.stringify(requests));
            localStorage.setItem('attendance_logs', JSON.stringify(logs));
            localStorage.setItem('attendance_promotions', JSON.stringify(promotions));
        }
        
        function loadData() {
            try {
                users = JSON.parse(localStorage.getItem('attendance_users') || '[]');
                sessions = JSON.parse(localStorage.getItem('attendance_sessions') || '[]');
                requests = JSON.parse(localStorage.getItem('attendance_requests') || '[]');
                logs = JSON.parse(localStorage.getItem('attendance_logs') || '[]');
                promotions = JSON.parse(localStorage.getItem('attendance_promotions') || '[]');
                
                if (users.length === 0) {
                    createAdminOnly();
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                createAdminOnly();
            }
        }


        function getAllRoles() {
    try {
        // تأكد من وجود المتغيرات
        if (!customRoles) {
            customRoles = {};
        }
        
        // دمج الرتب الأساسية مع المخصصة
        const mergedRoles = {};
        
        // إضافة الرتب الأساسية
        for (const key in rolePermissions) {
            if (rolePermissions[key]) {
                mergedRoles[key] = { ...rolePermissions[key] };
            }
        }
        
        // إضافة الرتب المخصصة
        for (const key in customRoles) {
            if (customRoles[key]) {
                mergedRoles[key] = { ...customRoles[key] };
            }
        }
        
        return mergedRoles;
        
    } catch (error) {
        console.error("خطأ في getAllRoles:", error);
        return {
            employee: {
                name: "موظف عادي",
                badgeClass: "role-badge-employee",
                permissions: rolePermissions.employee.permissions
            }
        };
    }
}




        
        function createAdminOnly() {
            const adminUser = {
                id: 1,
                name: "المدير العام",
                phone: "0500000000",
                department: "الإدارة",
                password: "admin123",
                role: "admin",
                rank: "مدير نظام",
                rankHistory: [{
                    rank: "مدير نظام",
                    date: new Date().toISOString(),
                    reason: "تعيين أولي"
                }],
                permissions: rolePermissions.admin.permissions,
                createdAt: new Date().toISOString()
            };
            
            users = [adminUser];
            sessions = [];
            requests = [];
            logs = [];
            promotions = [];
            
            saveData();
        }
        
        // ===== دوال إدارة النوافذ =====
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function showAlert(message, type = 'error') {
            const alertElement = document.getElementById('mainAlert');
            alertElement.textContent = message;
            alertElement.className = 'alert';
            
            if (type === 'success') {
                alertElement.classList.add('alert-success');
            } else if (type === 'info') {
                alertElement.classList.add('alert-info');
            } else {
                alertElement.classList.add('alert-error');
            }
            
            alertElement.classList.remove('hidden');
            
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }
        
        function showLoading(show = true) {
            const loadingElement = document.getElementById('loading');
            if (show) {
                loadingElement.classList.add('active');
            } else {
                loadingElement.classList.remove('active');
            }
        }
        
        // ===== دوال إدارة الصفحات =====
        function showPage(pageId) {
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            
            if (pageId === 'userPage') {
                document.getElementById('userPanel').classList.remove('hidden');
                updateUserPanel();
            } else if (pageId === 'adminPage') {
                document.getElementById('adminPanel').classList.remove('hidden');
                updateAdminPanel();
            }
        }
        
        // ===== دوال تسجيل الدخول =====
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            login();
        });
        
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            register();
        });
        
        document.getElementById('forgotForm').addEventListener('submit', function(e) {
            e.preventDefault();
            forgotPassword();
        });
        
        function login() {
            showLoading(true);
            
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            setTimeout(() => {
                try {
                    const user = users.find(u => u.phone === phone && u.password === password);
                    
                    if (user) {
                        currentUser = user;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        
                        logs.push({
                            id: logs.length + 1,
                            userId: user.id,
                            username: user.name,
                            action: 'login',
                            timestamp: new Date().toISOString()
                        });
                        saveData();
                        
                        currentSession = sessions.find(s => s.userId === user.id && !s.logoutTime);
                        
                        document.getElementById('mainPage').classList.add('hidden');
                        
                        if (user.role === 'admin') {
                            document.getElementById('adminPanel').classList.remove('hidden');
                            updateAdminPanel();
                        } else {
                            document.getElementById('userPanel').classList.remove('hidden');
                            updateUserPanel();
                        }
                        
                        document.getElementById('loginPhone').value = '';
                        document.getElementById('loginPassword').value = '';
                        showToast('تم تسجيل الدخول بنجاح!', 'success');
                    } else {
                        showAlert('رقم الجوال أو كلمة المرور غير صحيحة', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في تسجيل الدخول:', error);
                    showAlert('حدث خطأ في تسجيل الدخول', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function register() {
            showLoading(true);
            
            const name = document.getElementById('registerName').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            setTimeout(() => {
                try {
                    if (!name || !phone || !password || !confirmPassword) {
                        showAlert('جميع الحقول مطلوبة', 'error');
                        return;
                    }
                    
                    if (phone.length !== 10 || !phone.startsWith('05')) {
                        showAlert('رقم الجوال يجب أن يبدأ بـ 05 ويتكون من 10 أرقام', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showAlert('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showAlert('كلمة المرور غير متطابقة', 'error');
                        return;
                    }
                    
                    const existingUser = users.find(u => u.phone === phone);
                    if (existingUser) {
                        showAlert('رقم الجوال مسجل مسبقاً', 'error');
                        return;
                    }
                    
                    const newUser = {
                        id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 2,
                        name: name,
                        phone: phone,
                        department: "غير محدد",
                        password: password,
                        role: "employee",
                        rank: "موظف عادي",
                        rankHistory: [{
                            rank: "موظف عادي",
                            date: new Date().toISOString(),
                            reason: "تعيين أولي"
                        }],
                        permissions: rolePermissions.employee.permissions,
                        createdAt: new Date().toISOString()
                    };
                    
                    users.push(newUser);
                    saveData();
                    
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerPhone').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerConfirmPassword').value = '';
                    
                    closeModal('registerModal');
                    showToast('تم إنشاء الحساب بنجاح!', 'success');
                    
                    if (currentUser && currentUser.role === 'admin') {
                        loadAdminUsersTable();
                        updateAdminStats();
                    }
                } catch (error) {
                    console.error('خطأ في إنشاء الحساب:', error);
                    showAlert('حدث خطأ في إنشاء الحساب', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function updatePermissionsForm() {
            const role = "employee";
            const permissions = rolePermissions[role];
            
            let html = `
                <div class="text-sm">
                    <p><strong>الدور:</strong> ${permissions.name}</p>
                    <p class="mt-2"><strong>الصلاحيات:</strong></p>
                    <ul class="list-disc pr-5 mt-1 text-gray-600">
            `;
            
            for (const key in permissions.permissions) {
                if (permissions.permissions[key]) {
                    html += `<li>${permissionNames[key]}</li>`;
                }
            }
            
            html += `</ul></div>`;
            document.getElementById('permissionsPreview').innerHTML = html;
        }



        
        function forgotPassword() {
            showLoading(true);
            
            const phone = document.getElementById('forgotPhone').value.trim();
            
            setTimeout(() => {
                try {
                    const user = users.find(u => u.phone === phone);
                    
                    if (user) {
                        closeModal('forgotModal');
                        document.getElementById('forgotPhone').value = '';
                        showAlert(`كلمة المرور لحساب ${user.name}: ${user.password}`, 'info');
                    } else {
                        showAlert('رقم الجوال غير مسجل في النظام', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في استعادة كلمة المرور:', error);
                    showAlert('حدث خطأ في استعادة كلمة المرور', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function logout() {
            if (confirm('هل تريد تسجيل الخروج من النظام؟')) {
                currentUser = null;
                currentSession = null;
                localStorage.removeItem('currentUser');
                document.getElementById('userPanel').classList.add('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('mainPage').classList.remove('hidden');
                showToast('تم تسجيل الخروج بنجاح', 'success');
            }
        }
        
        // ===== دوال إدارة الصلاحيات =====
        function checkPermission(permissionKey) {
            if (!currentUser || !currentUser.permissions) return false;
            return currentUser.permissions[permissionKey] === true;
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
const roleInfo = getRoleInfo(currentUser.role);
            document.getElementById('userRoleBadge').textContent = roleInfo.name;
            document.getElementById('userRoleBadge').className = `role-badge ${roleInfo.badgeClass}`;
            document.getElementById('userRoleDisplay').textContent = roleInfo.name;
            document.getElementById('userRoleDisplay').className = `role-badge ${roleInfo.badgeClass}`;
            
            // عرض الرتبة الحالية
            document.getElementById('userRankName').textContent = currentUser.rank || roleInfo.name;
            
            document.getElementById('attendanceSection').classList.toggle('hidden', !checkPermission('attendance'));
            document.getElementById('leaveRequestSection').classList.toggle('hidden', !checkPermission('leave'));
            document.getElementById('resignRequestSection').classList.toggle('hidden', !checkPermission('resign'));
            document.getElementById('attendanceHistorySection').classList.toggle('hidden', !checkPermission('viewHistory'));
            document.getElementById('userStatsSection').classList.toggle('hidden', !checkPermission('viewStats'));
            document.getElementById('supervisorSection').classList.toggle('hidden', !checkPermission('viewTeamAttendance'));
            document.getElementById('promotionRequestSection').classList.toggle('hidden', !checkPermission('requestPromotion'));
            
            if (document.getElementById('userViewBtn')) {
                document.getElementById('userViewBtn').classList.toggle('hidden', currentUser.role !== 'admin');
            }
            
            if (checkPermission('viewTeamAttendance') || checkPermission('viewTeamRequests')) {
                loadTeamData();
            }
            
            // تحديث عدادات الطلبات الشخصية
            updateMyRequestsCount();
        }
        
        function updateMyRequestsCount() {
            if (!currentUser) return;
            
            const myLeaves = requests.filter(r => r.userId === currentUser.id && r.type === 'إجازة').length;
            const myPromotions = promotions.filter(p => p.userId === currentUser.id).length;
            const myResigns = requests.filter(r => r.userId === currentUser.id && r.type === 'استقالة').length;
            
            document.getElementById('myLeaveCount').textContent = `${myLeaves} طلب`;
            document.getElementById('myPromotionCount').textContent = `${myPromotions} طلب`;
            document.getElementById('myResignCount').textContent = `${myResigns} طلب`;
        }
        
        function showMyRequests(type) {
            const content = document.getElementById('myRequestsContent');
            let html = '';
            
            if (type === 'الاجازات') {
                const myLeaves = requests.filter(r => r.userId === currentUser.id && r.type === 'إجازة')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                html = `<h4 class="font-bold mb-3">طلبات الإجازة:</h4>`;
                if (myLeaves.length === 0) {
                    html += '<p class="text-gray-500 text-center py-4">لا توجد طلبات إجازة</p>';
                } else {
                    myLeaves.forEach(request => {
                        const date = new Date(request.timestamp);
                        const statusBadge = request.status === 'معلق' ? 
                            '<span class="badge badge-warning">معلق</span>' : 
                            request.status === 'مقبول' ? 
                            '<span class="badge badge-success">مقبول</span>' : 
                            '<span class="badge badge-danger">مرفوض</span>';
                        
                        html += `
                        <div class="border-b py-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p><strong>التاريخ:</strong> ${date.toLocaleDateString('ar-SA')}</p>
                                    <p><strong>المدة:</strong> ${request.duration}</p>
                                    <p><strong>السبب:</strong> ${request.reason}</p>
                                </div>
                                <div>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
            }
            else if (type === 'الترقيات') {
                const myPromotions = promotions.filter(p => p.userId === currentUser.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                html = `<h4 class="font-bold mb-3">طلبات الترقية:</h4>`;
                if (myPromotions.length === 0) {
                    html += '<p class="text-gray-500 text-center py-4">لا توجد طلبات ترقية</p>';
                } else {
                    myPromotions.forEach(promo => {
                        const date = new Date(promo.date);
                        html += `
                        <div class="border-b py-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p><strong>التاريخ:</strong> ${date.toLocaleDateString('ar-SA')}</p>
                                    <p><strong>من:</strong> ${promo.fromRank || 'موظف عادي'}</p>
                                    <p><strong>إلى:</strong> ${promo.toRank}</p>
                                    <p><strong>السبب:</strong> ${promo.reason}</p>
                                </div>
                                <div>
                                    <span class="badge ${promo.status === 'مقبول' ? 'badge-success' : promo.status === 'معلق' ? 'badge-warning' : 'badge-danger'}">
                                        ${promo.status === 'مقبول' ? 'مقبول' : promo.status === 'معلق' ? 'معلق' : 'مرفوض'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
            }
            else if (type === 'الاستقالات') {
                const myResigns = requests.filter(r => r.userId === currentUser.id && r.type === 'استقالة')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                html = `<h4 class="font-bold mb-3">طلبات الاستقالة:</h4>`;
                if (myResigns.length === 0) {
                    html += '<p class="text-gray-500 text-center py-4">لا توجد طلبات استقالة</p>';
                } else {
                    myResigns.forEach(request => {
                        const date = new Date(request.timestamp);
                        const statusBadge = request.status === 'معلق' ? 
                            '<span class="badge badge-warning">معلق</span>' : 
                            request.status === 'مقبول' ? 
                            '<span class="badge badge-success">مقبول</span>' : 
                            '<span class="badge badge-danger">مرفوض</span>';
                        
                        html += `
                        <div class="border-b py-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p><strong>التاريخ:</strong> ${date.toLocaleDateString('ar-SA')}</p>
                                    <p><strong>تاريخ إنهاء العمل:</strong> ${request.endDate}</p>
                                    <p><strong>السبب:</strong> ${request.reason}</p>
                                </div>
                                <div>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
            }
            
            content.innerHTML = html;
        }
        
        function openEditPermissions(userId) {
            try {
                userId = parseInt(userId);
                
                const user = users.find(u => u.id === userId);
                
                if (!user) {
                    alert('المستخدم غير موجود');
                    return;
                }
                
                userToEditPermissions = userId;
                document.getElementById('editUserName').textContent = user.name;
                
                const roleInfo = rolePermissions[user.role] || rolePermissions.employee;
                document.getElementById('editUserRole').textContent = roleInfo.name;
                document.getElementById('editUserRole').className = `badge badge-info`;
                
                editingPermissions = {...user.permissions};
                
                let html = '';
                
                for (const key in permissionNames) {
                    const hasPermission = editingPermissions[key] === true;
                    const permissionName = permissionNames[key];
                    
                    html += `
                    <div class="permission-item">
                        <div class="permission-label">
                            ${permissionName}
                        </div>
                        <div class="permission-buttons">
                            <button onclick="togglePermission('${key}')" 
                                    class="btn btn-success btn-sm ${hasPermission ? 'hidden' : ''}" id="addBtn_${key}">
                                <i class="fas fa-plus"></i> إضافة
                            </button>
                            <button onclick="togglePermission('${key}')" 
                                    class="btn btn-danger btn-sm ${!hasPermission ? 'hidden' : ''}" id="removeBtn_${key}">
                                <i class="fas fa-minus"></i> إزالة
                            </button>
                        </div>
                    </div>
                    `;
                }
                
                document.getElementById('permissionsList').innerHTML = html;
                openModal('editPermissionsModal');
            } catch (error) {
                console.error('خطأ في فتح تعديل الصلاحيات:', error);
                alert('حدث خطأ في فتح صفحة تعديل الصلاحيات');
            }
        }
        
        function togglePermission(permissionKey) {
            try {
                editingPermissions[permissionKey] = !editingPermissions[permissionKey];
                
                const addBtn = document.getElementById(`addBtn_${permissionKey}`);
                const removeBtn = document.getElementById(`removeBtn_${permissionKey}`);
                
                if (editingPermissions[permissionKey]) {
                    addBtn.classList.add('hidden');
                    removeBtn.classList.remove('hidden');
                } else {
                    removeBtn.classList.add('hidden');
                    addBtn.classList.remove('hidden');
                }
            } catch (error) {
                console.error('خطأ في تبديل الصلاحية:', error);
            }
        }
        
        function savePermissions() {
            if (!userToEditPermissions) return;
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    const userIndex = users.findIndex(u => u.id === userToEditPermissions);
                    if (userIndex !== -1) {
                        users[userIndex].permissions = editingPermissions;
                        
                        let newRole = 'employee';
                        
                        if (editingPermissions.addUsers && editingPermissions.editPermissions && 
                            editingPermissions.processRequests && editingPermissions.viewReports) {
                            newRole = 'admin';
                        } else if (editingPermissions.processRequests && editingPermissions.viewReports) {
                            newRole = 'manager';
                        } else if (editingPermissions.viewTeamAttendance && editingPermissions.viewTeamRequests) {
                            newRole = 'supervisor';
                        }
                        
                        users[userIndex].role = newRole;
                        
                        saveData();
                        
                        if (currentUser && currentUser.id === userToEditPermissions) {
                            currentUser = users[userIndex];
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            updateUserInterface();
                        }
                        
                        loadAdminUsersTable();
                        
                        closeModal('editPermissionsModal');
                        showToast('تم تحديث صلاحيات الموظف بنجاح!', 'success');
                    }
                } catch (error) {
                    console.error('خطأ في حفظ الصلاحيات:', error);
                    showAlert('حدث خطأ في حفظ الصلاحيات', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        // ===== دوال إدارة الحضور =====
        function attendanceLogin() {
            if (currentSession) {
                alert('أنت مسجل دخول بالفعل!');
                return;
            }
            
            if (!checkPermission('attendance')) {
                alert('ليس لديك صلاحية لتسجيل الحضور');
                return;
            }
            
            openModal('confirmLoginModal');
        }
        
        function confirmAttendanceLogin() {
            showLoading(true);
            
            setTimeout(() => {
                try {
                    const newSession = {
                        id: sessions.length > 0 ? Math.max(...sessions.map(s => s.id)) + 1 : 1,
                        userId: currentUser.id,
                        loginTime: new Date().toISOString(),
                        logoutTime: null,
                        totalMinutes: 0,
                        report: ''
                    };
                    
                    sessions.push(newSession);
                    currentSession = newSession;
                    saveData();
                    
                    updateUserPanel();
                    
                    closeModal('confirmLoginModal');
                    showToast('تم تسجيل الدخول بنجاح!', 'success');
                } catch (error) {
                    console.error('خطأ في تسجيل الدخول للحضور:', error);
                    showAlert('حدث خطأ في تسجيل الدخول', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        document.getElementById('logoutForm').addEventListener('submit', function(e) {
            e.preventDefault();
            attendanceLogout();
        });
        
        function attendanceLogout() {
            showLoading(true);
            
            const report = document.getElementById('logoutReport').value.trim();
            
            setTimeout(() => {
                try {
                    if (!report) {
                        alert('يرجى كتابة تقرير العمل اليومي');
                        return;
                    }
                    
                    const loginTime = new Date(currentSession.loginTime);
                    const logoutTime = new Date();
                    const duration = Math.floor((logoutTime - loginTime) / 60000);
                    
                    const sessionIndex = sessions.findIndex(s => s.id === currentSession.id);
                    if (sessionIndex !== -1) {
                        sessions[sessionIndex].logoutTime = logoutTime.toISOString();
                        sessions[sessionIndex].totalMinutes = duration;
                        sessions[sessionIndex].report = report;
                    }
                    
                    logs.push({
                        id: logs.length + 1,
                        userId: currentUser.id,
                        username: currentUser.name,
                        action: 'logout',
                        timestamp: new Date().toISOString(),
                        report: report,
                        duration: duration
                    });
                    
                    saveData();
                    
                    currentSession = null;
                    updateUserPanel();
                    
                    closeModal('logoutModal');
                    document.getElementById('logoutReport').value = '';
                    showToast('تم تسجيل الخروج بنجاح!', 'success');
                } catch (error) {
                    console.error('خطأ في تسجيل الخروج:', error);
                    showAlert('حدث خطأ في تسجيل الخروج', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        // ===== دوال إدارة الطلبات =====
        document.getElementById('leaveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitLeaveRequest();
        });
        
        function submitLeaveRequest() {
            if (!checkPermission('leave')) {
                alert('ليس لديك صلاحية لتقديم طلبات إجازة');
                return;
            }
            
            showLoading(true);
            
            const reason = document.getElementById('leaveReason').value.trim();
            const duration = document.getElementById('leaveDuration').value.trim();
            const startDate = document.getElementById('leaveStartDate').value;
            
            setTimeout(() => {
                try {
                    if (!reason || !duration || !startDate) {
                        alert('يرجى ملء جميع الحقول');
                        return;
                    }
                    
                    const newRequest = {
                        id: requests.length > 0 ? Math.max(...requests.map(r => r.id)) + 1 : 1,
                        userId: currentUser.id,
                        username: currentUser.name,
                        department: currentUser.department,
                        type: 'إجازة',
                        reason: reason,
                        duration: duration,
                        startDate: startDate,
                        status: 'معلق',
                        timestamp: new Date().toISOString()
                    };
                    
                    requests.push(newRequest);
                    saveData();
                    
                    closeModal('leaveModal');
                    
                    document.getElementById('leaveReason').value = '';
                    document.getElementById('leaveDuration').value = '';
                    
                    showToast('تم تقديم طلب الإجازة بنجاح!', 'success');
                    
                    updateMyRequestsCount();
                    
                    if (currentUser && currentUser.role === 'admin') {
                        updateAdminStats();
                        loadAdminRequestsTable();
                    }
                } catch (error) {
                    console.error('خطأ في تقديم طلب الإجازة:', error);
                    showAlert('حدث خطأ في تقديم طلب الإجازة', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        document.getElementById('promotionForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            submitPromotionRequest();
        });
        
        function openPromotionModal() {
            if (!currentUser) return;
            
            document.getElementById('currentRank').value = currentUser.rank || 'موظف عادي';
            openModal('promotionModal');
        }
        
        function submitPromotionRequest() {
            if (!checkPermission('requestPromotion')) {
                return;
            }
            
            showLoading(true);
            
            const requestedRank = document.getElementById('requestedRank').value;
            const reason = document.getElementById('promotionRequestReason').value.trim();
            
            setTimeout(() => {
                try {
                    if (!requestedRank || !reason) {
                        alert('يرجى ملء جميع الحقول');
                        return;
                    }
                    
                    const promotion = {
                        id: promotions.length > 0 ? Math.max(...promotions.map(p => p.id)) + 1 : 1,
                        userId: currentUser.id,
                        username: currentUser.name,
                        fromRank: currentUser.rank,
                        toRank: rolePermissions[requestedRank].name,
                        reason: reason,
                        status: 'معلق',
                        date: new Date().toISOString()
                    };
                    
                    promotions.push(promotion);
                    saveData();
                    
                    closeModal('promotionModal');
                    
                    document.getElementById('promotionRequestReason').value = '';
                    
                    showToast('تم تقديم طلب الترقية بنجاح!', 'success');
                    
                    updateMyRequestsCount();
                    
                    if (currentUser && currentUser.role === 'admin') {
                        updateAdminStats();
                        loadPromotionHistory();
                    }
                } catch (error) {
                    console.error('خطأ في تقديم طلب الترقية:', error);
                    showAlert('حدث خطأ في تقديم طلب الترقية', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        

// ===== في بداية السكربت مع المتغيرات الأخرى =====

// ===== تعريف الرتب الأساسية =====
// ===== تعريف الرتب الأساسية =====

// ===== أسماء الصلاحيات =====
// ===== أسماء الصلاحيات =====


// ===== المتغيرات الجديدة =====



function getAllRoles() {
    try {
        // تأكد من وجود customRoles
        if (!customRoles) {
            customRoles = {};
            console.warn("customRoles غير معرف، تم تهيئته ككائن فارغ");
        }
        
        // دمج rolePermissions مع customRoles
        const mergedRoles = { ...rolePermissions, ...customRoles };
        console.log("تم دمج الرتب:", Object.keys(mergedRoles));
        return mergedRoles;
    } catch (error) {
        console.error("خطأ في getAllRoles:", error);
        return { employee: { name: "موظف عادي", permissions: {} } };
    }
}


function editRole(roleKey) {
    try {
        console.log("=== بدء تحرير الرتبة ===");
        console.log("مفتاح الرتبة المطلوب:", roleKey);
        
        // تنظيف مفتاح الرتبة (إزالة علامات التنصيص الإضافية)
        roleKey = roleKey.replace(/['"]/g, '');
        console.log("مفتاح الرتبة بعد التنظيف:", roleKey);
        
        currentEditingRole = roleKey;
        const allRoles = getAllRoles();
        
        console.log("جميع الرتب المتاحة:", Object.keys(allRoles));
        console.log("الرتبة المطلوبة:", allRoles[roleKey]);
        
        const role = allRoles[roleKey];
        
        if (!role) {
            console.error(`الرتبة ${roleKey} غير موجودة`);
            alert(`الرتبة ${roleKey} غير موجودة`);
            return;
        }
        
        // تحديث واجهة التعديل
        document.getElementById('editRoleName').value = role.name;
        document.getElementById('editingRoleTitle').textContent = `تعديل صلاحيات: ${role.name}`;
        
        let permissionsHtml = '';
        for (const key in permissionNames) {
            const hasPermission = role.permissions ? (role.permissions[key] === true) : false;
            permissionsHtml += `
                <div class="flex items-center justify-between p-2 border-b border-gray-200">
                    <span>${permissionNames[key]}</span>
                    <input type="checkbox" 
                           id="perm_${key}" 
                           ${hasPermission ? 'checked' : ''}
                           class="w-5 h-5 rounded text-blue-600">
                </div>
            `;
        }
        
        document.getElementById('rolePermissionsList').innerHTML = permissionsHtml;
        
        // تحديث زر الحذف
        const deleteBtn = document.getElementById('deleteRoleBtn');
        if (deleteBtn) {
            const isCustomRole = customRoles && customRoles[roleKey];
            deleteBtn.disabled = !isCustomRole;
            deleteBtn.title = isCustomRole ? "حذف الرتبة المخصصة" : "لا يمكن حذف الرتبة الأساسية";
        }
        
        // تحديث قائمة الرتب
        document.querySelectorAll('#rolesList .role-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        const selectedItem = document.querySelector(`[onclick*="${roleKey}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
        } else {
            console.warn("لم يتم العثور على العنصر المحدد:", roleKey);
        }
        
    } catch (error) {
        console.error('خطأ في editRole:', error);
        alert('حدث خطأ في تحميل الرتبة');
    }
}


function saveRolePermissions() {
    if (!currentEditingRole) return;
    
    const roleKey = currentEditingRole;
    const allRoles = getAllRoles();
    const role = allRoles[roleKey];
    
    if (!role) {
        alert('الرتبة غير موجودة');
        return;
    }
    
    // تحديث الصلاحيات في الكائن المناسب
    for (const key in permissionNames) {
        const checkbox = document.getElementById(`perm_${key}`);
        role.permissions[key] = checkbox.checked;
    }
    
    // حفظ التغييرات في المكان المناسب
    if (rolePermissions[roleKey]) {
        // إذا كانت رتبة أساسية، تحديث rolePermissions
        rolePermissions[roleKey].permissions = { ...role.permissions };
    } else if (customRoles[roleKey]) {
        // إذا كانت رتبة مخصصة، تحديث customRoles
        customRoles[roleKey].permissions = { ...role.permissions };
    }
    
    // تحديث جميع المستخدمين الذين لديهم هذه الرتبة
    users.forEach(user => {
        if (user.role === roleKey) {
            user.permissions = { ...role.permissions };
        }
    });
    
    saveData();
    
    // إذا كان المستخدم الحالي من نفس الرتبة، تحديث صلاحياته
    if (currentUser && currentUser.role === roleKey) {
        currentUser.permissions = { ...role.permissions };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateUserInterface();
    }
    
    showToast('تم تحديث صلاحيات الرتبة بنجاح!', 'success');
}





// ===== تعريف الرتب الأساسية =====
const rolePermissions = {
    employee: {
        name: "موظف عادي",
        badgeClass: "role-badge-employee",
        permissions: {
            attendance: true,
            leave: true,
            resign: true,
            viewHistory: true,
            viewStats: true,
            viewTeamAttendance: false,
            viewTeamRequests: false,
            addUsers: false,
            editPermissions: false,
            viewAllAttendance: false,
            processRequests: false,
            viewReports: false,
            deleteUsers: false,
            requestPromotion: true
        }
    },
    supervisor: {
        name: "مشرف",
        badgeClass: "role-badge-manager",
        permissions: {
            attendance: true,
            leave: true,
            resign: true,
            viewHistory: true,
            viewStats: true,
            viewTeamAttendance: true,
            viewTeamRequests: true,
            addUsers: false,
            editPermissions: false,
            viewAllAttendance: false,
            processRequests: false,
            viewReports: false,
            deleteUsers: false,
            requestPromotion: true
        }
    },
    manager: {
        name: "مدير قسم",
        badgeClass: "role-badge-manager",
        permissions: {
            attendance: true,
            leave: true,
            resign: true,
            viewHistory: true,
            viewStats: true,
            viewTeamAttendance: true,
            viewTeamRequests: true,
            addUsers: true,
            editPermissions: true,
            viewAllAttendance: true,
            processRequests: true,
            viewReports: true,
            deleteUsers: false,
            requestPromotion: true
        }
    },
    admin: {
        name: "مدير نظام",
        badgeClass: "role-badge-admin",
        permissions: {
            attendance: true,
            leave: true,
            resign: true,
            viewHistory: true,
            viewStats: true,
            viewTeamAttendance: true,
            viewTeamRequests: true,
            addUsers: true,
            editPermissions: true,
            viewAllAttendance: true,
            processRequests: true,
            viewReports: true,
            deleteUsers: true,
            requestPromotion: false
        }
    }
};






        
        document.getElementById('resignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitResignRequest();
        });
        
        function submitResignRequest() {
            if (!checkPermission('resign')) {
                alert('ليس لديك صلاحية لتقديم طلبات استقالة');
                return;
            }
            
            showLoading(true);
            
            const reason = document.getElementById('resignReason').value.trim();
            const endDate = document.getElementById('resignEndDate').value;
            
            setTimeout(() => {
                try {
                    if (!reason || !endDate) {
                        alert('يرجى ملء جميع الحقول');
                        return;
                    }
                    
                    const newRequest = {
                        id: requests.length > 0 ? Math.max(...requests.map(r => r.id)) + 1 : 1,
                        userId: currentUser.id,
                        username: currentUser.name,
                        department: currentUser.department,
                        type: 'استقالة',
                        reason: reason,
                        endDate: endDate,
                        status: 'معلق',
                        timestamp: new Date().toISOString()
                    };
                    
                    requests.push(newRequest);
                    saveData();
                    
                    closeModal('resignModal');
                    
                    document.getElementById('resignReason').value = '';
                    
                    showToast('تم تقديم طلب الاستقالة بنجاح!', 'success');
                    
                    updateMyRequestsCount();
                    
                    if (currentUser && currentUser.role === 'admin') {
                        updateAdminStats();
                        loadAdminRequestsTable();
                    }
                } catch (error) {
                    console.error('خطأ في تقديم طلب الاستقالة:', error);
                    showAlert('حدث خطأ في تقديم طلب الاستقالة', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        // ===== دوال تحديث واجهة المستخدم =====
        function updateUserPanel() {
            if (!currentUser) return;
            
            document.getElementById('userGreeting').textContent = `مرحباً ${currentUser.name}`;
            document.getElementById('userDisplayName').textContent = currentUser.name;
            document.getElementById('userDisplayDepartment').textContent = currentUser.department;
            document.getElementById('userDisplayPhone').textContent = currentUser.phone;
            
            const statusIcon = document.getElementById('userStatusIcon');
            const statusText = document.getElementById('userStatusText');
            const loginBtn = document.getElementById('attendanceLoginBtn');
            const logoutBtn = document.getElementById('attendanceLogoutBtn');
            
            if (currentSession) {
                statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                statusText.textContent = 'مسجل دخول';
                statusText.className = 'badge badge-success';
                loginBtn.disabled = true;
                logoutBtn.disabled = false;
            } else {
                statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                statusText.textContent = 'غير مسجل';
                statusText.className = 'badge badge-danger';
                loginBtn.disabled = false;
                logoutBtn.disabled = true;
            }
            
            updateUserInterface();
            updateUserStats();
            updateUserAttendanceTable();
            updateCurrentTime();
        }
        
        function updateUserStats() {
            try {
                const userSessions = sessions.filter(s => s.userId === currentUser.id && s.logoutTime);
                
                const uniqueDays = new Set(userSessions.map(s => s.loginTime.split('T')[0])).size;
                const totalMinutes = userSessions.reduce((sum, session) => sum + (session.totalMinutes || 0), 0);
                const totalHours = (totalMinutes / 60).toFixed(1);
                const avgHours = uniqueDays > 0 ? (totalMinutes / uniqueDays / 60).toFixed(1) : 0;
                
                document.getElementById('userDays').textContent = uniqueDays;
                document.getElementById('userHours').textContent = totalHours;
                document.getElementById('userAvg').textContent = avgHours;
            } catch (error) {
                console.error('خطأ في تحديث إحصائيات المستخدم:', error);
            }
        }
        
        function updateUserAttendanceTable() {
            try {
                const table = document.getElementById('userAttendanceTable');
                const userSessions = sessions
                    .filter(s => s.userId === currentUser.id && s.logoutTime)
                    .sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime))
                    .slice(0, 10);
                
                let html = '';
                
                if (userSessions.length === 0) {
                    html = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>لا توجد سجلات حضور سابقة</p>
                        </td>
                    </tr>
                    `;
                } else {
                    userSessions.forEach(session => {
                        const loginDate = new Date(session.loginTime);
                        const logoutDate = new Date(session.logoutTime);
                        
                        const dateStr = loginDate.toLocaleDateString('ar-SA');
                        const loginTimeStr = loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                        const logoutTimeStr = logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                        const durationStr = session.totalMinutes ? `${Math.floor(session.totalMinutes / 60)}:${(session.totalMinutes % 60).toString().padStart(2, '0')}` : '-';
                        
                        html += `
                        <tr>
                            <td>${dateStr}</td>
                            <td>${loginTimeStr}</td>
                            <td>${logoutTimeStr}</td>
                            <td>${durationStr}</td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحديث جدول الحضور:', error);
                document.getElementById('userAttendanceTable').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-red-500 py-4">
                            خطأ في تحميل سجلات الحضور
                        </td>
                    </tr>
                `;
            }
        }
        
        function loadTeamData() {
            try {
                const teamAttendanceTable = document.getElementById('teamAttendanceTable');
                let attendanceHtml = '';
                
                const teamMembers = users.filter(u => 
                    u.department === currentUser.department && 
                    u.id !== currentUser.id
                );
                
                if (teamMembers.length === 0) {
                    attendanceHtml = `
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-4">
                            لا يوجد موظفين في فريقك
                        </td>
                    </tr>
                    `;
                } else {
                    teamMembers.forEach(member => {
                        const activeSession = sessions.find(s => s.userId === member.id && !s.logoutTime);
                        const lastSession = sessions
                            .filter(s => s.userId === member.id && s.logoutTime)
                            .sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime))[0];
                        
                        let status = '<span class="badge badge-secondary">غير مسجل</span>';
                        let loginTime = '-';
                        let logoutTime = '-';
                        
                        if (activeSession) {
                            const loginDate = new Date(activeSession.loginTime);
                            loginTime = loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                            status = '<span class="badge badge-success">مسجل دخول</span>';
                        } else if (lastSession) {
                            const loginDate = new Date(lastSession.loginTime);
                            const logoutDate = new Date(lastSession.logoutTime);
                            loginTime = loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                            logoutTime = logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                            status = '<span class="badge badge-secondary">مسجل خروج</span>';
                        }
                        
                        attendanceHtml += `
                        <tr>
                            <td>${member.name}</td>
                            <td>${member.department}</td>
                            <td>${loginTime}</td>
                            <td>${logoutTime}</td>
                            <td>${status}</td>
                        </tr>
                        `;
                    });
                }
                
                teamAttendanceTable.innerHTML = attendanceHtml;
                
                const teamRequestsTable = document.getElementById('teamRequestsTable');
                let requestsHtml = '';
                
                const teamRequests = requests.filter(r => 
                    teamMembers.some(m => m.id === r.userId) &&
                    r.status === 'معلق'
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (teamRequests.length === 0) {
                    requestsHtml = `
                    <tr>
                        <td colspan="6" class="text-center text-gray-500 py-4">
                            لا توجد طلبات معلقة في فريقك
                        </td>
                    </tr>
                    `;
                } else {
                    teamRequests.forEach(request => {
                        const date = new Date(request.timestamp);
                        const dateStr = date.toLocaleDateString('ar-SA');
                        const reasonShort = request.reason.length > 30 ? request.reason.substring(0, 30) + '...' : request.reason;
                        
                        let actionBtn = `<button onclick="viewRequestDetails(${request.id})" class="btn btn-sm btn-primary">عرض</button>`;
                        if (checkPermission('processRequests')) {
                            actionBtn += ` <button onclick="processUserRequest(${request.id})" class="btn btn-sm btn-warning">معالجة</button>`;
                        }
                        
                        requestsHtml += `
                        <tr>
                            <td>${request.username}</td>
                            <td>${request.type}</td>
                            <td title="${request.reason}">${reasonShort}</td>
                            <td>${dateStr}</td>
                            <td><span class="badge badge-warning">${request.status}</span></td>
                            <td>${actionBtn}</td>
                        </tr>
                        `;
                    });
                }
                
                teamRequestsTable.innerHTML = requestsHtml;
                
                const teamRanksTable = document.getElementById('teamRanksTable');
                let ranksHtml = '';
                
                if (teamMembers.length === 0) {
                    ranksHtml = `
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-4">
                            لا يوجد موظفين في فريقك
                        </td>
                    </tr>
                    `;
                } else {
                    teamMembers.forEach(member => {
                        const lastPromotion = member.rankHistory ? 
                            member.rankHistory[member.rankHistory.length - 1] : null;
                        
                        ranksHtml += `
                        <tr>
                            <td>${member.name}</td>
                            <td>${member.rank}</td>
                            <td>${new Date(member.createdAt).toLocaleDateString('ar-SA')}</td>
                            <td>${lastPromotion ? new Date(lastPromotion.date).toLocaleDateString('ar-SA') : 'لا يوجد'}</td>
                            <td>
                                <button onclick="viewRankHistory(${member.id})" class="btn btn-sm btn-info">سجل الرتب</button>
                            </td>
                        </tr>
                        `;
                    });
                }

 
                teamRanksTable.innerHTML = ranksHtml;
            } catch (error) {
                console.error('خطأ في تحميل بيانات الفريق:', error);
            }
        }
        


        
        function viewRankHistory(userId) {
            try {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                let html = `
                    <h4 class="font-bold mb-2">سجل الرتب للموظف: ${user.name}</h4>
                    <div class="space-y-3">
                `;
                
                if (user.rankHistory && user.rankHistory.length > 0) {
                    user.rankHistory.forEach((record, index) => {
                        const date = new Date(record.date);
                        html += `
                        <div class="promotion-history">
                            <p><strong>الرتبة:</strong> ${record.rank}</p>
                            <p><strong>التاريخ:</strong> ${date.toLocaleDateString('ar-SA')}</p>
                            <p><strong>السبب:</strong> ${record.reason}</p>
                        </div>
                        `;
                    });
                } else {
                    html += `<p class="text-gray-500">لا يوجد سجل للرتب</p>`;
                }
                
                html += `</div>`;
                
                document.getElementById('requestDetailsTitle').textContent = `سجل الرتب: ${user.name}`;
                document.getElementById('requestDetailsContent').innerHTML = html;
                openModal('requestDetailsModal');
            } catch (error) {
                console.error('خطأ في عرض سجل الرتب:', error);
            }
        }
        
        function filterTeamRequests(type) {
            try {
                const rows = document.querySelectorAll('#teamRequestsTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 6) return;
                    
                    const requestType = row.cells[1].textContent;
                    
                    if (type === 'الكل' || 
                        (type === 'الاجازات' && requestType === 'إجازة') ||
                        (type === 'الترقيات' && requestType === 'ترقية') ||
                        (type === 'الاستقالات' && requestType === 'استقالة')) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('خطأ في تصفية طلبات الفريق:', error);
            }
        }

        
        
        function showSupervisorTab(tabId) {
            try {
                document.querySelectorAll('#supervisorSection .tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('#supervisorSection .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(tabId + 'Tab').classList.add('active');
                event.target.classList.add('active');
                
                if (tabId === 'teamRequests') {
                    filterTeamRequests('الكل');
                }
            } catch (error) {
                console.error('خطأ في تبديل تبويبات المشرف:', error);
            }
        }
        
        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateStr = now.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                if (document.getElementById('currentTime')) {
                    document.getElementById('currentTime').textContent = `${dateStr} - ${timeStr}`;
                }
                if (document.getElementById('adminCurrentTime')) {
                    document.getElementById('adminCurrentTime').textContent = `${dateStr} - ${timeStr}`;
                }
            } catch (error) {
                console.error('خطأ في تحديث الوقت:', error);
            }
        }
        
        // ===== دوال لوحة المدير =====
        function updateAdminPanel() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            document.getElementById('adminGreeting').textContent = `مرحباً ${currentUser.name}`;
            
            updateAdminStats();
            loadAdminUsersTable();
            loadAdminAttendanceTable();
            loadAdminRequestsTable();
            loadReports();
            loadPromotionHistory();
            loadEmployeeSelect();
            loadRankSelect();
        }
        
        function updateAdminStats() {
            try {
                const totalUsers = users.filter(u => u.id !== currentUser?.id).length;
                const activeUsers = sessions.filter(s => !s.logoutTime).length;
                const pendingRequests = requests.filter(r => r.status === 'معلق').length;
                const rankChangeRequests = promotions.filter(p => p.status === 'معلق').length;
                
                document.getElementById('adminTotalUsers').textContent = totalUsers;
                document.getElementById('adminActiveUsers').textContent = activeUsers;
                document.getElementById('adminPendingRequests').textContent = pendingRequests;
                document.getElementById('adminRankChanges').textContent = rankChangeRequests;
            } catch (error) {
                console.error('خطأ في تحديث إحصائيات المدير:', error);
            }
        }
        
        function showAdminTab(tabId) {
            try {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(tabId + 'Tab').classList.add('active');
                event.target.classList.add('active');
                
                if (tabId === 'users') {
                    loadAdminUsersTable();
                } else if (tabId === 'roles') {
                    loadRolesList();
                } else if (tabId === 'attendance') {
                    loadAdminAttendanceTable();
                } else if (tabId === 'requests') {
                    loadAdminRequestsTable();
                } else if (tabId === 'promotions') {
                    loadPromotionHistory();
                } else if (tabId === 'reports') {
                    loadReports();
                }
            } catch (error) {
                console.error('خطأ في تبديل تبويبات المدير:', error);
            }
        }
        
        function loadAdminUsersTable() {
            try {
                const table = document.getElementById('adminUsersTable');
                const searchTerm = document.getElementById('searchUsers')?.value.toLowerCase() || '';
                
                let filteredUsers = users;
                
                if (searchTerm) {
                    filteredUsers = filteredUsers.filter(user => 
                        user.name.toLowerCase().includes(searchTerm) ||
                        user.phone.includes(searchTerm) ||
                        (user.department && user.department.toLowerCase().includes(searchTerm)) ||
                        (user.role && user.role.toLowerCase().includes(searchTerm))
                    );
                }
                
                let html = '';
                
                if (filteredUsers.length === 0) {
                    html = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>لا يوجد موظفين مسجلين</p>
                            <p class="text-sm text-gray-500">${searchTerm ? 'لم يتم العثور على نتائج للبحث' : 'قم بإضافة أول موظف'}</p>
                            ${!searchTerm ? `
                            <button onclick="openModal('registerModal')" class="btn btn-success mt-2">
                                <i class="fas fa-user-plus ml-2"></i> إضافة أول موظف
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                    `;
                } else {
                    filteredUsers.forEach(user => {
                        const roleInfo = rolePermissions[user.role] || rolePermissions.employee;
                        const isActive = sessions.some(s => s.userId === user.id && !s.logoutTime);
                        const statusBadge = isActive ? 
                            '<span class="badge badge-success">نشط</span>' : 
                            '<span class="badge badge-secondary">غير نشط</span>';
                        
                        const userPermissions = user.permissions || roleInfo.permissions;
                        const grantedPermissions = Object.values(userPermissions).filter(p => p === true).length;
                        const totalPermissions = Object.keys(userPermissions).length;
                        
                        html += `
                        <tr>
                            <td>${user.name}</td>
                            <td><span class="role-badge ${roleInfo.badgeClass}">${roleInfo.name}</span></td>
                            <td>${user.rank || roleInfo.name}</td>
                            <td>${user.phone}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <span class="text-sm">${grantedPermissions}/${totalPermissions}</span>
                                <button onclick="viewUserPermissions(${user.id})" class="btn btn-info btn-sm mr-2">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                            <td>
                                <button onclick="openEditPermissions(${user.id})" class="btn btn-primary btn-sm mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteUser(${user.id}, '${user.name.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm" ${!checkPermission('deleteUsers') || (currentUser && currentUser.id === user.id) ? 'disabled style="opacity:0.5;"' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحميل جدول المستخدمين:', error);
                document.getElementById('adminUsersTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-red-500 py-4">
                            خطأ في تحميل بيانات المستخدمين
                        </td>
                    </tr>
                `;
            }
        }
        
        function viewUserPermissions(userId) {
            try {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const roleInfo = rolePermissions[user.role] || rolePermissions.employee;
                const permissions = user.permissions || roleInfo.permissions;
                
                let html = `
                    <h4 class="font-bold mb-2">${user.name}</h4>
                    <p><strong>الدور:</strong> ${roleInfo.name}</p>
                    <p><strong>الرتبة:</strong> ${user.rank || roleInfo.name}</p>
                    <p><strong>القسم:</strong> ${user.department || 'غير محدد'}</p>
                    <hr class="my-3">
                    <p><strong>الصلاحيات الممنوحة:</strong></p>
                    <ul class="list-disc pr-5 mt-2">
                `;
                
                for (const key in permissionNames) {
                    if (permissions[key]) {
                        html += `<li>✓ ${permissionNames[key]}</li>`;
                    } else {
                        html += `<li class="text-gray-400">✗ ${permissionNames[key]}</li>`;
                    }
                }
                
                html += `</ul>`;
                
                document.getElementById('requestDetailsTitle').textContent = `صلاحيات الموظف: ${user.name}`;
                document.getElementById('requestDetailsContent').innerHTML = html;
                openModal('requestDetailsModal');
            } catch (error) {
                console.error('خطأ في عرض صلاحيات المستخدم:', error);
                alert('حدث خطأ في عرض الصلاحيات');
            }
        }
        
        function loadAdminAttendanceTable() {
            try {
                const table = document.getElementById('adminAttendanceTable');
                const allSessions = sessions
                    .sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime));
                
                let html = '';
                
                if (allSessions.length === 0) {
                    html = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>لا توجد سجلات حضور</p>
                            <p class="text-sm text-gray-500">سيظهر هنا سجلات الدخول والخروج للموظفين</p>
                        </td>
                    </tr>
                    `;
                } else {
                    allSessions.forEach(session => {
                        const user = users.find(u => u.id === session.userId);
                        if (!user) return;
                        
                        const roleInfo = rolePermissions[user.role] || rolePermissions.employee;
                        const loginDate = new Date(session.loginTime);
                        const logoutDate = session.logoutTime ? new Date(session.logoutTime) : null;
                        
                        const dateStr = loginDate.toLocaleDateString('ar-SA');
                        const loginTimeStr = loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                        const logoutTimeStr = logoutDate ? logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '-';
                        const durationStr = session.totalMinutes ? `${Math.floor(session.totalMinutes / 60)}:${(session.totalMinutes % 60).toString().padStart(2, '0')}` : '-';
                        const reportShort = session.report ? (session.report.length > 30 ? session.report.substring(0, 30) + '...' : session.report) : '-';
                        
                        let statusBadge = session.logoutTime ? 
                            '<span class="badge badge-success">مكتمل</span>' : 
                            '<span class="badge badge-warning">قيد العمل</span>';
                        
                        html += `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.rank || roleInfo.name}</td>
                            <td>${dateStr}</td>
                            <td>${loginTimeStr}</td>
                            <td>${logoutTimeStr}</td>
                            <td>${durationStr}</td>
                            <td>
                                ${reportShort && reportShort !== '-' ? `
                                <button onclick="viewReportDetails(${session.id})" class="text-blue-600 hover:text-blue-800">
                                    ${reportShort}
                                </button>
                                ` : '-'}
                            </td>
                            <td>${statusBadge}</td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحميل جدول الحضور:', error);
                document.getElementById('adminAttendanceTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-red-500 py-4">
                            خطأ في تحميل سجلات الحضور
                        </td>
                    </tr>
                `;
            }
        }
        
        function viewReportDetails(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;
                
                const user = users.find(u => u.id === session.userId);
                const loginDate = new Date(session.loginTime);
                const logoutDate = session.logoutTime ? new Date(session.logoutTime) : null;
                
                let html = `
                    <p><strong>الموظف:</strong> ${user?.name || 'غير معروف'}</p>
                    <p><strong>الرتبة:</strong> ${user?.rank || 'غير محدد'}</p>
                    <p><strong>تاريخ:</strong> ${loginDate.toLocaleDateString('ar-SA')}</p>
                    <p><strong>وقت الدخول:</strong> ${loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</p>
                    <p><strong>وقت الخروج:</strong> ${logoutDate ? logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : 'لم يسجل خروج'}</p>
                    <p><strong>المدة:</strong> ${session.totalMinutes ? `${Math.floor(session.totalMinutes / 60)} ساعة و ${session.totalMinutes % 60} دقيقة` : '-'}</p>
                    <hr class="my-3">
                    <p><strong>تقرير العمل:</strong></p>
                    <p class="mt-2">${session.report || 'لا يوجد تقرير'}</p>
                `;
                
                document.getElementById('reportDetailsContent').innerHTML = html;
                openModal('reportDetailsModal');
            } catch (error) {
                console.error('خطأ في عرض تفاصيل التقرير:', error);
                alert('حدث خطأ في عرض التقرير');
            }
        }
        
        function loadAdminRequestsTable() {
            try {
                const table = document.getElementById('adminRequestsTable');
                const allRequests = requests
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = '';
                
                if (allRequests.length === 0) {
                    html = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>لا توجد طلبات</p>
                            <p class="text-sm text-gray-500">ستظهر هنا طلبات الإجازة والاستقالة من الموظفين</p>
                        </td>
                    </tr>
                    `;
                } else {
                    allRequests.forEach(request => {
                        const user = users.find(u => u.id === request.userId);
                        const roleInfo = user ? (rolePermissions[user.role] || rolePermissions.employee) : rolePermissions.employee;
                        
                        const date = new Date(request.timestamp);
                        const dateStr = date.toLocaleDateString('ar-SA');
                        
                        let statusBadge = '';
                        if (request.status === 'معلق') {
                            statusBadge = '<span class="badge badge-warning">معلق</span>';
                        } else if (request.status === 'مقبول') {
                            statusBadge = '<span class="badge badge-success">مقبول</span>';
                        } else {
                            statusBadge = '<span class="badge badge-danger">مرفوض</span>';
                        }
                        
                        const reasonShort = request.reason.length > 30 ? request.reason.substring(0, 30) + '...' : request.reason;
                        
                        let actionBtn = '';
                        if (request.status === 'معلق') {
                            actionBtn = `
                                <button onclick="viewRequestDetails(${request.id})" class="btn btn-primary btn-sm mr-2">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="processUserRequest(${request.id})" class="btn btn-warning btn-sm">
                                    معالجة
                                </button>
                            `;
                        } else {
                            actionBtn = `
                                <button onclick="viewRequestDetails(${request.id})" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <span class="text-gray-500 text-sm">تمت المعالجة</span>
                            `;
                        }
                        
                        html += `
                        <tr>
                            <td>${request.username}</td>
                            <td>${user?.rank || roleInfo.name}</td>
                            <td>${request.type}</td>
                            <td title="${request.reason}">${reasonShort}</td>
                            <td>${dateStr}</td>
                            <td>${statusBadge}</td>
                            <td>${actionBtn}</td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحميل جدول الطلبات:', error);
                document.getElementById('adminRequestsTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-red-500 py-4">
                            خطأ في تحميل طلبات الموظفين
                        </td>
                    </tr>
                `;
            }
        }
        
        function viewRequestDetails(requestId) {
            try {
                const request = requests.find(r => r.id === requestId);
                if (!request) return;
                
                const date = new Date(request.timestamp);
                const dateStr = date.toLocaleDateString('ar-SA') + ' ' + 
                               date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                
                let details = '';
                if (request.type === 'إجازة') {
                    details = `
                        <p><strong>نوع الطلب:</strong> ${request.type}</p>
                        <p><strong>الموظف:</strong> ${request.username}</p>
                        <p><strong>القسم:</strong> ${request.department}</p>
                        <p><strong>سبب الإجازة:</strong> ${request.reason}</p>
                        <p><strong>المدة:</strong> ${request.duration}</p>
                        <p><strong>تاريخ البدء:</strong> ${request.startDate}</p>
                        <p><strong>تاريخ الطلب:</strong> ${dateStr}</p>
                        <p><strong>الحالة:</strong> ${request.status}</p>
                    `;
                } else if (request.type === 'استقالة') {
                    details = `
                        <p><strong>نوع الطلب:</strong> ${request.type}</p>
                        <p><strong>الموظف:</strong> ${request.username}</p>
                        <p><strong>القسم:</strong> ${request.department}</p>
                        <p><strong>سبب الاستقالة:</strong> ${request.reason}</p>
                        <p><strong>تاريخ إنهاء العمل:</strong> ${request.endDate}</p>
                        <p><strong>تاريخ الطلب:</strong> ${dateStr}</p>
                        <p><strong>الحالة:</strong> ${request.status}</p>
                    `;
                }
                
                document.getElementById('requestDetailsTitle').textContent = `تفاصيل الطلب`;
                document.getElementById('requestDetailsContent').innerHTML = details;
                openModal('requestDetailsModal');
            } catch (error) {
                console.error('خطأ في عرض تفاصيل الطلب:', error);
                alert('حدث خطأ في عرض تفاصيل الطلب');
            }
        }
        
        function filterRequests() {
            try {
                const typeFilter = document.getElementById('filterRequestType').value;
                const statusFilter = document.getElementById('filterRequestStatus').value;
                const rows = document.querySelectorAll('#adminRequestsTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 7) return;
                    
                    const type = row.cells[2].textContent;
                    const status = row.cells[5].querySelector('span')?.textContent || '';
                    
                    const typeMatch = !typeFilter || type === typeFilter;
                    const statusMatch = !statusFilter || status === statusFilter;
                    
                    row.style.display = (typeMatch && statusMatch) ? '' : 'none';
                });
            } catch (error) {
                console.error('خطأ في تصفية الطلبات:', error);
            }
        }
        
        function processUserRequest(requestId) {
            try {
                requestToProcess = requestId;
                const request = requests.find(r => r.id === requestId);
                if (!request) return;
                
                document.getElementById('processMessage').textContent = `معالجة طلب ${request.type} للموظف "${request.username}"`;
                openModal('processModal');
            } catch (error) {
                console.error('خطأ في معالجة الطلب:', error);
                alert('حدث خطأ في معالجة الطلب');
            }
        }
        




        
        function loadPromotionHistory() {
            try {
                // تحديث طلبات الترقية المعلقة
                const pendingPromotions = promotions.filter(p => p.status === 'معلق')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let pendingHtml = '';
                if (pendingPromotions.length === 0) {
                    pendingHtml = '<p class="text-gray-500 text-center py-4">لا توجد طلبات ترقية معلقة</p>';
                } else {
                    pendingPromotions.forEach(promo => {
                        const date = new Date(promo.date);
                        pendingHtml += `
                        <div class="border-b py-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p><strong>الموظف:</strong> ${promo.username}</p>
                                    <p><strong>من:</strong> ${promo.fromRank}</p>
                                    <p><strong>إلى:</strong> ${promo.toRank}</p>
                                    <p><strong>السبب:</strong> ${promo.reason}</p>
                                </div>
                                <div>
                                    <button onclick="processPromotion(${promo.id}, 'مقبول')" class="btn btn-sm btn-success">قبول</button>
                                    <button onclick="processPromotion(${promo.id}, 'مرفوض')" class="btn btn-sm btn-danger">رفض</button>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
                
                document.getElementById('pendingPromotionsList').innerHTML = pendingHtml;
                
                // تحديث سجل الترقيات
                const allPromotions = promotions
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let historyHtml = '';
                if (allPromotions.length === 0) {
                    historyHtml = `
                    <tr>
                        <td colspan="6" class="text-center text-gray-500 py-4">
                            لا توجد ترقيات مسجلة
                        </td>
                    </tr>
                    `;
                } else {
                    allPromotions.forEach(promo => {
                        const date = new Date(promo.date);
                        historyHtml += `
                        <tr>
                            <td>${promo.username}</td>
                            <td>${promo.fromRank}</td>
                            <td>${promo.toRank}</td>
                            <td>${promo.reason}</td>
                            <td>${date.toLocaleDateString('ar-SA')}</td>
                            <td><span class="badge ${promo.status === 'مقبول' ? 'badge-success' : 'badge-danger'}">${promo.status}</span></td>
                        </tr>
                        `;
                    });
                }
                
                document.getElementById('promotionHistoryTable').innerHTML = historyHtml;
                
                // تحديث قائمة الموظفين للترقية
                const employeeSelect = document.getElementById('promotionEmployee');
                employeeSelect.innerHTML = '<option value="">-- اختر موظف --</option>';
                
                users.forEach(user => {
                    if (user.id !== currentUser.id) {
                        employeeSelect.innerHTML += `<option value="${user.id}">${user.name} (${user.rank})</option>`;
                    }
                });
            } catch (error) {
                console.error('خطأ في تحميل سجل الترقيات:', error);
            }
        }
        
        function processPromotion(promotionId, status) {
            try {
                const promoIndex = promotions.findIndex(p => p.id === promotionId);
                if (promoIndex === -1) return;
                
                promotions[promoIndex].status = status;
                
                if (status === 'مقبول') {
                    const promo = promotions[promoIndex];
                    const userIndex = users.findIndex(u => u.id === promo.userId);
                    
                    if (userIndex !== -1) {
                        // تحديث رتبة الموظف
                        users[userIndex].rank = promo.toRank;
                        
                        // تحديث سجل الرتب
                        if (!users[userIndex].rankHistory) {
                            users[userIndex].rankHistory = [];
                        }
                        users[userIndex].rankHistory.push({
                            rank: promo.toRank,
                            date: new Date().toISOString(),
                            reason: promo.reason
                        });
                        
                        // تحديث الدور حسب الرتبة
                        let newRole = 'employee';
                        if (promo.toRank === 'مشرف') newRole = 'supervisor';
                        else if (promo.toRank === 'مدير قسم') newRole = 'manager';
                        else if (promo.toRank === 'مدير نظام') newRole = 'admin';
                        
                        users[userIndex].role = newRole;
                        users[userIndex].permissions = rolePermissions[newRole].permissions;
                    }
                }
                
                saveData();
                loadPromotionHistory();
                loadAdminUsersTable();
                
                showToast(`تم ${status === 'مقبول' ? 'قبول' : 'رفض'} طلب الترقية`, 'success');
            } catch (error) {
                console.error('خطأ في معالجة طلب الترقية:', error);
                alert('حدث خطأ في معالجة طلب الترقية');
            }
        }


        
        
        function promoteEmployee() {
            try {
                const employeeId = parseInt(document.getElementById('promotionEmployee').value);
                const newRank = document.getElementById('promotionNewRank').value;
                const reason = document.getElementById('promotionReason').value.trim();
                
                if (!employeeId || !newRank || !reason) {
                    alert('يرجى ملء جميع الحقول');
                    return;
                }
                
                const userIndex = users.findIndex(u => u.id === employeeId);
                if (userIndex === -1) {
                    alert('الموظف غير موجود');
                    return;
                }
                
                const user = users[userIndex];
                const newRankName = rolePermissions[newRank].name;
                
                // تحديث رتبة الموظف
                users[userIndex].rank = newRankName;
                
                // تحديث سجل الرتب
                if (!users[userIndex].rankHistory) {
                    users[userIndex].rankHistory = [];
                }
                users[userIndex].rankHistory.push({
                    rank: newRankName,
                    date: new Date().toISOString(),
                    reason: reason
                });
                
                // تحديث الدور حسب الرتبة
                users[userIndex].role = newRank;
                users[userIndex].permissions = rolePermissions[newRank].permissions;
                
                // تسجيل الترقية
                const promotion = {
                    id: promotions.length > 0 ? Math.max(...promotions.map(p => p.id)) + 1 : 1,
                    userId: user.id,
                    username: user.name,
                    fromRank: user.rankHistory[user.rankHistory.length - 2]?.rank || 'موظف عادي',
                    toRank: newRankName,
                    reason: reason,
                    status: 'مقبول',
                    date: new Date().toISOString()
                };
                
                promotions.push(promotion);
                saveData();
                
                // إعادة تعيين الحقول
                document.getElementById('promotionEmployee').value = '';
                document.getElementById('promotionNewRank').value = '';
                document.getElementById('promotionReason').value = '';
                
                // تحديث البيانات
                loadPromotionHistory();
                loadAdminUsersTable();
                loadEmployeeSelect();
                
                showToast('تم تنفيذ الترقية بنجاح!', 'success');
            } catch (error) {
                console.error('خطأ في تنفيذ الترقية:', error);
                alert('حدث خطأ في تنفيذ الترقية');
            }
        }
        
        function loadReports() {
            try {
                const userStats = users
                    .filter(u => u.role !== 'admin')
                    .map(user => {
                        const userSessions = sessions.filter(s => s.userId === user.id && s.logoutTime);
                        const totalMinutes = userSessions.reduce((sum, session) => sum + (session.totalMinutes || 0), 0);
                        return { user, totalMinutes };
                    })
                    .sort((a, b) => b.totalMinutes - a.totalMinutes)
                    .slice(0, 5);
                
                let topUsersHtml = '';
                if (userStats.length === 0) {
                    topUsersHtml = '<p class="text-gray-500 text-center">لا توجد بيانات عن الموظفين</p>';
                } else {
                    userStats.forEach((stat, index) => {
                        const hours = (stat.totalMinutes / 60).toFixed(1);
                        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '👤';
                        topUsersHtml += `
                        <div class="flex justify-between items-center py-2 border-b">
                            <div>
                                <span class="ml-2">${medal}</span>
                                <span>${stat.user.name}</span>
                                <span class="text-gray-500 text-sm">(${stat.user.rank})</span>
                            </div>
                            <span class="font-bold">${hours} ساعة</span>
                        </div>
                        `;
                    });
                }
                
                document.getElementById('topEmployeesList').innerHTML = topUsersHtml;
                
                // إحصائيات الرتب
                const ranks = {};
                users.forEach(user => {
                    if (user.role !== 'admin') {
                        const rank = user.rank || 'موظف عادي';
                        if (!ranks[rank]) ranks[rank] = { count: 0, hours: 0 };
                        ranks[rank].count++;
                        
                        const userSessions = sessions.filter(s => s.userId === user.id && s.logoutTime);
                        const totalMinutes = userSessions.reduce((sum, session) => sum + (session.totalMinutes || 0), 0);
                        ranks[rank].hours += totalMinutes / 60;
                    }
                });
                
                let rankStatsHtml = '';
                for (const [rank, data] of Object.entries(ranks)) {
                    rankStatsHtml += `
                    <div class="flex justify-between items-center py-2 border-b">
                        <span>${rank}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">${data.count} موظف</span>
                            <span class="font-bold">${data.hours.toFixed(1)} ساعة</span>
                        </div>
                    </div>
                    `;
                }
                
                if (Object.keys(ranks).length === 0) {
                    rankStatsHtml = '<p class="text-gray-500 text-center">لا توجد بيانات عن الرتب</p>';
                }
                
                document.getElementById('rankStats').innerHTML = rankStatsHtml;
                
                const today = new Date();
                const lastWeek = new Date();
                lastWeek.setDate(lastWeek.getDate() - 7);
                
                document.getElementById('reportFromDate').value = lastWeek.toISOString().split('T')[0];
                document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
                
                document.getElementById('attendanceReportResult').innerHTML = '';
            } catch (error) {
                console.error('خطأ في تحميل التقارير:', error);
            }
        }
        
        function generateAttendanceReport() {
            try {
                const fromDate = document.getElementById('reportFromDate').value;
                const toDate = document.getElementById('reportToDate').value;
                
                if (!fromDate || !toDate) {
                    alert('يرجى تحديد تاريخ البداية والنهاية');
                    return;
                }
                
                const filteredSessions = sessions.filter(s => {
                    const sessionDate = s.loginTime.split('T')[0];
                    return sessionDate >= fromDate && sessionDate <= toDate && s.logoutTime;
                });
                
                if (filteredSessions.length === 0) {
                    document.getElementById('attendanceReportResult').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle ml-1"></i>
                            لا توجد سجلات حضور في الفترة المحددة
                        </div>
                    `;
                    return;
                }
                
                // ===== إضافة هذين المتغيرين =====
                let html = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold mb-3">تقرير الحضور من ${fromDate} إلى ${toDate}</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold">${filteredSessions.length}</div>
                                <div class="text-gray-600">سجلات حضور</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${new Set(filteredSessions.map(s => s.userId)).size}</div>
                                <div class="text-gray-600">موظف</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${(filteredSessions.reduce((sum, s) => sum + s.totalMinutes, 0) / 60).toFixed(1)}</div>
                                <div class="text-gray-600">إجمالي الساعات</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${(filteredSessions.reduce((sum, s) => sum + s.totalMinutes, 0) / filteredSessions.length / 60).toFixed(1)}</div>
                                <div class="text-gray-600">متوسط اليوم</div>
                            </div>
                        </div>
                        <button onclick="downloadReport(${JSON.stringify(filteredSessions).replace(/"/g, '&quot;')}, '${fromDate}', '${toDate}')" 
                                class="btn btn-success mt-2">
                            <i class="fas fa-download ml-2"></i> تحميل التقرير
                        </button>
                    </div>
                `;
                
                document.getElementById('attendanceReportResult').innerHTML = html;
            } catch (error) {
                console.error('خطأ في إنشاء التقرير:', error);
                document.getElementById('attendanceReportResult').innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle ml-1"></i>
                        حدث خطأ في إنشاء التقرير
                    </div>
                `;
            }
        }
        

        // ===== أضف هذا السطر داخل loadData() =====
customRoles = JSON.parse(localStorage.getItem('attendance_custom_roles') || '{}');








// ===== دالة لجلب كل الرتب =====
function getAllRoles() {
    return { ...baseRoles, ...customRoles };
}

// ===== دالة لجلب معلومات الرتبة =====
function getRoleInfo(roleKey) {
    const allRoles = getAllRoles();
    return allRoles[roleKey] || baseRoles.employee;
}

// ===== دالة إضافة رتبة جديدة =====
function addNewRole() {
    try {
        const name = document.getElementById('newRoleName').value.trim();
        const key = document.getElementById('newRoleKey').value.trim();
        
        if (!name || !key) {
            showAlert('يرجى ملء جميع الحقول', 'error');
            return;
        }
        
        // التحقق من أن المفتاح فريد
        const allRoles = getAllRoles();
        if (allRoles[key]) {
            showAlert('مفتاح الرتبة موجود مسبقاً', 'error');
            return;
        }
        
        // إنشاء الرتبة الجديدة مع صلاحيات افتراضية
        const newRole = {
            name: name,
            badgeClass: "role-badge-custom",
            permissions: {
                attendance: true,
                leave: true,
                resign: true,
                viewHistory: true,
                viewStats: true,
                viewTeamAttendance: false,
                viewTeamRequests: false,
                addUsers: false,
                editPermissions: false,
                viewAllAttendance: false,
                processRequests: false,
                viewReports: false,
                deleteUsers: false,
                requestPromotion: false
            }
        };
        
        customRoles[key] = newRole;
        saveData();
        
        // إعادة تعيين الحقول
        document.getElementById('newRoleName').value = '';
        document.getElementById('newRoleKey').value = '';
        
        closeModal('addRoleModal');
        
        // تحديث الواجهة
        if (document.getElementById('rolesList')) {
            loadRolesList();
        }
        if (document.getElementById('assignNewRank')) {
            loadRankSelect();
        }
        
        showToast('تم إضافة الرتبة الجديدة بنجاح!', 'success');
    } catch (error) {
        console.error('خطأ في إضافة رتبة جديدة:', error);
        showAlert('حدث خطأ في إضافة الرتبة الجديدة', 'error');
    }
}






// ===== إضافة Event Listener لنموذج إضافة رتبة =====
document.addEventListener('DOMContentLoaded', function() {
    // ... الكود الحالي ...
    
    // أضف هذا الكود:
    const addRoleForm = document.getElementById('addRoleForm');
    if (addRoleForm) {
        addRoleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            addNewRole();
        });
    }
    
    // تأكد من وجود هذا:
    if (document.getElementById('rolesList')) {
        loadRolesList();
    }
});


// ===== دالة تحميل الرتب في القائمة المنسدلة =====
function loadRankSelect() {
    const rankSelect = document.getElementById('assignNewRank');
    if (!rankSelect) return;
    
    rankSelect.innerHTML = '<option value="">-- اختر الرتبة --</option>';
    const allRoles = getAllRoles();
    
    Object.entries(allRoles).forEach(([key, role]) => {
        rankSelect.innerHTML += `<option value="${key}">${role.name}</option>`;
    });
}








        function downloadReport(sessionsData, fromDate, toDate) {
            try {
                let reportText = `تقرير الحضور والانصراف\n`;
                reportText += `من: ${fromDate} إلى: ${toDate}\n`;
                reportText += `========================\n\n`;
                
                sessionsData.forEach(session => {
                    const user = users.find(u => u.id === session.userId);
                    const loginDate = new Date(session.loginTime);
                    const logoutDate = new Date(session.logoutTime);
                    
                    reportText += `الموظف: ${user?.name || 'غير معروف'}\n`;
                    reportText += `الرتبة: ${user?.rank || 'غير محدد'}\n`;
                    reportText += `التاريخ: ${loginDate.toLocaleDateString('ar-SA')}\n`;
                    reportText += `الدخول: ${loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n`;
                    reportText += `الخروج: ${logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n`;
                    reportText += `المدة: ${Math.floor(session.totalMinutes / 60)}:${(session.totalMinutes % 60).toString().padStart(2, '0')}\n`;
                    reportText += `تقرير العمل: ${session.report || 'لا يوجد'}\n`;
                    reportText += `------------------------\n`;
                });
                
                const blob = new Blob([reportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `تقرير_الحضور_${fromDate}_إلى_${toDate}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('تم تحميل التقرير بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تحميل التقرير:', error);
                showAlert('حدث خطأ في تحميل التقرير', 'error');
            }
        }
        
        // ===== دوال إدارة الرتب =====
        function loadRolesList() {
            try {
                const rolesList = document.getElementById('rolesList');
                if (!rolesList) return;
                
                let html = '';
                
                const baseRoles = ['employee', 'supervisor', 'manager', 'admin'];
                
                baseRoles.forEach((roleKey) => {
                    const role = rolePermissions[roleKey];
                    const isSelected = currentEditingRole === roleKey;
                    
                    html += `
                        <div class="role-item ${isSelected ? 'selected' : ''}" 
                             onclick="editRole('${roleKey}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-lg">${role.name}</h4>
                                    <p class="text-sm text-gray-500">${roleKey}</p>
                                </div>
                                <span class="${isSelected ? 'text-white' : 'text-blue-500'}">
                                    <i class="fas fa-chevron-left"></i>
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                rolesList.innerHTML = html;
                
                // تحميل الرتبة الأولى افتراضياً
                if (!currentEditingRole && baseRoles.length > 0) {
                    editRole(baseRoles[0]);
                }
            } catch (error) {
                console.error('خطأ في تحميل قائمة الرتب:', error);
            }
        }
        
        function editRole(roleKey) {
            currentEditingRole = roleKey;
            const role = rolePermissions[roleKey];
            
            // تحديث واجهة التعديل
            document.getElementById('editRoleName').value = role.name;
            document.getElementById('editingRoleTitle').textContent = `تعديل صلاحيات: ${role.name}`;
            
            let permissionsHtml = '';
            for (const key in permissionNames) {
                const hasPermission = role.permissions[key] === true;
                permissionsHtml += `
                    <div class="flex items-center justify-between p-2 border-b border-gray-200">
                        <span>${permissionNames[key]}</span>
                        <input type="checkbox" 
                               id="perm_${key}" 
                               ${hasPermission ? 'checked' : ''}
                               class="w-5 h-5 rounded text-blue-600">
                    </div>
                `;
            }
            
            document.getElementById('rolePermissionsList').innerHTML = permissionsHtml;
            
            // تحديث قائمة الرتب
            document.querySelectorAll('#rolesList .role-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const selectedItem = document.querySelector(`[onclick="editRole('${roleKey}')"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
        }


// ===== دالة لجلب كل الرتب =====
function getAllRoles() {
    return { ...baseRoles, ...customRoles };
}

// ===== دالة لجلب معلومات الرتبة =====
function getRoleInfo(roleKey) {
    const allRoles = getAllRoles();
    return allRoles[roleKey] || baseRoles.employee;
}


// ===== دالة لجلب كل الرتب =====
function getAllRoles() {
    return { ...baseRoles, ...customRoles };
}

// ===== دالة لجلب معلومات الرتبة =====
function getRoleInfo(roleKey) {
    const allRoles = getAllRoles();
    return allRoles[roleKey] || baseRoles.employee;
}




        
        function saveRolePermissions() {
            if (!currentEditingRole) return;
            
            const roleKey = currentEditingRole;
            const role = rolePermissions[roleKey];
            
            // تحديث الصلاحيات
            for (const key in permissionNames) {
                const checkbox = document.getElementById(`perm_${key}`);
                role.permissions[key] = checkbox.checked;
            }
            
            // تحديث جميع المستخدمين الذين لديهم هذه الرتبة
            users.forEach(user => {
                if (user.role === roleKey) {
                    user.permissions = { ...role.permissions };
                }
            });
            
            saveData();
            
            // إذا كان المستخدم الحالي من نفس الرتبة، تحديث صلاحياته
            if (currentUser && currentUser.role === roleKey) {
                currentUser.permissions = { ...role.permissions };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUserInterface();
            }
            
            showToast('تم تحديث صلاحيات الرتبة بنجاح!', 'success');
        }
        
        function deleteRole() {
            alert('لا يمكن حذف الرتب الأساسية. يمكنك فقط تعديل صلاحياتها.');
        }
        
        function loadEmployeeSelect() {
            const employeeSelect = document.getElementById('selectEmployee');
            if (!employeeSelect) return;
            
            employeeSelect.innerHTML = '<option value="">-- اختر موظف --</option>';
            users.forEach(user => {
                if (user.id !== currentUser?.id) {
                    employeeSelect.innerHTML += `<option value="${user.id}">${user.name} (${user.rank})</option>`;
                }
            });
        }
        
        function loadRankSelect() {
            const rankSelect = document.getElementById('assignNewRank');
            if (!rankSelect) return;
            
            rankSelect.innerHTML = '<option value="">-- اختر الرتبة --</option>';
            for (const [key, role] of Object.entries(rolePermissions)) {
                rankSelect.innerHTML += `<option value="${key}">${role.name}</option>`;
            }
        }
        
        function loadEmployeeCurrentRank() {
            const employeeId = parseInt(document.getElementById('selectEmployee').value);
            if (!employeeId) {
                document.getElementById('employeeCurrentRank').value = '';
                return;
            }
            
            const user = users.find(u => u.id === employeeId);
            if (user) {
                document.getElementById('employeeCurrentRank').value = user.rank || 'موظف عادي';
            }
        }
        
        function assignRankToEmployee() {
            try {
                const employeeId = parseInt(document.getElementById('selectEmployee').value);
                const newRankKey = document.getElementById('assignNewRank').value;
                const reason = document.getElementById('rankChangeReason').value.trim();
                
                if (!employeeId || !newRankKey || !reason) {
                    alert('يرجى ملء جميع الحقول');
                    return;
                }
                
                const userIndex = users.findIndex(u => u.id === employeeId);
                if (userIndex === -1) {
                    alert('الموظف غير موجود');
                    return;
                }
                
                const user = users[userIndex];
                const newRank = rolePermissions[newRankKey].name;
                
                // تحديث رتبة الموظف
                users[userIndex].rank = newRank;
                
                // تحديث سجل الرتب
                if (!users[userIndex].rankHistory) {
                    users[userIndex].rankHistory = [];
                }
                users[userIndex].rankHistory.push({
                    rank: newRank,
                    date: new Date().toISOString(),
                    reason: reason
                });
                
                // تحديث الدور حسب الرتبة
                users[userIndex].role = newRankKey;
                users[userIndex].permissions = rolePermissions[newRankKey].permissions;
                
                // تسجيل التغيير
                const promotion = {
                    id: promotions.length > 0 ? Math.max(...promotions.map(p => p.id)) + 1 : 1,
                    userId: user.id,
                    username: user.name,
                    fromRank: user.rankHistory[user.rankHistory.length - 2]?.rank || 'موظف عادي',
                    toRank: newRank,
                    reason: reason,
                    status: 'مقبول',
                    date: new Date().toISOString()
                };
                
                promotions.push(promotion);
                saveData();
                
                // إعادة تعيين الحقول
                document.getElementById('selectEmployee').value = '';
                document.getElementById('employeeCurrentRank').value = '';
                document.getElementById('assignNewRank').value = '';
                document.getElementById('rankChangeReason').value = '';
                
                // تحديث البيانات
                loadPromotionHistory();
                loadAdminUsersTable();
                loadEmployeeSelect();
                
                showToast('تم تعيين الرتبة بنجاح!', 'success');
            } catch (error) {
                console.error('خطأ في تعيين الرتبة:', error);
                alert('حدث خطأ في تعيين الرتبة');
            }
        }
        
        // ===== دوال إدارة الموظفين =====
        function deleteUser(userId, userName) {
            if (!checkPermission('deleteUsers')) {
                alert('ليس لديك صلاحية لحذف الموظفين');
                return;
            }
            
            if (currentUser && currentUser.id === userId) {
                alert('لا يمكنك حذف حسابك الخاص!');
                return;
            }
            
            userToDelete = userId;
            document.getElementById('deleteMessage').textContent = `هل أنت متأكد من حذف الموظف "${userName}"؟ سيتم حذف جميع بياناته أيضًا.`;
            openModal('deleteModal');
        }
        
        function confirmDelete() {
            if (!userToDelete) return;
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    users = users.filter(u => u.id !== userToDelete);
                    sessions = sessions.filter(s => s.userId !== userToDelete);
                    requests = requests.filter(r => r.userId !== userToDelete);
                    logs = logs.filter(l => l.userId !== userToDelete);
                    promotions = promotions.filter(p => p.userId !== userToDelete);
                    
                    saveData();
                    
                    updateAdminStats();
                    loadAdminUsersTable();
                    loadAdminAttendanceTable();
                    loadAdminRequestsTable();
                    loadReports();
                    loadPromotionHistory();
                    loadEmployeeSelect();
                    
                    closeModal('deleteModal');
                    showToast('تم حذف الموظف بنجاح!', 'success');
                } catch (error) {
                    console.error('خطأ في تأكيد الحذف:', error);
                    showAlert('حدث خطأ في حذف الموظف', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function showRejectReason() {
            try {
                document.getElementById('processReasonField').style.display = 'block';
            } catch (error) {
                console.error('خطأ في عرض سبب الرفض:', error);
            }
        }
        
        function processRequest(status) {
            if (!requestToProcess) return;
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    const requestIndex = requests.findIndex(r => r.id === requestToProcess);
                    if (requestIndex !== -1) {
                        requests[requestIndex].status = status;
                        
                        if (status === 'مرفوض') {
                            const rejectReason = document.getElementById('rejectReason').value.trim();
                            if (rejectReason) {
                                requests[requestIndex].rejectReason = rejectReason;
                            }
                        }
                        
                        saveData();
                        
                        loadAdminRequestsTable();
                        updateAdminStats();
                        
                        closeModal('processModal');
                        showToast(`تم ${status === 'مقبول' ? 'قبول' : 'رفض'} الطلب بنجاح!`, 'success');
                    }
                } catch (error) {
                    console.error('خطأ في معالجة الطلب:', error);
                    showAlert('حدث خطأ في معالجة الطلب', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        


        





function showToast(message, type = 'info') {
    try {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    } catch (error) {
        console.error('خطأ في عرض التنبيه:', error);
        alert(message); // عرض بديل
    }
}


function getAllRoles() {
    return { ...rolePermissions, ...customRoles };
}




function getRoleInfo(roleKey) {
    const allRoles = getAllRoles();
    return allRoles[roleKey] || rolePermissions.employee;
}

function addNewRole() {
    try {
        const name = document.getElementById('newRoleName').value.trim();
        const key = document.getElementById('newRoleKey').value.trim();
        
        if (!name || !key) {
            showAlert('يرجى ملء جميع الحقول', 'error');
            return;
        }
        
        // التحقق من أن المفتاح فريد
        const allRoles = getAllRoles();
        if (allRoles[key]) {
            showAlert('مفتاح الرتبة موجود مسبقاً', 'error');
            return;
        }
        
        // إنشاء الرتبة الجديدة مع صلاحيات افتراضية
        const newRole = {
            name: name,
            badgeClass: "role-badge-custom",
            permissions: {
                attendance: true,
                leave: true,
                resign: true,
                viewHistory: true,
                viewStats: true,
                viewTeamAttendance: false,
                viewTeamRequests: false,
                addUsers: false,
                editPermissions: false,
                viewAllAttendance: false,
                processRequests: false,
                viewReports: false,
                deleteUsers: false,
                requestPromotion: false
            }
        };
        
        customRoles[key] = newRole;
        saveData();
        
        // إعادة تعيين الحقول
        document.getElementById('newRoleName').value = '';
        document.getElementById('newRoleKey').value = '';
        
        closeModal('addRoleModal');
        
        // تحديث الواجهة
        loadRolesList();
        loadRankSelect();
        
        showToast('تم إضافة الرتبة الجديدة بنجاح!', 'success');
    } catch (error) {
        console.error('خطأ في إضافة رتبة جديدة:', error);
        showAlert('حدث خطأ في إضافة الرتبة الجديدة', 'error');
    }
}


function loadRolesList() {
    try {
        const rolesList = document.getElementById('rolesList');
        if (!rolesList) return;
        
        let html = '';
        
        const allRoles = getAllRoles();
        
        Object.entries(allRoles).forEach(([roleKey, role]) => {
            const isSelected = currentEditingRole === roleKey;
            
            html += `
                <div class="role-item ${isSelected ? 'selected' : ''}" 
                     onclick="editRole('${roleKey}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-lg">${role.name}</h4>
                            <p class="text-sm text-gray-500">${roleKey}</p>
                        </div>
                        <span class="${isSelected ? 'text-white' : 'text-blue-500'}">
                            <i class="fas fa-chevron-left"></i>
                        </span>
                    </div>
                </div>
            `;
        });
        
        rolesList.innerHTML = html;
        
        // تحميل الرتبة الأولى افتراضياً
        if (!currentEditingRole && Object.keys(allRoles).length > 0) {
            const firstRole = Object.keys(allRoles)[0];
            editRole(firstRole);
        }
    } catch (error) {
        console.error('خطأ في تحميل قائمة الرتب:', error);
    }
}


function loadRankSelect() {
    const rankSelect = document.getElementById('assignNewRank');
    if (!rankSelect) return;
    
    rankSelect.innerHTML = '<option value="">-- اختر الرتبة --</option>';
    const allRoles = getAllRoles();
    
    Object.entries(allRoles).forEach(([key, role]) => {
        rankSelect.innerHTML += `<option value="${key}">${role.name}</option>`;
    });
}

function saveData() {
    localStorage.setItem('attendance_users', JSON.stringify(users));
    localStorage.setItem('attendance_sessions', JSON.stringify(sessions));
    localStorage.setItem('attendance_requests', JSON.stringify(requests));
    localStorage.setItem('attendance_logs', JSON.stringify(logs));
    localStorage.setItem('attendance_promotions', JSON.stringify(promotions));
    
    // أضف هذا السطر لتخزين الرتب المخصصة
    localStorage.setItem('attendance_custom_roles', JSON.stringify(customRoles));
}

function loadData() {
    try {
        users = JSON.parse(localStorage.getItem('attendance_users') || '[]');
        sessions = JSON.parse(localStorage.getItem('attendance_sessions') || '[]');
        requests = JSON.parse(localStorage.getItem('attendance_requests') || '[]');
        logs = JSON.parse(localStorage.getItem('attendance_logs') || '[]');
        promotions = JSON.parse(localStorage.getItem('attendance_promotions') || '[]');
        
        // أضف هذا السطر لتحميل الرتب المخصصة
        customRoles = JSON.parse(localStorage.getItem('attendance_custom_roles') || '{}');
        
        if (users.length === 0) {
            createAdminOnly();
        }
    } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        createAdminOnly();
    }
}



function assignRankToEmployee() {
    try {
        const employeeId = parseInt(document.getElementById('selectEmployee').value);
        const newRankKey = document.getElementById('assignNewRank').value;
        const reason = document.getElementById('rankChangeReason').value.trim();
        
        if (!employeeId || !newRankKey || !reason) {
            alert('يرجى ملء جميع الحقول');
            return;
        }
        
        const userIndex = users.findIndex(u => u.id === employeeId);
        if (userIndex === -1) {
            alert('الموظف غير موجود');
            return;
        }
        
        const user = users[userIndex];
        const allRoles = getAllRoles();
        const newRole = allRoles[newRankKey];
        
        if (!newRole) {
            alert('الرتبة المحددة غير موجودة');
            return;
        }
        
        // تحديث رتبة الموظف
        users[userIndex].rank = newRole.name;
        
        // تحديث سجل الرتب
        if (!users[userIndex].rankHistory) {
            users[userIndex].rankHistory = [];
        }
        users[userIndex].rankHistory.push({
            rank: newRole.name,
            date: new Date().toISOString(),
            reason: reason
        });
        
        // تحديث الدور حسب الرتبة
        users[userIndex].role = newRankKey;
        users[userIndex].permissions = newRole.permissions;
        
        // تسجيل التغيير
        const promotion = {
            id: promotions.length > 0 ? Math.max(...promotions.map(p => p.id)) + 1 : 1,
            userId: user.id,
            username: user.name,
            fromRank: user.rankHistory[user.rankHistory.length - 2]?.rank || 'موظف عادي',
            toRank: newRole.name,
            reason: reason,
            status: 'مقبول',
            date: new Date().toISOString()
        };
        

function editRole(roleKey) {
    currentEditingRole = roleKey;
    const allRoles = getAllRoles();
    const role = allRoles[roleKey];
    
    if (!role) {
        console.error(`الرتبة ${roleKey} غير موجودة`);
        return;
    }
    
    // تحديث واجهة التعديل
    document.getElementById('editRoleName').value = role.name;
    document.getElementById('editingRoleTitle').textContent = `تعديل صلاحيات: ${role.name}`;
    
    let permissionsHtml = '';
    for (const key in permissionNames) {
        const hasPermission = role.permissions ? (role.permissions[key] === true) : false;
        permissionsHtml += `
            <div class="flex items-center justify-between p-2 border-b border-gray-200">
                <span>${permissionNames[key]}</span>
                <input type="checkbox" 
                       id="perm_${key}" 
                       ${hasPermission ? 'checked' : ''}
                       class="w-5 h-5 rounded text-blue-600">
            </div>
        `;
    }
    
    document.getElementById('rolePermissionsList').innerHTML = permissionsHtml;
    
    // تحديث زر الحذف
    const deleteBtn = document.getElementById('deleteRoleBtn');
    if (deleteBtn) {
        // يمكن حذف الرتب المخصصة فقط، لا الرتب الأساسية
        const isCustomRole = customRoles[roleKey];
        deleteBtn.disabled = !isCustomRole;
    }
    
    // تحديث قائمة الرتب
    document.querySelectorAll('#rolesList .role-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    const selectedItem = document.querySelector(`[onclick="editRole('${roleKey}')"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }
}



function saveRolePermissions() {
    if (!currentEditingRole) return;
    
    const roleKey = currentEditingRole;
    const allRoles = getAllRoles();
    const role = allRoles[roleKey];
    
    if (!role) {
        alert('الرتبة غير موجودة');
        return;
    }
    
    // تحديث الصلاحيات
    for (const key in permissionNames) {
        const checkbox = document.getElementById(`perm_${key}`);
        role.permissions[key] = checkbox.checked;
    }
    
    // حفظ التغييرات
    if (rolePermissions[roleKey]) {
        // إذا كانت رتبة أساسية، تحديث rolePermissions
        rolePermissions[roleKey].permissions = { ...role.permissions };
    } else if (customRoles[roleKey]) {
        // إذا كانت رتبة مخصصة، تحديث customRoles
        customRoles[roleKey].permissions = { ...role.permissions };
    }
    
    // تحديث جميع المستخدمين الذين لديهم هذه الرتبة
    users.forEach(user => {
        if (user.role === roleKey) {
            user.permissions = { ...role.permissions };
        }
    });
    
    saveData();
    
    // إذا كان المستخدم الحالي من نفس الرتبة، تحديث صلاحياته
    if (currentUser && currentUser.role === roleKey) {
        currentUser.permissions = { ...role.permissions };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateUserInterface();
    }
    
    showToast('تم تحديث صلاحيات الرتبة بنجاح!', 'success');
}



function deleteRole() {
    if (!currentEditingRole) return;
    
    const roleKey = currentEditingRole;
    
    // التحقق إذا كانت رتبة أساسية
    if (rolePermissions[roleKey]) {
        alert('لا يمكن حذف الرتب الأساسية. يمكنك فقط تعديل صلاحياتها.');
        return;
    }
    


    
    // التحقق إذا كانت رتبة مخصصة
    if (customRoles[roleKey]) {
        if (confirm(`هل أنت متأكد من حذف الرتبة "${customRoles[roleKey].name}"؟`)) {
            // التحقق إذا كان هناك مستخدمين يستخدمون هذه الرتبة
            const usersWithThisRole = users.filter(u => u.role === roleKey);
            
            if (usersWithThisRole.length > 0) {
                alert(`لا يمكن حذف الرتبة لأن ${usersWithThisRole.length} موظف يستخدمونها. قم بتغيير رتبتهم أولاً.`);
                return;
            }
            
            // حذف الرتبة
            delete customRoles[roleKey];
            
            // إعادة تعيين الرتبة الحالية
            currentEditingRole = null;
            
            // تحديث واجهة التعديل
            document.getElementById('editRoleName').value = '';
            document.getElementById('editingRoleTitle').textContent = 'تعديل صلاحيات الرتبة';
            document.getElementById('rolePermissionsList').innerHTML = '';
            document.getElementById('deleteRoleBtn').disabled = true;
            
            saveData();
            loadRolesList();
            loadRankSelect();
            
            showToast('تم حذف الرتبة بنجاح!', 'success');
        }
    }
}

function loadRolesList() {
    try {
        const rolesList = document.getElementById('rolesList');
        if (!rolesList) return;
        
        let html = '';
        
        const allRoles = getAllRoles();
        
        Object.entries(allRoles).forEach(([roleKey, role]) => {
            if (!role) return; // تخطي الرتب غير المعرفة
            
            const isSelected = currentEditingRole === roleKey;
            
            html += `
                <div class="role-item ${isSelected ? 'selected' : ''}" 
                     onclick="editRole('${roleKey}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-lg">${role.name || roleKey}</h4>
                            <p class="text-sm text-gray-500">${roleKey}</p>
                            ${customRoles[roleKey] ? 
                                '<span class="text-xs text-green-600">(مخصصة)</span>' : 
                                '<span class="text-xs text-blue-600">(أساسية)</span>'}
                        </div>
                        <span class="${isSelected ? 'text-white' : 'text-blue-500'}">
                            <i class="fas fa-chevron-left"></i>
                        </span>
                    </div>
                </div>
            `;
        });
        
        rolesList.innerHTML = html;
        
        // تحميل الرتبة الأولى افتراضياً
        if (!currentEditingRole && Object.keys(allRoles).length > 0) {
            const firstRole = Object.keys(allRoles)[0];
            editRole(firstRole);
        }
    } catch (error) {
        console.error('خطأ في تحميل قائمة الرتب:', error);
        rolesList.innerHTML = `
            <div class="text-red-500 p-4">
                خطأ في تحميل قائمة الرتب: ${error.message}
            </div>
        `;
    }
}

function initializeDeleteButton() {
    const deleteBtn = document.getElementById('deleteRoleBtn');
    if (deleteBtn && currentEditingRole) {
        const isCustomRole = customRoles[currentEditingRole];
        deleteBtn.disabled = !isCustomRole;
    }
}


document.addEventListener('DOMContentLoaded', function() {
    try {
        loadData();
        updatePermissionsForm();
        
        // ... الكود الحالي ...
        
        // تحميل قائمة الرتب
        loadRolesList();
        
        // تحميل قائمة الرتب في القوائم المنسدلة
        loadRankSelect();
        
    } catch (error) {
        console.error('خطأ في تهيئة النظام:', error);
    }
});


function debugAllRoles() {
    console.log("=== الرتب المتاحة ===");
    const allRoles = getAllRoles();
    console.log("إجمالي الرتب:", Object.keys(allRoles).length);
    Object.entries(allRoles).forEach(([key, role]) => {
        console.log(`${key}:`, role ? role.name : "غير معرف");
    });
    console.log("==================");
}


function editRole(roleKey) {
    console.log("تحرير الرتبة:", roleKey);
    debugAllRoles(); // لرؤية الرتب المتاحة
    
    currentEditingRole = roleKey;
    const allRoles = getAllRoles();
    const role = allRoles[roleKey];
    
    console.log("الرتبة المطلوبة:", roleKey, "تم العثور عليها:", role);
    
    if (!role) {
        console.error(`الرتبة ${roleKey} غير موجودة في:`);
        console.log(allRoles);
        
        // محاولة العثور على الرتبة بطرق أخرى
        for (const [key, r] of Object.entries(allRoles)) {
            if (r && r.name === roleKey) {
                console.log(`وجدت الرتبة باسم: ${key}`);
                role = r;
                currentEditingRole = key;
                break;
            }
        }
        
        if (!role) {
            alert(`الرتبة ${roleKey} غير موجودة`);
            return;
        }
    }
    
    // الباقي من الكود...
}

function getAllRoles() {
    try {
        // تأكد من وجود customRoles
        if (!customRoles) {
            customRoles = {};
            console.warn("customRoles غير معرف، تم تهيئته ككائن فارغ");
        }
        
        // تأكد من وجود rolePermissions
        if (!rolePermissions) {
            console.error("rolePermissions غير معرف!");
            return { employee: { name: "موظف عادي", permissions: {} } };
        }
        
        const mergedRoles = { ...rolePermissions, ...customRoles };
        console.log("تم دمج الرتب:", Object.keys(mergedRoles));
        return mergedRoles;
    } catch (error) {
        console.error("خطأ في getAllRoles:", error);
        return { employee: { name: "موظف عادي", permissions: {} } };
    }
}


function editRole(roleKey) {
    try {
        console.log("=== بدء تحرير الرتبة ===");
        console.log("مفتاح الرتبة المطلوب:", roleKey);
        
        // تسجيل للتصحيح
        debugAllRoles();
        
        // تنظيف مفتاح الرتبة (إزالة علامات التنصيص الإضافية)
        roleKey = roleKey.replace(/['"]/g, '');
        console.log("مفتاح الرتبة بعد التنظيف:", roleKey);
        
        currentEditingRole = roleKey;
        const allRoles = getAllRoles();
        
        console.log("الرتبة في القائمة:", allRoles[roleKey]);
        
        if (!allRoles[roleKey]) {
            // محاولة إيجاد الرتبة بمطابقة جزئية
            console.log("البحث عن الرتبة بمطابقة جزئية...");
            for (const key in allRoles) {
                if (key.includes(roleKey) || roleKey.includes(key)) {
                    console.log(`وجدت مطابقة: ${key}`);
                    roleKey = key;
                    currentEditingRole = key;
                    break;
                }
            }
        }
        
        const role = allRoles[roleKey];
        
        if (!role) {
            // استخدام رتبة افتراضية
            console.error(`الرتبة ${roleKey} غير موجودة، استخدام الموظف العادي كافتراضي`);
            const defaultRole = allRoles.employee || {
                name: "موظف عادي",
                permissions: rolePermissions.employee.permissions
            };
            
            currentEditingRole = 'employee';
            
            // تحديث واجهة التعديل بالرتبة الافتراضية
            updateRoleEditUI(defaultRole);
            return;
        }
        
        // تحديث واجهة التعديل
        updateRoleEditUI(role);
        
        // تحديث زر الحذف
        updateDeleteButton(roleKey);
        
        // تحديث قائمة الرتب
        updateRoleListSelection(roleKey);
        
    } catch (error) {
        console.error('خطأ في editRole:', error);
        alert('حدث خطأ في تحميل الرتبة');
    }
}

function updateRoleEditUI(role) {
    document.getElementById('editRoleName').value = role.name || role.key || 'غير معروف';
    document.getElementById('editingRoleTitle').textContent = `تعديل صلاحيات: ${role.name || 'غير معروف'}`;
    
    let permissionsHtml = '';
    for (const key in permissionNames) {
        const hasPermission = role.permissions ? (role.permissions[key] === true) : false;
        permissionsHtml += `
            <div class="flex items-center justify-between p-2 border-b border-gray-200">
                <span>${permissionNames[key]}</span>
                <input type="checkbox" 
                       id="perm_${key}" 
                       ${hasPermission ? 'checked' : ''}
                       class="w-5 h-5 rounded text-blue-600">
            </div>
        `;
    }
    
    document.getElementById('rolePermissionsList').innerHTML = permissionsHtml;
}

function updateDeleteButton(roleKey) {
    const deleteBtn = document.getElementById('deleteRoleBtn');
    if (deleteBtn) {
        const isCustomRole = customRoles && customRoles[roleKey];
        deleteBtn.disabled = !isCustomRole;
        deleteBtn.title = isCustomRole ? "حذف الرتبة المخصصة" : "لا يمكن حذف الرتبة الأساسية";
    }
}

function updateRoleListSelection(roleKey) {
    document.querySelectorAll('#rolesList .role-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // البحث عن العنصر باستخدام selector أكثر أماناً
    const selector = `[onclick*="${roleKey}"]`;
    const selectedItem = document.querySelector(selector);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    } else {
        console.warn("لم يتم العثور على العنصر المحدد:", selector);
    }
}







function safeGetRole(roleKey) {
    const allRoles = getAllRoles();
    if (allRoles[roleKey]) {
        return allRoles[roleKey];
    }
    
    // إذا لم توجد الرتبة، ارجع رتبة الموظف العادي كافتراضي
    return allRoles.employee || {
        name: "موظف عادي",
        permissions: rolePermissions.employee.permissions
    };
}


function loadRolesList() {
    try {
        const rolesList = document.getElementById('rolesList');
        if (!rolesList) {
            console.error("عنصر rolesList غير موجود");
            return;
        }
        
        let html = '';
        
        const allRoles = getAllRoles();
        console.log("تحميل الرتب للقائمة:", Object.keys(allRoles));
        
        if (Object.keys(allRoles).length === 0) {
            html = '<div class="text-red-500 p-4">لا توجد رتب متاحة</div>';
        } else {
            Object.entries(allRoles).forEach(([roleKey, role]) => {
                if (!role) {
                    console.warn(`الرتبة ${roleKey} غير معرفة، تخطي...`);
                    return;
                }
                
                const isSelected = currentEditingRole === roleKey;
                const isCustom = customRoles && customRoles[roleKey];
                
                // إنشاء onclick آمن
                const safeOnClick = `safeEditRole('${roleKey.replace(/'/g, "\\'")}')`;
                
                html += `
                    <div class="role-item ${isSelected ? 'selected' : ''}" 
                         onclick="${safeOnClick}">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-lg">${role.name || roleKey}</h4>
                                <div class="flex gap-2 items-center">
                                    <p class="text-sm text-gray-500">${roleKey}</p>
                                    ${isCustom ? 
                                        '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">مخصصة</span>' : 
                                        '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">أساسية</span>'}
                                </div>
                            </div>
                            <span class="${isSelected ? 'text-white' : 'text-blue-500'}">
                                <i class="fas fa-chevron-left"></i>
                            </span>
                        </div>
                    </div>
                `;
            });
        }
        
        rolesList.innerHTML = html;
        
        // تحميل الرتبة الأولى افتراضياً
        const allRoleKeys = Object.keys(allRoles);
        if (allRoleKeys.length > 0 && !currentEditingRole) {
            const firstRole = allRoleKeys[0];
            currentEditingRole = firstRole;
            editRole(firstRole);
        }
        
    } catch (error) {
        console.error('خطأ في تحميل قائمة الرتب:', error);
        document.getElementById('rolesList').innerHTML = `
            <div class="text-red-500 p-4">
                خطأ في تحميل قائمة الرتب: ${error.message}
            </div>
        `;
    }
}

// في بداية السكربت

// تأكد من تعريف rolePermissions
const rolePermissions = {
    employee: {
        name: "موظف عادي",
        badgeClass: "role-badge-employee",
        permissions: {
            // ... الصلاحيات ...
        }
    },
    supervisor: {
        name: "مشرف",
        badgeClass: "role-badge-manager",
        permissions: {
            // ... الصلاحيات ...
        }
    },
    manager: {
        name: "مدير قسم",
        badgeClass: "role-badge-manager",
        permissions: {
            // ... الصلاحيات ...
        }
    },
    admin: {
        name: "مدير نظام",
        badgeClass: "role-badge-admin",
        permissions: {
            // ... الصلاحيات ...
        }
    }
};

// في loadData()
function loadData() {
    try {
        // ... تحميل البيانات الأخرى ...
        
        // تحميل الرتب المخصصة
        const savedCustomRoles = localStorage.getItem('attendance_custom_roles');
        if (savedCustomRoles) {
            customRoles = JSON.parse(savedCustomRoles);
            console.log("تم تحميل الرتب المخصصة:", Object.keys(customRoles));
        } else {
            customRoles = {};
            console.log("لا توجد رتب مخصصة، تم تهيئة كائن فارغ");
        }
        
        // ... بقية الكود ...
        
    } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        // التهيئة الافتراضية
        users = [];
        sessions = [];
        requests = [];
        logs = [];
        promotions = [];
        customRoles = {};
        createAdminOnly();
    }
}


// دالة آمنة لتحرير الرتب
function safeEditRole(roleKey) {
    try {
        editRole(roleKey);
    } catch (error) {
        console.error('خطأ في safeEditRole:', error);
        alert('حدث خطأ في تحميل الرتبة');
    }
}

        promotions.push(promotion);
        saveData();
        
        // إعادة تعيين الحقول
        document.getElementById('selectEmployee').value = '';
        document.getElementById('employeeCurrentRank').value = '';
        document.getElementById('assignNewRank').value = '';
        document.getElementById('rankChangeReason').value = '';
        
        // تحديث البيانات
        loadPromotionHistory();
        loadAdminUsersTable();
        loadEmployeeSelect();
        
        showToast('تم تعيين الرتبة بنجاح!', 'success');
    } catch (error) {
        console.error('خطأ في تعيين الرتبة:', error);
        alert('حدث خطأ في تعيين الرتبة');
    }
}



document.addEventListener('DOMContentLoaded', function() {
    // ... الكود الحالي ...
    
    // أضف هذا الكود:
    const addRoleForm = document.getElementById('addRoleForm');
    if (addRoleForm) {
        addRoleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            addNewRole();
        });
    }
    
    // تأكد من تحميل الرتب عند التهيئة
    if (document.getElementById('rolesList')) {
        loadRolesList();
    }
});


        
        // ===== البحث في الجداول =====
        document.getElementById('searchUsers')?.addEventListener('input', function(e) {
            loadAdminUsersTable();
        });
        
        document.getElementById('searchAttendance')?.addEventListener('input', function(e) {
            try {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#adminAttendanceTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 8) return;
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } catch (error) {
                console.error('خطأ في البحث:', error);
            }
        });
        
        // ===== الوضع الليلي =====
        let isDarkMode = false;
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            updateDarkModeUI();
        }
        
        function updateDarkModeUI() {
            const toggleBtn = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                toggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                toggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // ===== تهيئة النظام =====
        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadData();
                updatePermissionsForm();
                
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    
                    if (currentUser.role === 'admin') {
                        currentUser.permissions = rolePermissions.admin.permissions;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    currentSession = sessions.find(s => s.userId === currentUser.id && !s.logoutTime);
                    
                    document.getElementById('mainPage').classList.add('hidden');
                    
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminPanel').classList.remove('hidden');
                        updateAdminPanel();
                    } else {
                        document.getElementById('userPanel').classList.remove('hidden');
                        updateUserPanel();
                    }
                }
                
                // إعداد تواريخ الإجازة والاستقالة
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                if (document.getElementById('leaveStartDate')) {
                    document.getElementById('leaveStartDate').valueAsDate = tomorrow;
                    document.getElementById('leaveStartDate').min = tomorrow.toISOString().split('T')[0];
                }
                
                if (document.getElementById('resignEndDate')) {
                    document.getElementById('resignEndDate').valueAsDate = tomorrow;
                    document.getElementById('resignEndDate').min = tomorrow.toISOString().split('T')[0];
                }
                
                // تحديث الوقت الحالي كل ثانية
                setInterval(updateCurrentTime, 1000);
                
                // إعداد الأحداث
                document.getElementById('searchUsers')?.addEventListener('input', function() {
                    loadAdminUsersTable();
                });
                










                
                // الوضع الليلي
                const savedMode = localStorage.getItem('darkMode');
                if (savedMode === 'true') {
                    isDarkMode = true;
                }
                
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('click', toggleDarkMode);
                    updateDarkModeUI();
                }
                
                // إعداد نموذج طلب الترقية
                document.getElementById('promotionForm')?.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitPromotionRequest();
                });
                
                // إعداد نموذج إضافة رتبة
                document.getElementById('addRoleForm')?.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('newRoleName').value.trim();
                    const key = document.getElementById('newRoleKey').value.trim();
                    
                    if (!name || !key) {
                        showAlert('يرجى ملء جميع الحقول', 'error');
                        return;
                    }
                    
                    if (rolePermissions[key]) {
                        showAlert('مفتاح الرتبة موجود مسبقاً', 'error');
                        return;
                    }
                    
                    // في هذا النظام المبسط، لن نقوم بإضافة رتب مخصصة حالياً
                    document.getElementById('newRoleName').value = '';
                    document.getElementById('newRoleKey').value = '';
                });
            } catch (error) {
                console.error('خطأ في تهيئة النظام:', error);
            }
        });

// ==============================================
// ===== الحل النهائي لمشكلة الرتب =====
// ==============================================

// دالة أمان لتحرير الرتب (تحل جميع المشاكل)
function safeEditRole(roleKey) {
    try {
        console.log("🔍 محاولة تحرير الرتبة:", roleKey);
        
        // تنظيف مفتاح الرتبة
        roleKey = roleKey.replace(/['"]/g, '');
        
        // محاولة 1: البحث في rolePermissions
        let role = rolePermissions ? rolePermissions[roleKey] : null;
        let source = 'rolePermissions';
        
        // محاولة 2: البحث في customRoles
        if (!role && customRoles) {
            role = customRoles[roleKey];
            source = 'customRoles';
        }
        
        // محاولة 3: البحث في baseRoles (إذا كان موجوداً)
        if (!role && typeof baseRoles !== 'undefined') {
            role = baseRoles[roleKey];
            source = 'baseRoles';
        }
        
        // محاولة 4: البحث في جميع المتغيرات
        if (!role) {
            console.log("🔎 البحث في جميع المتغيرات...");
            
            // جمع كل الرتب من جميع المصادر
            const allRoles = {};
            
            // من rolePermissions
            if (rolePermissions) {
                for (const key in rolePermissions) {
                    if (rolePermissions[key]) {
                        allRoles[key] = rolePermissions[key];
                    }
                }
            }
            
            // من customRoles
            if (customRoles) {
                for (const key in customRoles) {
                    if (customRoles[key]) {
                        allRoles[key] = customRoles[key];
                    }
                }
            }
            
            // من baseRoles
            if (typeof baseRoles !== 'undefined') {
                for (const key in baseRoles) {
                    if (baseRoles[key]) {
                        allRoles[key] = baseRoles[key];
                    }
                }
            }
            
            console.log("📊 جميع الرتب المتاحة:", Object.keys(allRoles));
            
            // محاولة العثور على الرتبة
            role = allRoles[roleKey];
            
            // إذا لم توجد، جرب أول رتبة متاحة
            if (!role && Object.keys(allRoles).length > 0) {
                const firstKey = Object.keys(allRoles)[0];
                role = allRoles[firstKey];
                roleKey = firstKey;
                console.log("🔄 استخدام أول رتبة متاحة:", firstKey);
            }
        }
        
        // إذا لم نجد الرتبة
        if (!role) {
            console.error("❌ الرتبة غير موجودة في أي مصدر:", roleKey);
            alert("عذراً، هذه الرتبة غير موجودة في النظام");
            return;
        }
        
        console.log("✅ وجدت الرتبة:", role.name, "من:", source);
        
        // تحديث المتغير العام
        currentEditingRole = roleKey;
        
        // تحديث واجهة التحرير
        updateRoleEditInterface(role, roleKey);
        
        // تحديث زر الحذف
        updateDeleteButtonSafe(roleKey);
        
        // تحديث التحديد في القائمة
        updateRoleListSelectionSafe(roleKey);
        
    } catch (error) {
        console.error("💥 خطأ في safeEditRole:", error);
        alert("حدث خطأ غير متوقع: " + error.message);
    }
}

// تحديث واجهة التحرير (نسخة محسنة)
function updateRoleEditInterface(role, roleKey) {
    try {
        document.getElementById('editRoleName').value = role.name || roleKey || "غير معروف";
        document.getElementById('editingRoleTitle').textContent = `تعديل صلاحيات: ${role.name || roleKey || "غير معروف"}`;
        
        let permissionsHtml = '';
        
        // استخدام permissionNames الموجود
        for (const key in permissionNames) {
            const hasPermission = role.permissions ? (role.permissions[key] === true) : false;
            permissionsHtml += `
                <div class="flex items-center justify-between p-2 border-b border-gray-200">
                    <span>${permissionNames[key]}</span>
                    <input type="checkbox" 
                           id="perm_${key}" 
                           ${hasPermission ? 'checked' : ''}
                           class="w-5 h-5 rounded text-blue-600">
                </div>
            `;
        }
        
        document.getElementById('rolePermissionsList').innerHTML = permissionsHtml;
        
    } catch (error) {
        console.error("❌ خطأ في updateRoleEditInterface:", error);
        document.getElementById('rolePermissionsList').innerHTML = `
            <div class="text-red-500 p-3">
                خطأ في تحميل الصلاحيات: ${error.message}
            </div>
        `;
    }
}

// تحديث زر الحذف (نسخة محسنة)
function updateDeleteButtonSafe(roleKey) {
    try {
        const deleteBtn = document.getElementById('deleteRoleBtn');
        if (deleteBtn) {
            // التحقق من جميع المصادر المحتملة
            let isCustomRole = false;
            
            if (customRoles && customRoles[roleKey]) {
                isCustomRole = true;
            } else if (typeof baseRoles !== 'undefined' && baseRoles[roleKey]) {
                // إذا كانت في baseRoles، فهي ليست مخصصة
                isCustomRole = false;
            } else if (rolePermissions && rolePermissions[roleKey]) {
                // إذا كانت في rolePermissions، فهي أساسية
                isCustomRole = false;
            }
            
            deleteBtn.disabled = !isCustomRole;
            deleteBtn.title = isCustomRole ? "حذف الرتبة المخصصة" : "لا يمكن حذف الرتبة الأساسية";
        }
    } catch (error) {
        console.error("❌ خطأ في updateDeleteButtonSafe:", error);
    }
}

// تحديث التحديد في القائمة (نسخة محسنة)
function updateRoleListSelectionSafe(roleKey) {
    try {
        // إزالة التحديد من جميع العناصر
        document.querySelectorAll('#rolesList .role-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // البحث بالدقة عن العنصر
        const items = document.querySelectorAll('#rolesList .role-item');
        for (let item of items) {
            const onclickAttr = item.getAttribute('onclick');
            if (onclickAttr) {
                // تنظيف الـ onclick للبحث
                const cleanOnClick = onclickAttr.replace(/['"]/g, '');
                if (cleanOnClick.includes(roleKey)) {
                    item.classList.add('selected');
                    console.log("✓ تم تحديد العنصر:", roleKey);
                    break;
                }
            }
        }
    } catch (error) {
        console.error("❌ خطأ في updateRoleListSelectionSafe:", error);
    }
}

// دالة لتحميل قائمة الرتب بشكل آمن
function loadRolesListSafe() {
    try {
        const rolesList = document.getElementById('rolesList');
        if (!rolesList) {
            console.error("❌ عنصر rolesList غير موجود");
            return;
        }
        
        // جمع جميع الرتب من جميع المصادر
        const allRoles = {};
        
        // 1. من rolePermissions
        if (rolePermissions) {
            for (const key in rolePermissions) {
                if (rolePermissions[key] && rolePermissions[key].name) {
                    allRoles[key] = rolePermissions[key];
                }
            }
        }
        
        // 2. من customRoles
        if (customRoles) {
            for (const key in customRoles) {
                if (customRoles[key] && customRoles[key].name) {
                    allRoles[key] = customRoles[key];
                }
            }
        }
        
        // 3. من baseRoles (إذا كان موجوداً)
        if (typeof baseRoles !== 'undefined') {
            for (const key in baseRoles) {
                if (baseRoles[key] && baseRoles[key].name) {
                    allRoles[key] = baseRoles[key];
                }
            }
        }
        
        console.log("📊 الرتب المجمعة:", Object.keys(allRoles));
        
        if (Object.keys(allRoles).length === 0) {
            rolesList.innerHTML = '<div class="text-yellow-500 p-4">لا توجد رتب في النظام</div>';
            return;
        }
        
        let html = '';
        
        Object.entries(allRoles).forEach(([roleKey, role]) => {
            if (!role) return;
            
            // تحديد مصدر الرتبة
            let isCustom = false;
            let badgeText = "أساسية";
            let badgeClass = "bg-blue-100 text-blue-800";
            
            if (customRoles && customRoles[roleKey]) {
                isCustom = true;
                badgeText = "مخصصة";
                badgeClass = "bg-green-100 text-green-800";
            }
            
            html += `
                <div class="role-item" onclick="safeEditRole('${roleKey.replace(/'/g, "\\'")}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-lg text-gray-800">${role.name || roleKey}</h4>
                            <div class="flex gap-2 items-center mt-1">
                                <p class="text-sm text-gray-500">${roleKey}</p>
                                <span class="text-xs ${badgeClass} px-2 py-1 rounded">
                                    ${badgeText}
                                </span>
                            </div>
                        </div>
                        <span class="text-blue-500">
                            <i class="fas fa-chevron-left"></i>
                        </span>
                    </div>
                </div>
            `;
        });
        
        rolesList.innerHTML = html;
        
        // تحميل أول رتبة تلقائياً
        const firstRoleKey = Object.keys(allRoles)[0];
        if (firstRoleKey) {
            setTimeout(() => {
                safeEditRole(firstRoleKey);
            }, 100);
        }
        
    } catch (error) {
        console.error('💥 خطأ في loadRolesListSafe:', error);
        document.getElementById('rolesList').innerHTML = `
            <div class="text-red-500 p-4 border border-red-300 rounded-lg">
                <p class="font-bold">❌ خطأ في تحميل الرتب</p>
                <p class="text-sm">${error.message}</p>
                <button onclick="loadRolesListSafe()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">
                    إعادة المحاولة
                </button>
            </div>
        `;
    }
}

// ==============================================
// ===== استبدال الدوال القديمة =====
// ==============================================

// استبدال loadRolesList بالدالة الجديدة
const originalLoadRolesList = window.loadRolesList;
window.loadRolesList = function() {
    console.log("🔄 استخدام loadRolesListSafe بدلاً من الأصلية");
    loadRolesListSafe();
};

// استبدال editRole بالدالة الجديدة
const originalEditRole = window.editRole;
window.editRole = function(roleKey) {
    console.log("🔄 استخدام safeEditRole بدلاً من الأصلية");
    safeEditRole(roleKey);
};

// ==============================================
// ===== تهيئة النظام بعد التحميل =====
// ==============================================

// الانتظار حتى تحميل الصفحة بالكامل
window.addEventListener('load', function() {
    console.log("✅ الصفحة محملة، تهيئة نظام الرتب...");
    
    // تأخير بسيط للتأكد من تحميل كل شيء
    setTimeout(() => {
        // إذا كنا في صفحة المدير
        if (document.getElementById('rolesList')) {
            console.log("🎯 تحميل قائمة الرتب...");
            loadRolesListSafe();
            
            // أيضاً تحميل القوائم المنسدلة
            if (typeof loadRankSelect === 'function') {
                loadRankSelect();
            }
            if (typeof loadEmployeeSelect === 'function') {
                loadEmployeeSelect();
            }
        }
    }, 1000);
});

// إصلاح النقر على الرتب الموجودة
document.addEventListener('click', function(event) {
    // إذا تم النقر على role-item ولم يستجب
    if (event.target.closest('.role-item')) {
        const roleItem = event.target.closest('.role-item');
        const onclickAttr = roleItem.getAttribute('onclick');
        
        if (onclickAttr) {
            // استخراج مفتاح الرتبة من الـ onclick
            const match = onclickAttr.match(/['"]([^'"]+)['"]/);
            if (match && match[1]) {
                event.preventDefault();
                event.stopPropagation();
                safeEditRole(match[1]);
            }
        }
    }
});

console.log("🔧 نظام الرتب الآمن جاهز للعمل!");












function addNewRole() {
    try {
        const name = document.getElementById('newRoleName').value.trim();
        const key = document.getElementById('newRoleKey').value.trim();
        
        if (!name || !key) {
            showAlert('يرجى ملء جميع الحقول', 'error');
            return;
        }
        
        const allRoles = getAllRoles();
        if (allRoles[key]) {
            showAlert('مفتاح الرتبة موجود مسبقاً', 'error');
            return;
        }
        
        const newRole = {
            name: name,
            badgeClass: "role-badge-custom",
            permissions: {
                attendance: true,
                leave: true,
                resign: true,
                viewHistory: true,
                viewStats: true,
                viewTeamAttendance: false,
                viewTeamRequests: false,
                addUsers: false,
                editPermissions: false,
                viewAllAttendance: false,
                processRequests: false,
                viewReports: false,
                deleteUsers: false,
                requestPromotion: false
            }
        };
        
        customRoles[key] = newRole;
        saveData();
        
        // تحديث الواجهة
        document.getElementById('newRoleName').value = '';
        document.getElementById('newRoleKey').value = '';
        closeModal('addRoleModal');
        showToast('تم إضافة الرتبة الجديدة بنجاح!', 'success');
        
        // تحديث القوائم
        if (document.getElementById('rolesList')) {
            loadRolesList();
        }
        if (document.getElementById('assignNewRank')) {
            loadRankSelect();
        }
    } catch (error) {
        console.error('خطأ في إضافة رتبة جديدة:', error);
        showAlert('حدث خطأ في إضافة الرتبة الجديدة', 'error');
    }
}







function getAllRoles() {
    // دمج الرتب الأساسية مع المخصصة
    return { ...rolePermissions, ...customRoles };
}






function saveRolePermissions() {
    if (!currentEditingRole) return;
    
    const roleKey = currentEditingRole;
    const allRoles = getAllRoles();
    const role = allRoles[roleKey];
    
    if (!role) {
        alert('الرتبة غير موجودة');
        return;
    }
    
    // تحديث الصلاحيات
    for (const key in permissionNames) {
        const checkbox = document.getElementById(`perm_${key}`);
        role.permissions[key] = checkbox.checked;
    }
    
    // حفظ في المكان المناسب
    if (rolePermissions[roleKey]) {
        rolePermissions[roleKey].permissions = { ...role.permissions };
    } else if (customRoles[roleKey]) {
        customRoles[roleKey].permissions = { ...role.permissions };
    }
    
    // تحديث المستخدمين
    users.forEach(user => {
        if (user.role === roleKey) {
            user.permissions = { ...role.permissions };
        }
    });
    
    saveData();
    
    // تحديث المستخدم الحالي إذا لزم الأمر
    if (currentUser && currentUser.role === roleKey) {
        currentUser.permissions = { ...role.permissions };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateUserInterface();
    }
    
    showToast('تم تحديث صلاحيات الرتبة بنجاح!', 'success');
}




function deleteRole() {
    if (!currentEditingRole) return;
    
    const roleKey = currentEditingRole;
    
    // لا يمكن حذف الرتب الأساسية
    if (rolePermissions[roleKey]) {
        alert('لا يمكن حذف الرتب الأساسية. يمكنك فقط تعديل صلاحياتها.');
        return;
    }
    
    // التحقق إذا كانت رتبة مخصصة
    if (customRoles[roleKey]) {
        if (confirm(`هل أنت متأكد من حذف الرتبة "${customRoles[roleKey].name}"؟`)) {
            // التحقق من وجود مستخدمين
            const usersWithThisRole = users.filter(u => u.role === roleKey);
            
            if (usersWithThisRole.length > 0) {
                alert(`لا يمكن حذف الرتبة لأن ${usersWithThisRole.length} موظف يستخدمونها. قم بتغيير رتبتهم أولاً.`);
                return;
            }
            
            // حذف الرتبة
            delete customRoles[roleKey];
            currentEditingRole = null;
            saveData();
            
            // تحديث الواجهة
            document.getElementById('editRoleName').value = '';
            document.getElementById('editingRoleTitle').textContent = 'تعديل صلاحيات الرتبة';
            document.getElementById('rolePermissionsList').innerHTML = '';
            document.getElementById('deleteRoleBtn').disabled = true;
            
            loadRolesList();
            loadRankSelect();
            
            showToast('تم حذف الرتبة بنجاح!', 'success');
        }
    }
}

function saveData() {
    localStorage.setItem('attendance_users', JSON.stringify(users));
    localStorage.setItem('attendance_sessions', JSON.stringify(sessions));
    localStorage.setItem('attendance_requests', JSON.stringify(requests));
    localStorage.setItem('attendance_logs', JSON.stringify(logs));
    localStorage.setItem('attendance_promotions', JSON.stringify(promotions));
    localStorage.setItem('attendance_custom_roles', JSON.stringify(customRoles)); // جديد
}

function loadData() {
    try {
        users = JSON.parse(localStorage.getItem('attendance_users') || '[]');
        sessions = JSON.parse(localStorage.getItem('attendance_sessions') || '[]');
        requests = JSON.parse(localStorage.getItem('attendance_requests') || '[]');
        logs = JSON.parse(localStorage.getItem('attendance_logs') || '[]');
        promotions = JSON.parse(localStorage.getItem('attendance_promotions') || '[]');
        customRoles = JSON.parse(localStorage.getItem('attendance_custom_roles') || '{}'); // جديد
        
        if (users.length === 0) {
            createAdminOnly();
        }
    } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        createAdminOnly();
    }
}


function loadRankSelect() {
    const rankSelect = document.getElementById('assignNewRank');
    if (!rankSelect) return;
    
    rankSelect.innerHTML = '<option value="">-- اختر الرتبة --</option>';
    const allRoles = getAllRoles();
    
    Object.entries(allRoles).forEach(([key, role]) => {
        rankSelect.innerHTML += `<option value="${key}">${role.name}</option>`;
    });
}


// ... كل الكود السابق ...

// ===== تهيئة النظام بعد التحميل =====
window.addEventListener('load', function() {
    console.log("✅ الصفحة محملة، تهيئة نظام الرتب...");
    
    setTimeout(() => {
        if (document.getElementById('rolesList')) {
            console.log("🎯 تحميل قائمة الرتب...");
            loadRolesListSafe();
            
            if (typeof loadRankSelect === 'function') {
                loadRankSelect();
            }
            if (typeof loadEmployeeSelect === 'function') {
                loadEmployeeSelect();
            }
        }
    }, 1000);
});

// إصلاح النقر على الرتب الموجودة
document.addEventListener('click', function(event) {
    if (event.target.closest('.role-item')) {
        const roleItem = event.target.closest('.role-item');
        const onclickAttr = roleItem.getAttribute('onclick');
        
        if (onclickAttr) {
            const match = onclickAttr.match(/['"]([^'"]+)['"]/);
            if (match && match[1]) {
                event.preventDefault();
                event.stopPropagation();
                safeEditRole(match[1]);
            }
        }
    }
});

console.log("🔧 نظام الرتب الآمن جاهز للعمل!");

// ===== المتغيرات النهائية =====







// أزل هذا الكود كاملاً:
// ===== في بداية السكربت مع المتغيرات الأخرى =====

// ===== تعريف الرتب الأساسية =====
// ===== تعريف الرتب الأساسية =====

// ===== أسماء الصلاحيات =====
// ===== أسماء الصلاحيات =====


// ===== المتغيرات الجديدة =====


function loadData() {
    try {
        users = JSON.parse(localStorage.getItem('attendance_users') || '[]');
        sessions = JSON.parse(localStorage.getItem('attendance_sessions') || '[]');
        requests = JSON.parse(localStorage.getItem('attendance_requests') || '[]');
        logs = JSON.parse(localStorage.getItem('attendance_logs') || '[]');
        promotions = JSON.parse(localStorage.getItem('attendance_promotions') || '[]');
        
        // تحميل الرتب المخصصة
        customRoles = JSON.parse(localStorage.getItem('attendance_custom_roles') || '{}');
        
        if (users.length === 0) {
            createAdminOnly();
        }
    } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        createAdminOnly();
    }
}













</script>
</body>
</html>
