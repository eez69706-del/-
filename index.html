<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الحضور والانصراف الذكي</title>
    
    <!-- مكتبات CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- مكتبة Socket.IO للإشعارات الفورية -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- أنماط مخصصة -->
    <style>
/* ===== متغيرات CSS ===== */
:root {
    --primary: #667eea;
    --primary-light: #8b9cff;
    --primary-dark: #5a67d8;
    --secondary: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    
    /* ألوان الوضع الفاتح */
    --light-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --light-card-bg: rgba(255, 255, 255, 0.95);
    --light-card-border: rgba(255, 255, 255, 0.3);
    --light-text: #1e293b;
    --light-label: #64748b;
    --light-input-bg: rgba(255, 255, 255, 0.95);
    --light-input-border: rgba(102, 126, 234, 0.2);
    --light-table-bg: rgba(255, 255, 255, 0.95);
    --light-table-border: rgba(255, 255, 255, 0.3);
    
    /* ألوان الوضع المظلم */
    --dark-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    --dark-card-bg: rgba(30, 41, 59, 0.9);
    --dark-card-border: rgba(255, 255, 255, 0.1);
    --dark-text: #e2e8f0;
    --dark-label: #94a3b8;
    --dark-input-bg: rgba(30, 41, 59, 0.9);
    --dark-input-border: rgba(255, 255, 255, 0.1);
    --dark-table-bg: rgba(30, 41, 59, 0.9);
    --dark-table-border: rgba(255, 255, 255, 0.1);
    
    /* متغيرات ديناميكية */
    --current-bg: var(--light-bg);
    --current-card-bg: var(--light-card-bg);
    --current-card-border: var(--light-card-border);
    --current-text: var(--light-text);
    --current-label: var(--light-label);
    --current-input-bg: var(--light-input-bg);
    --current-input-border: var(--light-input-border);
    --current-table-bg: var(--light-table-bg);
    --current-table-border: var(--light-table-border);
    --glass-bg: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
}

/* ===== إعادة الضبط الأساسي ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Cairo', sans-serif;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
}

html {
    scroll-behavior: smooth;
}

body {
    background: var(--current-bg);
    min-height: 100vh;
    position: relative;
    transition: all 0.5s ease;
    overflow-x: hidden;
    color: var(--current-text);
    line-height: 1.6;
}

/* ===== تأثيرات الخلفية ===== */
body::before {
    content: '';
    position: fixed;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: 
        radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.3) 0%, transparent 50%);
    animation: rotate 20s linear infinite;
    pointer-events: none;
    z-index: -2;
}

body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
    pointer-events: none;
    z-index: -1;
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ===== الحاوية الرئيسية ===== */
.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 1;
}

/* ===== البطاقات الزجاجية ===== */
.stat-card {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    padding: 35px;
    border-radius: 24px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    text-align: center;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--current-card-border);
    color: var(--current-text);
    margin-bottom: 30px;
}

.stat-card:hover::before {
    left: 100%;
}

.stat-card::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.5s;
}

.stat-card:hover::after {
    opacity: 1;
}

.stat-card:hover {
    transform: translateY(-15px) scale(1.03) rotateX(5deg);
    box-shadow: 
        0 20px 60px rgba(102, 126, 234, 0.3),
        0 0 0 1px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

.stat-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.3));
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(5deg); }
}

.stat-number {
    font-size: 3.5rem;
    font-weight: 900;
    margin: 20px 0;
    background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 50%, #f59e0b 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    position: relative;
}

.stat-label {
    color: var(--current-label);
    font-size: 1.1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    position: relative;
}

/* ===== الأزرار الحديثة ===== */
.btn {
    padding: 16px 32px;
    border-radius: 16px;
    border: none;
    cursor: pointer;
    font-weight: 800;
    font-size: 1rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    color: white !important;
    text-decoration: none;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
    width: 300px;
    height: 300px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 
        0 8px 20px rgba(102, 126, 234, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-primary:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(102, 126, 234, 0.5),
        0 0 0 1px rgba(102, 126, 234, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    box-shadow: 
        0 8px 20px rgba(16, 185, 129, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-success:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(16, 185, 129, 0.5),
        0 0 0 1px rgba(16, 185, 129, 0.3);
}

.btn-danger {
    background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    box-shadow: 
        0 8px 20px rgba(239, 68, 68, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-danger:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(239, 68, 68, 0.5),
        0 0 0 1px rgba(239, 68, 68, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
    box-shadow: 
        0 8px 20px rgba(245, 158, 11, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-warning:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(245, 158, 11, 0.5),
        0 0 0 1px rgba(245, 158, 11, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    box-shadow: 
        0 8px 20px rgba(107, 114, 128, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 
        0 12px 30px rgba(107, 114, 128, 0.5),
        0 0 0 1px rgba(107, 114, 128, 0.3);
}

.btn-sm {
    padding: 10px 20px;
    font-size: 0.875rem;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(1);
}

.btn:disabled:hover {
    transform: none;
}

/* ===== الإدخالات الزجاجية ===== */
.input-group {
    margin-bottom: 24px;
    position: relative;
}

.input-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 800;
    color: var(--current-text);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

input, textarea, select {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid var(--current-input-border);
    border-radius: 16px;
    font-size: 1rem;
    transition: all 0.4s;
    background: var(--current-input-bg);
    backdrop-filter: blur(10px);
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    color: var(--current-text);
}

input::placeholder,
textarea::placeholder,
select option {
    color: var(--current-label);
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 
        0 0 0 4px rgba(102, 126, 234, 0.15),
        0 8px 20px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
}

/* ===== الجداول الحديثة ===== */
.table-container {
    overflow-x: auto;
    border-radius: 20px;
    box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    background: var(--current-table-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--current-table-border);
    margin-bottom: 30px;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 600px;
}

th {
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    color: white !important;
    padding: 20px;
    text-align: right;
    font-weight: 900;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
}

th:first-child {
    border-top-right-radius: 20px;
}

th:last-child {
    border-top-left-radius: 20px;
}

td {
    padding: 18px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s;
    background: transparent;
    color: var(--current-text) !important;
}

tr:last-child td {
    border-bottom: none;
}

tr:hover td {
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, transparent 100%);
    transform: translateX(-5px);
}

/* ===== الشارات الحديثة ===== */
.badge {
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 900;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    color: white !important;
}

.badge-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.badge-warning {
    background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
}

.badge-danger {
    background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
}

.badge-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

/* ===== التنبيهات الحديثة ===== */
.alert {
    padding: 18px 24px;
    border-radius: 16px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    font-weight: 700;
    box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-right: 5px solid;
    backdrop-filter: blur(10px);
    color: var(--current-text) !important;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.alert-success {
    background: linear-gradient(135deg, rgba(17, 153, 142, 0.15) 0%, rgba(56, 239, 125, 0.15) 100%);
    border-color: var(--secondary);
}

.alert-error {
    background: linear-gradient(135deg, rgba(238, 9, 121, 0.15) 0%, rgba(255, 106, 0, 0.15) 100%);
    border-color: var(--danger);
}

.alert-info {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.15) 100%);
    border-color: var(--info);
}

/* ===== النوافذ المنبثقة الحديثة ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(15px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.4s ease;
}

.modal.active {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    padding: 35px;
    border-radius: 24px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 0 1px var(--current-card-border);
    animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid var(--current-card-border);
    color: var(--current-text) !important;
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.7) translateY(30px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-close {
    position: absolute;
    top: 20px;
    left: 20px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--current-text);
}

/* ===== شاشة التحميل الحديثة ===== */
.loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--current-card-bg);
    backdrop-filter: blur(15px);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading.active {
    display: flex;
}

.spinner {
    width: 70px;
    height: 70px;
    border: 7px solid rgba(0, 0, 0, 0.1);
    border-top: 7px solid var(--primary);
    border-right: 7px solid var(--info);
    border-radius: 50%;
    animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    box-shadow: 
        0 0 30px rgba(102, 126, 234, 0.4),
        inset 0 0 20px rgba(102, 126, 234, 0.1);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ===== التبويبات الحديثة ===== */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 18px 28px;
    border: none;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    cursor: pointer;
    font-weight: 800;
    font-size: 1rem;
    transition: all 0.4s;
    position: relative;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--current-label) !important;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
    border-radius: 16px;
}

.tab-btn::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
    transform: scaleX(0);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 4px 4px 0 0;
}

.tab-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    color: var(--primary) !important;
    transform: translateY(-2px);
}

.tab-btn.active {
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    color: white !important;
    box-shadow: 
        0 4px 12px rgba(102, 126, 234, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.tab-btn.active::after {
    transform: scaleX(1);
}

.tab-content {
    display: none;
    animation: fadeInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.tab-content.active {
    display: block;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== رتب الموظفين الحديثة ===== */
.role-badge {
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 900;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    color: white !important;
}

.role-badge-admin {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.role-badge-manager {
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
}

.role-badge-employee {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

/* ===== عناصر الرتب ===== */
.role-item {
    background: var(--current-card-bg);
    backdrop-filter: blur(10px);
    border: 2px solid var(--current-input-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 12px;
    cursor: pointer;
    color: var(--current-text) !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.role-item:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    transform: translateX(-8px) scale(1.02);
    border-color: var(--primary);
    box-shadow: 
        0 8px 20px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.role-item.selected {
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%) !important;
    color: white !important;
    border-color: var(--primary);
    box-shadow: 
        0 12px 30px rgba(102, 126, 234, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    transform: translateX(-8px) scale(1.05);
}

/* ===== التوست الحديث ===== */
.toast {
    position: fixed;
    top: 30px;
    right: 30px;
    padding: 18px 28px;
    border-radius: 16px;
    color: white !important;
    font-weight: 800;
    z-index: 10000;
    animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.4s ease 2.7s forwards;
    box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    max-width: 400px;
}

.toast-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.toast-error {
    background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
}

.toast-info {
    background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
}

@keyframes slideInRight {
    from {
        transform: translateX(400px) scale(0.8);
        opacity: 0;
    }
    to {
        transform: translateX(0) scale(1);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from { 
        opacity: 1; 
        transform: translateX(0);
    }
    to { 
        opacity: 0; 
        transform: translateX(400px) scale(0.8);
    }
}

/* ===== زر الوضع الليلي الحديث ===== */
#darkModeToggle {
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    color: white !important;
    border: none;
    font-size: 26px;
    z-index: 9999;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 
        0 10px 35px rgba(102, 126, 234, 0.5),
        inset 0 2px 0 rgba(255, 255, 255, 0.3);
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

#darkModeToggle:hover {
    transform: scale(1.2) rotate(180deg);
    box-shadow: 
        0 15px 50px rgba(102, 126, 234, 0.7),
        0 0 0 8px rgba(102, 126, 234, 0.1);
}

/* ===== بطاقات الموظفين ===== */
.employee-card {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    border: 1px solid var(--current-card-border);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    color: var(--current-text) !important;
}

.employee-card:hover {
    transform: translateY(-10px);
    box-shadow: 
        0 15px 40px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

/* ===== التنقل ===== */
.navbar {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    padding: 20px 30px;
    border-radius: 20px;
    margin-bottom: 30px;
    border: 1px solid var(--current-card-border);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    color: var(--current-text) !important;
}

.nav-links {
    display: flex;
    gap: 20px;
    list-style: none;
}

.nav-links a {
    color: var(--current-text) !important;
    text-decoration: none;
    font-weight: 700;
    padding: 10px 20px;
    border-radius: 12px;
    transition: all 0.3s;
}

.nav-links a:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
}

/* ===== الترويسة ===== */
.header {
    text-align: center;
    padding: 40px 0;
    margin-bottom: 40px;
}

.header h1 {
    font-size: 3rem;
    background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 20px;
    color: transparent !important;
}

.header p {
    color: var(--current-label) !important;
    font-size: 1.2rem;
}

/* ===== الشبكة ===== */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
}

/* ===== الفوتر ===== */
.footer {
    text-align: center;
    padding: 30px;
    margin-top: 50px;
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid var(--current-card-border);
    color: var(--current-label) !important;
}

/* ===== الوضع الليلي الكامل ===== */
body.dark-mode {
    --current-bg: var(--dark-bg);
    --current-card-bg: var(--dark-card-bg);
    --current-card-border: var(--dark-card-border);
    --current-text: var(--dark-text);
    --current-label: var(--dark-label);
    --current-input-bg: var(--dark-input-bg);
    --current-input-border: var(--dark-input-border);
    --current-table-bg: var(--dark-table-bg);
    --current-table-border: var(--dark-table-border);
}

/* ===== إصلاح النصوص في الوضع المظلم ===== */
body.dark-mode,
body.dark-mode .stat-label,
body.dark-mode .header p,
body.dark-mode .footer,
body.dark-mode .input-group label,
body.dark-mode .alert,
body.dark-mode .tab-btn:not(.active),
body.dark-mode .role-item:not(.selected),
body.dark-mode .employee-card,
body.dark-mode .stat-card,
body.dark-mode .modal-content,
body.dark-mode .navbar,
body.dark-mode .table-container,
body.dark-mode td,
body.dark-mode input,
body.dark-mode textarea,
body.dark-mode select {
    color: #ffffff !important;
}

/* ===== التجاوب ===== */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .stat-card {
        padding: 25px;
    }
    
    .stat-number {
        font-size: 2.5rem;
    }
    
    .stat-icon {
        font-size: 3rem;
    }
    
    .btn {
        padding: 14px 24px;
        font-size: 0.9rem;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .grid {
        grid-template-columns: 1fr;
    }
    
    .nav-links {
        flex-direction: column;
        gap: 10px;
    }
    
    #darkModeToggle {
        width: 55px;
        height: 55px;
        bottom: 20px;
        left: 20px;
        font-size: 22px;
    }
}

@media (max-width: 480px) {
    .stat-card {
        padding: 20px;
    }
    
    .modal-content {
        padding: 25px;
        width: 95%;
    }
    
    .toast {
        right: 15px;
        left: 15px;
        max-width: none;
    }
}

/* ===== تحسينات إضافية ===== */
.permission-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--current-input-border);
}

.permission-group {
    margin: 20px 0;
}

.report-box {
    background: var(--current-input-bg);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--current-input-border);
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: var(--current-label) !important;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 20px;
    color: var(--primary);
}

.employee-section {
    background: var(--current-card-bg);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--current-card-border);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--current-text) !important;
}

.promotion-history {
    background: var(--current-input-bg);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--current-input-border);
}

/* ===== تصميم زر الرجوع ===== */
.admin-home-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.admin-home-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

/* ===== تصميم زر الرجوع البسيط ===== */
.btn-back {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
    transition: all 0.3s;
}

.btn-back:hover {
    transform: translateX(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* ===== تصميم شريط الإشعارات ===== */
.notifications-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10001;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
}

.notification-item {
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--current-card-border);
    color: var(--current-text);
    animation: slideInRight 0.3s ease;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.notification-item:hover {
    transform: translateX(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
}

.notification-item::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    height: 100%;
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.notification-login { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(56, 239, 125, 0.1) 100%); }
.notification-login::before { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }

.notification-logout { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(255, 106, 0, 0.1) 100%); }
.notification-logout::before { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }

.notification-request { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(255, 210, 0, 0.1) 100%); }
.notification-request::before { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }

.notification-user { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); }
.notification-user::before { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

.notification-admin { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%); }
.notification-admin::before { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.notification-title {
    font-weight: bold;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.notification-time {
    font-size: 0.8rem;
    color: var(--current-label);
}

.notification-message {
    font-size: 0.85rem;
    margin-top: 5px;
}

/* ===== زر الإشعارات في شريط التنقل ===== */
.notifications-btn {
    position: relative;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 5px 10px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.notifications-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* ===== قائمة الإشعارات المنبثقة ===== */
.notifications-dropdown {
    position: absolute;
    top: 40px;
    right: 0;
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--current-card-border);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    width: 350px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 10002;
    display: none;
}

.notifications-dropdown.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.notifications-list {
    padding: 10px;
}

.notification-dropdown-item {
    padding: 10px;
    border-bottom: 1px solid var(--current-card-border);
    cursor: pointer;
    transition: all 0.3s ease;
}

.notification-dropdown-item:hover {
    background: rgba(102, 126, 234, 0.1);
}

.notification-dropdown-item:last-child {
    border-bottom: none;
}

/* ===== سجل الإشعارات ===== */
.notifications-history {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 10px;
}

.notification-history-item {
    padding: 10px;
    border-bottom: 1px solid var(--current-card-border);
    font-size: 0.85rem;
}

.notification-history-item:last-child {
    border-bottom: none;
}

/* ===== تصميم لشريط التنقل المحدث ===== */
.navbar-with-notifications {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--current-card-bg);
    backdrop-filter: blur(20px);
    padding: 15px 25px;
    border-radius: 20px;
    margin-bottom: 30px;
    border: 1px solid var(--current-card-border);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    color: var(--current-text) !important;
}

.nav-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.nav-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* ===== رسالة ترحيب ===== */
.welcome-message {
    font-size: 0.9rem;
    color: var(--current-label);
    font-weight: 500;
}
    </style>
</head>
<body>
    <!-- زر الوضع الليلي -->
    <button id="darkModeToggle" title="تبديل الوضع الليلي">
        <i class="fas fa-moon"></i>
    </button>

    <!-- حاوية الإشعارات -->
    <div id="notificationsContainer" class="notifications-container"></div>

    <!-- شاشة التحميل -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- الصفحة الرئيسية -->
    <div id="mainPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-md w-full card-hover">
            <div class="text-center mb-10">
                <div class="text-6xl mb-6 text-blue-600 dark:text-blue-400">
                    <i class="fas fa-user-clock"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white mb-2">تسجيل الدخول</h1>
                <p class="text-gray-600 dark:text-gray-300">سجل دخولك لبدء استخدام النظام</p>
            </div>
            
            <!-- رسالة تنبيه -->
            <div id="mainAlert" class="alert hidden"></div>
            
            <!-- نموذج تسجيل الدخول -->
            <form id="loginForm">
                <div class="input-group">
                    <label for="loginPhone" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-phone text-blue-600 dark:text-blue-400"></i>
                        رقم الجوال
                    </label>
                    <input type="tel" id="loginPhone" placeholder="05xxxxxxxx" required 
                           pattern="05[0-9]{8}" class="focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
                
                <div class="input-group">
                    <label for="loginPassword" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-lock text-blue-600 dark:text-blue-400"></i>
                        كلمة المرور
                    </label>
                    <input type="password" id="loginPassword" placeholder="ادخل كلمة المرور" required
                           minlength="6" class="focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
                
                <button type="submit" class="btn btn-primary w-full text-lg py-3 mb-4">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
            
            <div class="mt-4">
                <button onclick="openModal('forgotModal')" class="btn btn-warning w-full py-3">
                    <i class="fas fa-key"></i>
                    نسيت كلمة المرور
                </button>
            </div>
        </div>
    </div>

    <!-- لوحة المستخدم العادي -->
    <div id="userPanel" class="min-h-screen hidden">
        <!-- شريط التنقل -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold">
                        <i class="fas fa-user-clock ml-2"></i>
                        نظام الحضور والانصراف الذكي
                    </h1>
                    <p class="text-sm opacity-90" id="userGreeting">مرحباً</p>
                </div>
                <div class="flex flex-wrap items-center gap-4">
                    <span id="currentTime" class="text-sm"></span>
                    <span class="role-badge" id="userRoleBadge"></span>
                    
                    <!-- زر الإشعارات -->
                    <div class="relative">
                        <button id="notificationsBtn" class="notifications-btn" onclick="toggleNotificationsDropdown()">
                            <i class="fas fa-bell"></i>
                            <span id="notificationCount" class="notification-badge hidden">0</span>
                        </button>
                        <div id="notificationsDropdown" class="notifications-dropdown">
                            <div class="p-4">
                                <h3 class="font-bold mb-2 text-gray-800 dark:text-white">
                                    <i class="fas fa-bell ml-2"></i>
                                    الإشعارات
                                </h3>
                                <div id="notificationsDropdownList" class="notifications-list"></div>
                                <button onclick="clearAllNotifications()" class="btn btn-secondary btn-sm w-full mt-2">
                                    <i class="fas fa-trash ml-2"></i>
                                    مسح جميع الإشعارات
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- زر الرجوع إلى القائمة -->
                    <button onclick="showMainPage()" class="admin-home-btn">
                        <i class="fas fa-home"></i>
                        الرجوع إلى القائمة
                    </button>
                    
                    <button onclick="logout()" class="btn btn-danger text-sm">
                        <i class="fas fa-sign-out-alt"></i>
                        خروج
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto p-4">
            <!-- بطاقة معلومات المستخدم -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 card-hover">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white" id="userDisplayName"></h2>
                        <div class="flex flex-wrap items-center gap-4 mt-2">
                            <span class="text-gray-600 dark:text-gray-300" id="userDisplayDepartment"></span>
                            <span class="text-gray-500 dark:text-gray-400" id="userDisplayPhone"></span>
                            <span class="role-badge" id="userRoleDisplay"></span>
                        </div>
                        <div class="mt-3">
                            <span class="text-gray-700 dark:text-gray-300" id="userCurrentRank">الرتبة الحالية: </span>
                            <span class="text-blue-600 dark:text-blue-400 font-bold" id="userRankName"></span>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl mb-2" id="userStatusIcon">⭕</div>
                        <span class="badge" id="userStatusText">غير مسجل</span>
                    </div>
                </div>
            </div>

            <!-- إحصائيات سريعة -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="userStatsSection">
                <div class="stat-card">
                    <div class="stat-icon text-blue-500">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-number text-blue-600" id="userDays">0</div>
                    <div class="stat-label">أيام الحضور</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-green-500">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number text-green-600" id="userHours">0</div>
                    <div class="stat-label">إجمالي الساعات</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-purple-500">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-number text-purple-600" id="userAvg">0</div>
                    <div class="stat-label">متوسط يومي</div>
                </div>
            </div>
            
            <!-- أزرار التحكم -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="attendanceSection">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
                        <i class="fas fa-sign-in-alt ml-2"></i>
                        تسجيل الدخول
                    </h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">سجل دخولك لبدء العمل</p>
                    <button id="attendanceLoginBtn" onclick="attendanceLogin()" 
                            class="btn btn-success w-full py-3">
                        <i class="fas fa-door-open"></i>
                        تسجيل دخول
                    </button>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
                        <i class="fas fa-sign-out-alt ml-2"></i>
                        تسجيل الخروج
                    </h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">سجل خروجك بعد انتهاء العمل</p>
                    <button id="attendanceLogoutBtn" onclick="openModal('logoutModal')" 
                            class="btn btn-danger w-full py-3" disabled>
                        <i class="fas fa-door-closed"></i>
                        تسجيل خروج
                    </button>
                </div>
            </div>
            
            <!-- خدمات إضافية -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="requestsSection">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover" id="leaveRequestSection">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
                        <i class="fas fa-umbrella-beach ml-2"></i>
                        طلب إجازة
                    </h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">تقديم طلب للحصول على إجازة</p>
                    <button onclick="openModal('leaveModal')" class="btn btn-warning w-full py-3">
                        <i class="fas fa-file-export"></i>
                        تقديم طلب
                    </button>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover" id="resignRequestSection">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
                        <i class="fas fa-file-signature ml-2"></i>
                        طلب استقالة
                    </h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">تقديم طلب استقالة من العمل</p>
                    <button onclick="openModal('resignModal')" class="btn btn-danger w-full py-3">
                        <i class="fas fa-file-contract"></i>
                        تقديم طلب
                    </button>
                </div>
            </div>
            
            <!-- قسم سجلي -->
            <div class="employee-section">
                <div class="section-title">
                    <i class="fas fa-history text-blue-600 dark:text-blue-400"></i>
                    <span>سجلي وطلباتي</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-4 rounded-lg transition-colors" onclick="showMyRequests('الاجازات')">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
                                <i class="fas fa-umbrella-beach text-blue-600 dark:text-blue-400 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 dark:text-white">طلبات الإجازة</h4>
                                <p id="myLeaveCount" class="text-gray-500 dark:text-gray-400">0 طلب</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-4 rounded-lg transition-colors" onclick="showMyRequests('الاستقالات')">
                        <div class="flex items-center gap-3">
                            <div class="bg-red-100 dark:bg-red-900 p-3 rounded-lg">
                                <i class="fas fa-file-signature text-red-600 dark:text-red-400 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 dark:text-white">طلبات الاستقالة</h4>
                                <p id="myResignCount" class="text-gray-500 dark:text-gray-400">0 طلب</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- محتوى الطلبات -->
                <div id="myRequestsContent"></div>
            </div>
            
            <!-- سجل الحضور الأخير -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 card-hover" id="attendanceHistorySection">
                <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
                    <i class="fas fa-history ml-2"></i>
                    سجل الحضور الأخير
                </h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>وقت الدخول</th>
                                <th>وقت الخروج</th>
                                <th>المدة</th>
                            </tr>
                        </thead>
                        <tbody id="userAttendanceTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- لوحة المدير -->
    <div id="adminPanel" class="min-h-screen hidden">
        <!-- شريط التنقل -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">
                        <i class="fas fa-crown ml-2"></i>
                        لوحة تحكم المدير
                    </h1>
                    <p class="text-sm opacity-90" id="adminGreeting">مرحباً</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="adminCurrentTime" class="text-sm"></span>
                    
                    <!-- زر الإشعارات للمدير -->
                    <div class="relative">
                        <button id="adminNotificationsBtn" class="notifications-btn" onclick="toggleAdminNotificationsDropdown()">
                            <i class="fas fa-bell"></i>
                            <span id="adminNotificationCount" class="notification-badge hidden">0</span>
                        </button>
                        <div id="adminNotificationsDropdown" class="notifications-dropdown">
                            <div class="p-4">
                                <h3 class="font-bold mb-2 text-gray-800 dark:text-white">
                                    <i class="fas fa-bell ml-2"></i>
                                    إشعارات المدير
                                </h3>
                                <div id="adminNotificationsDropdownList" class="notifications-list"></div>
                                <button onclick="clearAllAdminNotifications()" class="btn btn-secondary btn-sm w-full mt-2">
                                    <i class="fas fa-trash ml-2"></i>
                                    مسح جميع الإشعارات
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="showPage('userPage')" class="btn bg-white text-purple-600 text-sm">
                        <i class="fas fa-user"></i>
                        لوحتي الشخصية
                    </button>
                    <button onclick="logout()" class="btn btn-danger text-sm">
                        <i class="fas fa-sign-out-alt"></i>
                        خروج
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto p-4">
            <!-- إحصائيات سريعة -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-icon text-blue-500">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number text-blue-600" id="adminTotalUsers">0</div>
                    <div class="stat-label">إجمالي الموظفين</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-yellow-500">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number text-yellow-600" id="adminActiveUsers">0</div>
                    <div class="stat-label">مسجلين الآن</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-green-500">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-number text-green-600" id="adminPendingRequests">0</div>
                    <div class="stat-label">طلبات معلقة</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon text-red-500">
                        <i class="fas fa-user-tag"></i>
                    </div>
                    <div class="stat-number text-red-600" id="adminRankChanges">0</div>
                    <div class="stat-label">طلبات ترقية</div>
                </div>
            </div>
            
            <!-- تبويبات التحكم -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg mb-6">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <div class="flex overflow-x-auto">
                        <button onclick="showAdminTab('users')" 
                                class="tab-btn active px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-users ml-2"></i>
                            الموظفين والصلاحيات
                        </button>
                        <button onclick="showAdminTab('roles')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-user-tag ml-2"></i>
                            إدارة الرتب
                        </button>
                        <button onclick="showAdminTab('attendance')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-history ml-2"></i>
                            سجلات الحضور
                        </button>
                        <button onclick="showAdminTab('requests')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-file-alt ml-2"></i>
                            طلبات الموظفين
                        </button>
                        <button onclick="showAdminTab('reports')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-chart-pie ml-2"></i>
                            تقارير الحضور
                        </button>
                        <button onclick="showAdminTab('notifications')" 
                                class="tab-btn px-6 py-3 whitespace-nowrap">
                            <i class="fas fa-bell ml-2"></i>
                            سجل الإشعارات
                        </button>
                    </div>
                </div>
                
                <!-- محتوى التبويبات -->
                <div class="p-6">
                    <!-- تبويب الموظفين -->
                    <div id="usersTab" class="tab-content active">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">إدارة الموظفين والصلاحيات</h2>
                            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                <input type="text" id="searchUsers" placeholder="🔍 ابحث عن موظف..." 
                                       class="border rounded-lg p-2 flex-1 min-w-[200px] dark:bg-gray-700 dark:text-white dark:border-gray-600">
                                <button onclick="openModal('registerModal')" class="btn btn-success">
                                    <i class="fas fa-user-plus ml-2"></i>
                                    إضافة موظف
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>الدور</th>
                                        <th>الرتبة</th>
                                        <th>رقم الجوال</th>
                                        <th>الحالة</th>
                                        <th>الصلاحيات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUsersTable"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تبويب إدارة الرتب -->
                    <div id="rolesTab" class="tab-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">إدارة الرتب والصلاحيات</h2>
                            <div class="flex gap-2">
                                <button onclick="openModal('addRoleModal')" class="btn btn-success">
                                    <i class="fas fa-plus ml-2"></i>
                                    إضافة رتبة جديدة
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">الرتب الحالية في النظام</h3>
                                <div id="rolesList" class="space-y-3"></div>
                            </div>

                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-white" id="editingRoleTitle">تعديل صلاحيات الرتبة</h3>
                                <div class="input-group">
                                    <label class="text-gray-800 dark:text-white">اسم الرتبة:</label>
                                    <input type="text" id="editRoleName" class="border rounded-lg p-2 dark:bg-gray-700 dark:text-white dark:border-gray-600" disabled>
                                </div>
                                
                                <div class="permission-group mt-4">
                                    <h4 class="font-bold mb-3 text-gray-800 dark:text-white">الصلاحيات المتاحة:</h4>
                                    <div id="rolePermissionsList" class="space-y-2"></div>
                                </div>
                                
                                <div class="flex gap-2 mt-4">
                                    <button onclick="saveRolePermissions()" class="btn btn-primary flex-1" id="saveRoleBtn">
                                        <i class="fas fa-save ml-2"></i>
                                        حفظ التعديلات
                                    </button>
                                    <button onclick="deleteRole()" class="btn btn-danger" id="deleteRoleBtn" disabled>
                                        <i class="fas fa-trash ml-2"></i>
                                        حذف الرتبة
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تبويب سجلات الحضور -->
                    <div id="attendanceTab" class="tab-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">سجلات الحضور والانصراف</h2>
                            <div class="flex gap-2 w-full md:w-auto">
                                <input type="text" id="searchAttendance" placeholder="🔍 ابحث في السجلات..." 
                                       class="border rounded-lg p-2 flex-1 min-w-[200px] dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>الموظف</th>
                                        <th>الرتبة</th>
                                        <th>التاريخ</th>
                                        <th>الدخول</th>
                                        <th>الخروج</th>
                                        <th>المدة</th>
                                        <th>تقرير الخروج</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="adminAttendanceTable"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تبويب طلبات الموظفين -->
                    <div id="requestsTab" class="tab-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">طلبات الموظفين</h2>
                            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                <select id="filterRequestType" class="border rounded-lg p-2 dark:bg-gray-700 dark:text-white dark:border-gray-600" onchange="filterRequests()">
                                    <option value="">جميع الطلبات</option>
                                    <option value="إجازة">طلبات الإجازة</option>
                                    <option value="استقالة">طلبات الاستقالة</option>
                                </select>
                                <select id="filterRequestStatus" class="border rounded-lg p-2 dark:bg-gray-700 dark:text-white dark:border-gray-600" onchange="filterRequests()">
                                    <option value="">جميع الحالات</option>
                                    <option value="معلق">معلقة</option>
                                    <option value="مقبول">مقبولة</option>
                                    <option value="مرفوض">مرفوضة</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>الموظف</th>
                                        <th>الرتبة</th>
                                        <th>نوع الطلب</th>
                                        <th>السبب / التفاصيل</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="adminRequestsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تبويب تقارير الحضور -->
                    <div id="reportsTab" class="tab-content">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">تقارير وإحصائيات الحضور</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">🏆 أفضل 5 موظفين</h3>
                                <div id="topEmployeesList"></div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover">
                                <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">📊 إحصائيات الرتب</h3>
                                <div id="rankStats"></div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover mb-6">
                            <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">📅 تقرير الحضور اليومي</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block mb-2 text-gray-800 dark:text-white">من تاريخ:</label>
                                    <input type="date" id="reportFromDate" class="border rounded-lg p-2 w-full dark:bg-gray-700 dark:text-white dark:border-gray-600">
                                </div>
                                <div>
                                    <label class="block mb-2 text-gray-800 dark:text-white">إلى تاريخ:</label>
                                    <input type="date" id="reportToDate" class="border rounded-lg p-2 w-full dark:bg-gray-700 dark:text-white dark:border-gray-600">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateAttendanceReport()" class="btn btn-primary w-full">
                                        <i class="fas fa-download ml-2"></i>
                                        إنشاء التقرير
                                    </button>
                                </div>
                            </div>
                            <div id="attendanceReportResult"></div>
                        </div>
                    </div>
                    
                    <!-- تبويب سجل الإشعارات -->
                    <div id="notificationsTab" class="tab-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">سجل الإشعارات والنشاطات</h2>
                            <div class="flex gap-2">
                                <button onclick="exportNotifications()" class="btn btn-success">
                                    <i class="fas fa-download ml-2"></i>
                                    تصدير السجل
                                </button>
                                <button onclick="clearAllNotificationsHistory()" class="btn btn-danger">
                                    <i class="fas fa-trash ml-2"></i>
                                    مسح السجل
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 card-hover">
                            <div class="mb-4">
                                <div class="flex gap-2">
                                    <select id="filterNotificationType" class="border rounded-lg p-2 dark:bg-gray-700 dark:text-white dark:border-gray-600" onchange="filterNotifications()">
                                        <option value="">جميع أنواع الإشعارات</option>
                                        <option value="login">تسجيل دخول</option>
                                        <option value="logout">تسجيل خروج</option>
                                        <option value="request">طلبات</option>
                                        <option value="user">إدارة المستخدمين</option>
                                        <option value="admin">إشعارات المدير</option>
                                    </select>
                                    <input type="date" id="filterNotificationDate" class="border rounded-lg p-2 dark:bg-gray-700 dark:text-white dark:border-gray-600" onchange="filterNotifications()">
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>التاريخ والوقت</th>
                                            <th>نوع الإشعار</th>
                                            <th>المستخدم</th>
                                            <th>الرسالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="notificationsHistoryTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== النوافذ المنبثقة ===== -->
    
    <!-- نافذة إنشاء حساب جديد -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('registerModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">إنشاء حساب جديد</h3>
            <form id="registerForm">
                <div class="input-group">
                    <label for="registerName" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-user text-blue-600 dark:text-blue-400"></i>
                        الاسم الكامل
                    </label>
                    <input type="text" id="registerName" placeholder="أدخل اسمك الكامل" required 
                           class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                
                <div class="input-group">
                    <label for="registerPhone" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-phone text-blue-600 dark:text-blue-400"></i>
                        رقم الجوال
                    </label>
                    <input type="tel" id="registerPhone" placeholder="05xxxxxxxx" required
                           pattern="05[0-9]{8}" class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    <small class="text-gray-500 dark:text-gray-400 text-sm">يبدأ بـ 05 ويتكون من 10 أرقام</small>
                </div>
                
                <div class="input-group">
                    <label for="registerPassword" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-lock text-blue-600 dark:text-blue-400"></i>
                        كلمة المرور
                    </label>
                    <input type="password" id="registerPassword" placeholder="6 أحرف على الأقل" 
                           minlength="6" required class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                
                <div class="input-group">
                    <label for="registerConfirmPassword" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-lock text-blue-600 dark:text-blue-400"></i>
                        تأكيد كلمة المرور
                    </label>
                    <input type="password" id="registerConfirmPassword" placeholder="أعد إدخال كلمة المرور" 
                           minlength="6" required class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-success flex-1">إنشاء الحساب</button>
                    <button type="button" onclick="closeModal('registerModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة رتبة جديدة -->
    <div id="addRoleModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addRoleModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">إضافة رتبة جديدة</h3>
            <form id="addRoleForm">
                <div class="input-group">
                    <label for="newRoleName" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-user-tag text-blue-600 dark:text-blue-400"></i>
                        اسم الرتبة
                    </label>
                    <input type="text" id="newRoleName" placeholder="مثال: مشرف تقني" required 
                           class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                
                <div class="input-group">
                    <label for="newRoleKey" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-key text-blue-600 dark:text-blue-400"></i>
                        مفتاح الرتبة (بالإنجليزية)
                    </label>
                    <input type="text" id="newRoleKey" placeholder="مثال: tech_supervisor" required 
                           class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    <small class="text-gray-500 dark:text-gray-400 text-sm">يجب أن يكون بالإنجليزية بدون مسافات</small>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-success flex-1">إنشاء الرتبة</button>
                    <button type="button" onclick="closeModal('addRoleModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة تعديل الصلاحيات -->
    <div id="editPermissionsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('editPermissionsModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">إدارة صلاحيات الموظف</h3>
            <div class="mb-4">
                <p class="text-gray-800 dark:text-white"><strong>الموظف:</strong> <span id="editUserName" class="font-bold"></span></p>
                <p class="text-gray-800 dark:text-white"><strong>الدور الحالي:</strong> <span id="editUserRole" class="badge badge-info"></span></p>
            </div>
            
            <div class="permission-group">
                <h4 class="font-bold mb-3 text-gray-800 dark:text-white">الصلاحيات المتاحة:</h4>
                <div id="permissionsList"></div>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="savePermissions()" class="btn btn-primary flex-1">حفظ التعديلات</button>
                <button onclick="closeModal('editPermissionsModal')" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة نسيت كلمة المرور -->
    <div id="forgotModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('forgotModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">استعادة كلمة المرور</h3>
            <form id="forgotForm">
                <div class="input-group">
                    <label for="forgotPhone" class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-phone text-blue-600 dark:text-blue-400"></i>
                        رقم الجوال
                    </label>
                    <input type="tel" id="forgotPhone" placeholder="05xxxxxxxx" required 
                           class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-warning flex-1">إرسال كلمة المرور</button>
                    <button type="button" onclick="closeModal('forgotModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة تسجيل الخروج من الحضور -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('logoutModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">تسجيل الخروج</h3>
            <form id="logoutForm">
                <div class="input-group">
                    <label class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-file-alt text-blue-600 dark:text-blue-400"></i>
                        تقرير العمل اليومي
                    </label>
                    <textarea id="logoutReport" rows="4" placeholder="ماذا أنجزت اليوم؟" required 
                              class="dark:bg-gray-700 dark:text-white dark:border-gray-600"></textarea>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-danger flex-1">تأكيد الخروج</button>
                    <button type="button" onclick="closeModal('logoutModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة طلب إجازة -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('leaveModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">طلب إجازة</h3>
            <form id="leaveForm">
                <div class="input-group">
                    <label class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-sticky-note text-blue-600 dark:text-blue-400"></i>
                        سبب الإجازة
                    </label>
                    <textarea id="leaveReason" rows="3" required 
                              class="dark:bg-gray-700 dark:text-white dark:border-gray-600"></textarea>
                </div>
                <div class="input-group">
                    <label class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-clock text-blue-600 dark:text-blue-400"></i>
                        المدة
                    </label>
                    <input type="text" id="leaveDuration" placeholder="مثال: 3 أيام" required 
                           class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                <div class="input-group">
                    <label class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-calendar text-blue-600 dark:text-blue-400"></i>
                        تاريخ البدء
                    </label>
                    <input type="date" id="leaveStartDate" required 
                           class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-warning flex-1">إرسال الطلب</button>
                    <button type="button" onclick="closeModal('leaveModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة طلب استقالة -->
    <div id="resignModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('resignModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">طلب استقالة</h3>
            <form id="resignForm">
                <div class="input-group">
                    <label class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-sticky-note text-blue-600 dark:text-blue-400"></i>
                        سبب الاستقالة
                    </label>
                    <textarea id="resignReason" rows="4" required 
                              class="dark:bg-gray-700 dark:text-white dark:border-gray-600"></textarea>
                </div>
                <div class="input-group">
                    <label class="flex items-center gap-2 text-gray-800 dark:text-white">
                        <i class="fas fa-calendar text-blue-600 dark:text-blue-400"></i>
                        تاريخ إنهاء العمل
                    </label>
                    <input type="date" id="resignEndDate" required 
                           class="dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-danger flex-1">إرسال الطلب</button>
                    <button type="button" onclick="closeModal('resignModal')" 
                            class="btn btn-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة تأكيد تسجيل الدخول -->
    <div id="confirmLoginModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('confirmLoginModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">تأكيد تسجيل الدخول</h3>
            <p class="mb-6 text-gray-800 dark:text-white">هل أنت متأكد من تسجيل الدخول الآن؟</p>
            <div class="flex gap-2">
                <button onclick="confirmAttendanceLogin()" class="btn btn-success flex-1">
                    نعم، سجل دخول
                </button>
                <button onclick="closeModal('confirmLoginModal')" class="btn btn-secondary flex-1">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة معالجة الطلب -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('processModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">معالجة الطلب</h3>
            <p class="mb-4 text-gray-800 dark:text-white" id="processMessage"></p>
            <div class="input-group" id="processReasonField" style="display: none;">
                <label class="text-gray-800 dark:text-white">سبب الرفض (اختياري):</label>
                <textarea id="rejectReason" rows="3" placeholder="اذكر سبب الرفض..." 
                          class="dark:bg-gray-700 dark:text-white dark:border-gray-600"></textarea>
            </div>
            <div class="flex gap-2">
                <button onclick="processRequest('مقبول')" class="btn btn-success flex-1">✅ قبول</button>
                <button onclick="showRejectReason()" class="btn btn-danger flex-1">❌ رفض</button>
                <button onclick="closeModal('processModal')" class="btn btn-secondary flex-1">إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تفاصيل الطلب -->
    <div id="requestDetailsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('requestDetailsModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white" id="requestDetailsTitle">تفاصيل الطلب</h3>
            <div id="requestDetailsContent" class="text-gray-800 dark:text-white"></div>
            <div class="flex gap-2 mt-4">
                <button onclick="closeModal('requestDetailsModal')" class="btn btn-secondary flex-1">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تفاصيل تقرير الخروج -->
    <div id="reportDetailsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('reportDetailsModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">تقرير العمل اليومي</h3>
            <div class="report-box mb-4" id="reportDetailsContent"></div>
            <div class="flex gap-2">
                <button onclick="closeModal('reportDetailsModal')" class="btn btn-secondary flex-1">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تأكيد الحذف -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('deleteModal')">×</button>
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">تأكيد الحذف</h3>
            <p class="mb-6 text-gray-800 dark:text-white" id="deleteMessage"></p>
            <div class="flex gap-2">
                <button onclick="confirmDelete()" class="btn btn-danger flex-1">نعم، احذف</button>
                <button onclick="closeModal('deleteModal')" class="btn btn-secondary flex-1">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- سكربت النظام -->
    <script>
        // ===== المتغيرات العامة =====
        let currentUser = null;
        let currentSession = null;
        let users = [];
        let sessions = [];
        let requests = [];
        let logs = [];
        let promotions = [];
        let userToDelete = null;
        let requestToProcess = null;
        let userToEditPermissions = null;
        let editingPermissions = {};
        let customRoles = {}; 
        let currentEditingRole = null;
        
        // ===== نظام الإشعارات الفوري =====
        let notificationSocket = null;
        let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
        let notificationHistory = JSON.parse(localStorage.getItem('notificationHistory') || '[]');

        // ===== تعريف الرتب الأساسية =====
        const rolePermissions = {
            employee: {
                name: "موظف عادي",
                badgeClass: "role-badge-employee",
                permissions: {
                    attendance: true,
                    leave: true,
                    resign: true,
                    viewHistory: true,
                    viewStats: true,
                    viewTeamAttendance: false,
                    viewTeamRequests: false,
                    addUsers: false,
                    editPermissions: false,
                    viewAllAttendance: false,
                    processRequests: false,
                    viewReports: false,
                    deleteUsers: false,
                    requestPromotion: true
                }
            },
            supervisor: {
                name: "مشرف",
                badgeClass: "role-badge-manager",
                permissions: {
                    attendance: true,
                    leave: true,
                    resign: true,
                    viewHistory: true,
                    viewStats: true,
                    viewTeamAttendance: true,
                    viewTeamRequests: true,
                    addUsers: false,
                    editPermissions: false,
                    viewAllAttendance: false,
                    processRequests: false,
                    viewReports: false,
                    deleteUsers: false,
                    requestPromotion: true
                }
            },
            manager: {
                name: "مدير قسم",
                badgeClass: "role-badge-manager",
                permissions: {
                    attendance: true,
                    leave: true,
                    resign: true,
                    viewHistory: true,
                    viewStats: true,
                    viewTeamAttendance: true,
                    viewTeamRequests: true,
                    addUsers: true,
                    editPermissions: true,
                    viewAllAttendance: true,
                    processRequests: true,
                    viewReports: true,
                    deleteUsers: false,
                    requestPromotion: true
                }
            },
            admin: {
                name: "مدير نظام",
                badgeClass: "role-badge-admin",
                permissions: {
                    attendance: true,
                    leave: true,
                    resign: true,
                    viewHistory: true,
                    viewStats: true,
                    viewTeamAttendance: true,
                    viewTeamRequests: true,
                    addUsers: true,
                    editPermissions: true,
                    viewAllAttendance: true,
                    processRequests: true,
                    viewReports: true,
                    deleteUsers: true,
                    requestPromotion: false
                }
            }
        };

        // ===== أسماء الصلاحيات =====
        const permissionNames = {
            attendance: "تسجيل الحضور والانصراف",
            leave: "تقديم طلبات إجازة",
            resign: "تقديم طلبات استقالة",
            viewHistory: "عرض سجل الحضور الشخصي",
            viewStats: "عرض الإحصائيات الشخصية",
            viewTeamAttendance: "عرض حضور فريق العمل",
            viewTeamRequests: "عرض طلبات فريق العمل",
            addUsers: "إضافة موظفين جدد",
            editPermissions: "تعديل صلاحيات الموظفين",
            viewAllAttendance: "عرض جميع سجلات الحضور",
            processRequests: "معالجة طلبات الموظفين",
            viewReports: "عرض التقارير والإحصائيات",
            deleteUsers: "حذف الموظفين من النظام",
        };

        // ===== دوال إدارة التخزين =====
        function saveData() {
            localStorage.setItem('attendance_users', JSON.stringify(users));
            localStorage.setItem('attendance_sessions', JSON.stringify(sessions));
            localStorage.setItem('attendance_requests', JSON.stringify(requests));
            localStorage.setItem('attendance_logs', JSON.stringify(logs));
            localStorage.setItem('attendance_promotions', JSON.stringify(promotions));
            localStorage.setItem('attendance_custom_roles', JSON.stringify(customRoles));
        }
        
        function loadData() {
            try {
                users = JSON.parse(localStorage.getItem('attendance_users') || '[]');
                sessions = JSON.parse(localStorage.getItem('attendance_sessions') || '[]');
                requests = JSON.parse(localStorage.getItem('attendance_requests') || '[]');
                logs = JSON.parse(localStorage.getItem('attendance_logs') || '[]');
                promotions = JSON.parse(localStorage.getItem('attendance_promotions') || '[]');
                customRoles = JSON.parse(localStorage.getItem('attendance_custom_roles') || '{}');
                
                if (users.length === 0) {
                    createAdminOnly();
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                createAdminOnly();
            }
        }
        
        function createAdminOnly() {
            const adminUser = {
                id: 1,
                name: "المدير العام",
                phone: "0500000000",
                department: "الإدارة",
                password: "admin123",
                role: "admin",
                rank: "مدير نظام",
                rankHistory: [{
                    rank: "مدير نظام",
                    date: new Date().toISOString(),
                    reason: "تعيين أولي"
                }],
                permissions: rolePermissions.admin.permissions,
                createdAt: new Date().toISOString()
            };
            
            users = [adminUser];
            sessions = [];
            requests = [];
            logs = [];
            promotions = [];
            
            saveData();
        }

        // ===== دوال نظام الإشعارات =====
        function initNotifications() {
            // محاكاة نظام WebSocket (في حالة حقيقية، سيتم الاتصال بخادم Socket.io)
            updateNotificationsCount();
            updateNotificationsDropdown();
        }
        
        function showNotification(title, message, type = 'info', isBroadcast = false) {
            const notification = {
                id: Date.now(),
                title: title,
                message: message,
                type: type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // إضافة للإشعارات الفورية
            notifications.unshift(notification);
            if (notifications.length > 50) notifications = notifications.slice(0, 50);
            
            // إضافة للسجل
            notificationHistory.unshift(notification);
            if (notificationHistory.length > 1000) notificationHistory = notificationHistory.slice(0, 1000);
            
            // حفظ في localStorage
            localStorage.setItem('notifications', JSON.stringify(notifications));
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            
            // عرض الإشعار
            displayNotification(notification);
            
            // تحديث العدادات والقوائم
            updateNotificationsCount();
            updateNotificationsDropdown();
            
            // إذا كان المدير متصل، تحديث قائمة الإشعارات لديه
            if (currentUser && currentUser.role === 'admin') {
                updateAdminNotifications();
            }
            
            // إذا كان إشعار بث عام، عرضه لجميع المستخدمين
            if (isBroadcast) {
                // في نظام حقيقي، هذا سيتم إرساله عبر WebSocket لجميع المستخدمين المتصلين
                console.log('إشعار بث عام:', notification);
            }
            
            // في نظام حقيقي، سيتم إرسال الإشعار عبر WebSocket
            // broadcastNotification(notification);
        }
        
        function displayNotification(notification) {
            const container = document.getElementById('notificationsContainer');
            if (!container) return;
            
            const notificationElement = document.createElement('div');
            notificationElement.className = `notification-item notification-${notification.type}`;
            notificationElement.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                        ${getNotificationIcon(notification.type)} ${notification.title}
                    </div>
                    <div class="notification-time">
                        ${formatTime(notification.timestamp)}
                    </div>
                </div>
                <div class="notification-message">
                    ${notification.message}
                </div>
            `;
            
            notificationElement.onclick = () => markNotificationAsRead(notification.id);
            
            container.appendChild(notificationElement);
            
            // إزالة الإشعار بعد 5 ثواني
            setTimeout(() => {
                if (notificationElement.parentNode) {
                    notificationElement.style.animation = 'fadeOut 0.4s ease forwards';
                    setTimeout(() => notificationElement.remove(), 400);
                }
            }, 5000);
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'login': return '<i class="fas fa-sign-in-alt"></i>';
                case 'logout': return '<i class="fas fa-sign-out-alt"></i>';
                case 'request': return '<i class="fas fa-file-alt"></i>';
                case 'user': return '<i class="fas fa-user"></i>';
                case 'admin': return '<i class="fas fa-crown"></i>';
                default: return '<i class="fas fa-bell"></i>';
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'الآن';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} دقيقة`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} ساعة`;
            return date.toLocaleDateString('ar-SA');
        }
        
        function updateNotificationsCount() {
            const unreadCount = notifications.filter(n => !n.read).length;
            
            const userBadge = document.getElementById('notificationCount');
            const adminBadge = document.getElementById('adminNotificationCount');
            
            if (userBadge) {
                if (unreadCount > 0) {
                    userBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    userBadge.classList.remove('hidden');
                } else {
                    userBadge.classList.add('hidden');
                }
            }
            
            if (adminBadge) {
                if (unreadCount > 0) {
                    adminBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    adminBadge.classList.remove('hidden');
                } else {
                    adminBadge.classList.add('hidden');
                }
            }
        }
        
        function updateNotificationsDropdown() {
            const dropdown = document.getElementById('notificationsDropdownList');
            if (!dropdown) return;
            
            const recentNotifications = notifications.slice(0, 10);
            let html = '';
            
            if (recentNotifications.length === 0) {
                html = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لا توجد إشعارات جديدة</p>';
            } else {
                recentNotifications.forEach(notification => {
                    const readClass = notification.read ? 'opacity-75' : '';
                    html += `
                        <div class="notification-dropdown-item ${readClass}" onclick="markNotificationAsRead(${notification.id})">
                            <div class="flex justify-between">
                                <div class="font-bold text-gray-800 dark:text-white text-sm">${notification.title}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${formatTime(notification.timestamp)}</div>
                            </div>
                            <div class="text-gray-600 dark:text-gray-300 text-xs mt-1">${notification.message}</div>
                        </div>
                    `;
                });
            }
            
            dropdown.innerHTML = html;
            
            // تحديث قائمة المدير أيضًا
            updateAdminNotifications();
        }
        
        function updateAdminNotifications() {
            const dropdown = document.getElementById('adminNotificationsDropdownList');
            if (!dropdown) return;
            
            const recentNotifications = notifications.slice(0, 10);
            let html = '';
            
            if (recentNotifications.length === 0) {
                html = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لا توجد إشعارات جديدة</p>';
            } else {
                recentNotifications.forEach(notification => {
                    const readClass = notification.read ? 'opacity-75' : '';
                    html += `
                        <div class="notification-dropdown-item ${readClass}" onclick="markNotificationAsRead(${notification.id})">
                            <div class="flex justify-between">
                                <div class="font-bold text-gray-800 dark:text-white text-sm">${notification.title}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${formatTime(notification.timestamp)}</div>
                            </div>
                            <div class="text-gray-600 dark:text-gray-300 text-xs mt-1">${notification.message}</div>
                        </div>
                    `;
                });
            }
            
            dropdown.innerHTML = html;
        }
        
        function markNotificationAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification && !notification.read) {
                notification.read = true;
                localStorage.setItem('notifications', JSON.stringify(notifications));
                updateNotificationsCount();
                updateNotificationsDropdown();
            }
        }
        
        function markAllNotificationsAsRead() {
            notifications.forEach(notification => notification.read = true);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationsCount();
            updateNotificationsDropdown();
        }
        
        function clearAllNotifications() {
            if (confirm('هل تريد مسح جميع الإشعارات؟')) {
                notifications = [];
                localStorage.setItem('notifications', JSON.stringify(notifications));
                updateNotificationsCount();
                updateNotificationsDropdown();
            }
        }
        
        function clearAllAdminNotifications() {
            clearAllNotifications();
        }
        
        function toggleNotificationsDropdown() {
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
                if (dropdown.classList.contains('active')) {
                    markAllNotificationsAsRead();
                }
            }
        }
        
        function toggleAdminNotificationsDropdown() {
            const dropdown = document.getElementById('adminNotificationsDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
                if (dropdown.classList.contains('active')) {
                    markAllNotificationsAsRead();
                }
            }
        }
        
        function loadNotificationsHistory() {
            const table = document.getElementById('notificationsHistoryTable');
            if (!table) return;
            
            let html = '';
            
            if (notificationHistory.length === 0) {
                html = `
                    <tr>
                        <td colspan="4" class="text-center py-4 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-history text-xl mb-2"></i>
                            <p>لا توجد إشعارات مسجلة</p>
                        </td>
                    </tr>
                `;
            } else {
                notificationHistory.slice(0, 50).forEach(notification => {
                    const date = new Date(notification.timestamp);
                    const dateStr = date.toLocaleDateString('ar-SA');
                    const timeStr = date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <tr>
                            <td class="text-gray-800 dark:text-white">
                                ${dateStr}<br>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${timeStr}</span>
                            </td>
                            <td class="text-gray-800 dark:text-white">
                                <span class="inline-flex items-center gap-1">
                                    ${getNotificationIcon(notification.type)}
                                    ${getNotificationTypeText(notification.type)}
                                </span>
                            </td>
                            <td class="text-gray-800 dark:text-white">${notification.title}</td>
                            <td class="text-gray-800 dark:text-white">${notification.message}</td>
                        </tr>
                    `;
                });
            }
            
            table.innerHTML = html;
        }
        
        function getNotificationTypeText(type) {
            switch(type) {
                case 'login': return 'تسجيل دخول';
                case 'logout': return 'تسجيل خروج';
                case 'request': return 'طلب';
                case 'user': return 'مستخدم';
                case 'admin': return 'مدير';
                default: return 'عام';
            }
        }
        
        function filterNotifications() {
            const typeFilter = document.getElementById('filterNotificationType').value;
            const dateFilter = document.getElementById('filterNotificationDate').value;
            
            const rows = document.querySelectorAll('#notificationsHistoryTable tr');
            
            rows.forEach(row => {
                if (row.cells.length < 4) return;
                
                const type = row.cells[1].textContent;
                const date = row.cells[0].textContent.split('\n')[0];
                
                const typeMatch = !typeFilter || type.includes(typeFilter);
                const dateMatch = !dateFilter || date === dateFilter;
                
                row.style.display = (typeMatch && dateMatch) ? '' : 'none';
            });
        }
        
        function clearAllNotificationsHistory() {
            if (confirm('هل تريد مسح سجل الإشعارات بالكامل؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                notificationHistory = [];
                localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
                loadNotificationsHistory();
            }
        }
        
        function exportNotifications() {
            const data = JSON.stringify(notificationHistory, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `سجل_الإشعارات_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('تم تصدير سجل الإشعارات بنجاح', 'success');
        }

        // ===== دوال إدارة النوافذ =====
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function showAlert(message, type = 'error') {
            const alertElement = document.getElementById('mainAlert');
            alertElement.textContent = message;
            alertElement.className = 'alert';
            
            if (type === 'success') {
                alertElement.classList.add('alert-success');
            } else if (type === 'info') {
                alertElement.classList.add('alert-info');
            } else {
                alertElement.classList.add('alert-error');
            }
            
            alertElement.classList.remove('hidden');
            
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }
        
        function showLoading(show = true) {
            const loadingElement = document.getElementById('loading');
            if (show) {
                loadingElement.classList.add('active');
            } else {
                loadingElement.classList.remove('active');
            }
        }

        // ===== دوال إدارة الصفحات =====
        function showPage(pageId) {
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            
            if (pageId === 'userPage') {
                document.getElementById('userPanel').classList.remove('hidden');
                updateUserPanel();
            } else if (pageId === 'adminPage') {
                document.getElementById('adminPanel').classList.remove('hidden');
                updateAdminPanel();
            }
        }

        // ===== دوال تسجيل الدخول =====
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            login();
        });
        
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            register();
        });
        
        document.getElementById('forgotForm').addEventListener('submit', function(e) {
            e.preventDefault();
            forgotPassword();
        });
        
        function login() {
            showLoading(true);
            
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            setTimeout(() => {
                try {
                    const user = users.find(u => u.phone === phone && u.password === password);
                    
                    if (user) {
                        currentUser = user;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        
                        // تسجيل الدخول في السجلات
                        logs.push({
                            id: logs.length + 1,
                            userId: user.id,
                            username: user.name,
                            action: 'login',
                            timestamp: new Date().toISOString()
                        });
                        saveData();
                        
                        // إشعار بتسجيل الدخول
                        showNotification(
                            'تسجيل دخول',
                            `قام ${user.name} بتسجيل الدخول إلى النظام`,
                            'login',
                            true
                        );
                        
                        currentSession = sessions.find(s => s.userId === user.id && !s.logoutTime);
                        
                        document.getElementById('mainPage').classList.add('hidden');
                        
                        if (user.role === 'admin') {
                            document.getElementById('adminPanel').classList.remove('hidden');
                            updateAdminPanel();
                        } else {
                            document.getElementById('userPanel').classList.remove('hidden');
                            updateUserPanel();
                        }
                        
                        document.getElementById('loginPhone').value = '';
                        document.getElementById('loginPassword').value = '';
                        showToast('تم تسجيل الدخول بنجاح!', 'success');
                    } else {
                        showAlert('رقم الجوال أو كلمة المرور غير صحيحة', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في تسجيل الدخول:', error);
                    showAlert('حدث خطأ في تسجيل الدخول', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function register() {
            showLoading(true);
            
            const name = document.getElementById('registerName').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            setTimeout(() => {
                try {
                    if (!name || !phone || !password || !confirmPassword) {
                        showAlert('جميع الحقول مطلوبة', 'error');
                        return;
                    }
                    
                    if (phone.length !== 10 || !phone.startsWith('05')) {
                        showAlert('رقم الجوال يجب أن يبدأ بـ 05 ويتكون من 10 أرقام', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showAlert('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showAlert('كلمة المرور غير متطابقة', 'error');
                        return;
                    }
                    
                    const existingUser = users.find(u => u.phone === phone);
                    if (existingUser) {
                        showAlert('رقم الجوال مسجل مسبقاً', 'error');
                        return;
                    }
                    
                    const newUser = {
                        id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 2,
                        name: name,
                        phone: phone,
                        department: "غير محدد",
                        password: password,
                        role: "employee",
                        rank: "موظف عادي",
                        rankHistory: [{
                            rank: "موظف عادي",
                            date: new Date().toISOString(),
                            reason: "تعيين أولي"
                        }],
                        permissions: rolePermissions.employee.permissions,
                        createdAt: new Date().toISOString()
                    };
                    
                    users.push(newUser);
                    saveData();
                    
                    // إشعار بإضافة مستخدم جديد
                    if (currentUser) {
                        showNotification(
                            'إضافة موظف جديد',
                            `قام ${currentUser.name} بإضافة الموظف الجديد ${name}`,
                            'user',
                            true
                        );
                    }
                    
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerPhone').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerConfirmPassword').value = '';
                    
                    closeModal('registerModal');
                    showToast('تم إنشاء الحساب بنجاح!', 'success');
                    
                    if (currentUser && currentUser.role === 'admin') {
                        loadAdminUsersTable();
                        updateAdminStats();
                    }
                } catch (error) {
                    console.error('خطأ في إنشاء الحساب:', error);
                    showAlert('حدث خطأ في إنشاء الحساب', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function forgotPassword() {
            showLoading(true);
            
            const phone = document.getElementById('forgotPhone').value.trim();
            
            setTimeout(() => {
                try {
                    const user = users.find(u => u.phone === phone);
                    
                    if (user) {
                        closeModal('forgotModal');
                        document.getElementById('forgotPhone').value = '';
                        showAlert(`كلمة المرور لحساب ${user.name}: ${user.password}`, 'info');
                    } else {
                        showAlert('رقم الجوال غير مسجل في النظام', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في استعادة كلمة المرور:', error);
                    showAlert('حدث خطأ في استعادة كلمة المرور', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function logout() {
            if (confirm('هل تريد تسجيل الخروج من النظام؟')) {
                // إشعار بتسجيل الخروج
                if (currentUser) {
                    showNotification(
                        'تسجيل خروج',
                        `قام ${currentUser.name} بتسجيل الخروج من النظام`,
                        'logout',
                        true
                    );
                }
                
                currentUser = null;
                currentSession = null;
                localStorage.removeItem('currentUser');
                document.getElementById('userPanel').classList.add('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('mainPage').classList.remove('hidden');
                showToast('تم تسجيل الخروج بنجاح', 'success');
            }
        }

        // ===== دوال إدارة الصلاحيات =====
        function checkPermission(permissionKey) {
            if (!currentUser || !currentUser.permissions) return false;
            return currentUser.permissions[permissionKey] === true;
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            const roleInfo = getRoleInfo(currentUser.role);
            document.getElementById('userRoleBadge').textContent = roleInfo.name;
            document.getElementById('userRoleBadge').className = `role-badge ${roleInfo.badgeClass}`;
            document.getElementById('userRoleDisplay').textContent = roleInfo.name;
            document.getElementById('userRoleDisplay').className = `role-badge ${roleInfo.badgeClass}`;
            
            document.getElementById('userRankName').textContent = currentUser.rank || roleInfo.name;
            
            document.getElementById('attendanceSection').classList.toggle('hidden', !checkPermission('attendance'));
            document.getElementById('leaveRequestSection').classList.toggle('hidden', !checkPermission('leave'));
            document.getElementById('resignRequestSection').classList.toggle('hidden', !checkPermission('resign'));
            document.getElementById('attendanceHistorySection').classList.toggle('hidden', !checkPermission('viewHistory'));
            document.getElementById('userStatsSection').classList.toggle('hidden', !checkPermission('viewStats'));
        }
        
        function updateMyRequestsCount() {
            if (!currentUser) return;
            
            const myLeaves = requests.filter(r => r.userId === currentUser.id && r.type === 'إجازة').length;
            const myResigns = requests.filter(r => r.userId === currentUser.id && r.type === 'استقالة').length;
            
            document.getElementById('myLeaveCount').textContent = `${myLeaves} طلب`;
            document.getElementById('myResignCount').textContent = `${myResigns} طلب`;
        }
        
        function showMyRequests(type) {
            const content = document.getElementById('myRequestsContent');
            let html = '';
            
            if (type === 'الاجازات') {
                const myLeaves = requests.filter(r => r.userId === currentUser.id && r.type === 'إجازة')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                html = `<h4 class="font-bold mb-3 text-gray-800 dark:text-white">طلبات الإجازة:</h4>`;
                if (myLeaves.length === 0) {
                    html += '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لا توجد طلبات إجازة</p>';
                } else {
                    myLeaves.forEach(request => {
                        const date = new Date(request.timestamp);
                        const statusBadge = request.status === 'معلق' ? 
                            '<span class="badge badge-warning">معلق</span>' : 
                            request.status === 'مقبول' ? 
                            '<span class="badge badge-success">مقبول</span>' : 
                            '<span class="badge badge-danger">مرفوض</span>';
                        
                        html += `
                        <div class="border-b py-3 border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center">
                                <div class="text-gray-800 dark:text-white">
                                    <p><strong>التاريخ:</strong> ${date.toLocaleDateString('ar-SA')}</p>
                                    <p><strong>المدة:</strong> ${request.duration}</p>
                                    <p><strong>السبب:</strong> ${request.reason}</p>
                                </div>
                                <div>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
            }
            else if (type === 'الاستقالات') {
                const myResigns = requests.filter(r => r.userId === currentUser.id && r.type === 'استقالة')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                html = `<h4 class="font-bold mb-3 text-gray-800 dark:text-white">طلبات الاستقالة:</h4>`;
                if (myResigns.length === 0) {
                    html += '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لا توجد طلبات استقالة</p>';
                } else {
                    myResigns.forEach(request => {
                        const date = new Date(request.timestamp);
                        const statusBadge = request.status === 'معلق' ? 
                            '<span class="badge badge-warning">معلق</span>' : 
                            request.status === 'مقبول' ? 
                            '<span class="badge badge-success">مقبول</span>' : 
                            '<span class="badge badge-danger">مرفوض</span>';
                        
                        html += `
                        <div class="border-b py-3 border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center">
                                <div class="text-gray-800 dark:text-white">
                                    <p><strong>التاريخ:</strong> ${date.toLocaleDateString('ar-SA')}</p>
                                    <p><strong>تاريخ إنهاء العمل:</strong> ${request.endDate}</p>
                                    <p><strong>السبب:</strong> ${request.reason}</p>
                                </div>
                                <div>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
            }
            
            content.innerHTML = html;
        }

        // ===== دوال إدارة الحضور =====
        function attendanceLogin() {
            if (currentSession) {
                alert('أنت مسجل دخول بالفعل!');
                return;
            }
            
            if (!checkPermission('attendance')) {
                alert('ليس لديك صلاحية لتسجيل الحضور');
                return;
            }
            
            openModal('confirmLoginModal');
        }
        
        function confirmAttendanceLogin() {
            showLoading(true);
            
            setTimeout(() => {
                try {
                    const newSession = {
                        id: sessions.length > 0 ? Math.max(...sessions.map(s => s.id)) + 1 : 1,
                        userId: currentUser.id,
                        loginTime: new Date().toISOString(),
                        logoutTime: null,
                        totalMinutes: 0,
                        report: ''
                    };
                    
                    sessions.push(newSession);
                    currentSession = newSession;
                    saveData();
                    
                    // إشعار بتسجيل الحضور
                    showNotification(
                        'تسجيل دخول للحضور',
                        `قام ${currentUser.name} بتسجيل الدخول (الحضور)`,
                        'login',
                        true
                    );
                    
                    updateUserPanel();
                    
                    closeModal('confirmLoginModal');
                    showToast('تم تسجيل الدخول بنجاح!', 'success');
                } catch (error) {
                    console.error('خطأ في تسجيل الدخول للحضور:', error);
                    showAlert('حدث خطأ في تسجيل الدخول', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        document.getElementById('logoutForm').addEventListener('submit', function(e) {
            e.preventDefault();
            attendanceLogout();
        });
        
        function attendanceLogout() {
            showLoading(true);
            
            const report = document.getElementById('logoutReport').value.trim();
            
            setTimeout(() => {
                try {
                    if (!report) {
                        alert('يرجى كتابة تقرير العمل اليومي');
                        return;
                    }
                    
                    const loginTime = new Date(currentSession.loginTime);
                    const logoutTime = new Date();
                    const duration = Math.floor((logoutTime - loginTime) / 60000);
                    
                    const sessionIndex = sessions.findIndex(s => s.id === currentSession.id);
                    if (sessionIndex !== -1) {
                        sessions[sessionIndex].logoutTime = logoutTime.toISOString();
                        sessions[sessionIndex].totalMinutes = duration;
                        sessions[sessionIndex].report = report;
                    }
                    
                    logs.push({
                        id: logs.length + 1,
                        userId: currentUser.id,
                        username: currentUser.name,
                        action: 'logout',
                        timestamp: new Date().toISOString(),
                        report: report,
                        duration: duration
                    });
                    
                    saveData();
                    
                    // إشعار بتسجيل الخروج
                    showNotification(
                        'تسجيل خروج من الحضور',
                        `قام ${currentUser.name} بتسجيل الخروج (الحضور) - المدة: ${Math.floor(duration/60)}:${(duration%60).toString().padStart(2,'0')}`,
                        'logout',
                        true
                    );
                    
                    currentSession = null;
                    updateUserPanel();
                    
                    closeModal('logoutModal');
                    document.getElementById('logoutReport').value = '';
                    showToast('تم تسجيل الخروج بنجاح!', 'success');
                } catch (error) {
                    console.error('خطأ في تسجيل الخروج:', error);
                    showAlert('حدث خطأ في تسجيل الخروج', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }

        // ===== دوال إدارة الطلبات =====
        document.getElementById('leaveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitLeaveRequest();
        });
        
        function submitLeaveRequest() {
            if (!checkPermission('leave')) {
                alert('ليس لديك صلاحية لتقديم طلبات إجازة');
                return;
            }
            
            showLoading(true);
            
            const reason = document.getElementById('leaveReason').value.trim();
            const duration = document.getElementById('leaveDuration').value.trim();
            const startDate = document.getElementById('leaveStartDate').value;
            
            setTimeout(() => {
                try {
                    if (!reason || !duration || !startDate) {
                        alert('يرجى ملء جميع الحقول');
                        return;
                    }
                    
                    const newRequest = {
                        id: requests.length > 0 ? Math.max(...requests.map(r => r.id)) + 1 : 1,
                        userId: currentUser.id,
                        username: currentUser.name,
                        department: currentUser.department,
                        type: 'إجازة',
                        reason: reason,
                        duration: duration,
                        startDate: startDate,
                        status: 'معلق',
                        timestamp: new Date().toISOString()
                    };
                    
                    requests.push(newRequest);
                    saveData();
                    
                    // إشعار بطلب إجازة
                    showNotification(
                        'طلب إجازة جديد',
                        `قدم ${currentUser.name} طلب إجازة: ${reason}`,
                        'request',
                        true
                    );
                    
                    closeModal('leaveModal');
                    
                    document.getElementById('leaveReason').value = '';
                    document.getElementById('leaveDuration').value = '';
                    
                    showToast('تم تقديم طلب الإجازة بنجاح!', 'success');
                    
                    updateMyRequestsCount();
                    
                    if (currentUser && currentUser.role === 'admin') {
                        updateAdminStats();
                        loadAdminRequestsTable();
                    }
                } catch (error) {
                    console.error('خطأ في تقديم طلب الإجازة:', error);
                    showAlert('حدث خطأ في تقديم طلب الإجازة', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        document.getElementById('resignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitResignRequest();
        });
        
        function submitResignRequest() {
            if (!checkPermission('resign')) {
                alert('ليس لديك صلاحية لتقديم طلبات استقالة');
                return;
            }
            
            showLoading(true);
            
            const reason = document.getElementById('resignReason').value.trim();
            const endDate = document.getElementById('resignEndDate').value;
            
            setTimeout(() => {
                try {
                    if (!reason || !endDate) {
                        alert('يرجى ملء جميع الحقول');
                        return;
                    }
                    
                    const newRequest = {
                        id: requests.length > 0 ? Math.max(...requests.map(r => r.id)) + 1 : 1,
                        userId: currentUser.id,
                        username: currentUser.name,
                        department: currentUser.department,
                        type: 'استقالة',
                        reason: reason,
                        endDate: endDate,
                        status: 'معلق',
                        timestamp: new Date().toISOString()
                    };
                    
                    requests.push(newRequest);
                    saveData();
                    
                    // إشعار بطلب استقالة
                    showNotification(
                        'طلب استقالة جديد',
                        `قدم ${currentUser.name} طلب استقالة`,
                        'request',
                        true
                    );
                    
                    closeModal('resignModal');
                    
                    document.getElementById('resignReason').value = '';
                    
                    showToast('تم تقديم طلب الاستقالة بنجاح!', 'success');
                    
                    updateMyRequestsCount();
                    
                    if (currentUser && currentUser.role === 'admin') {
                        updateAdminStats();
                        loadAdminRequestsTable();
                    }
                } catch (error) {
                    console.error('خطأ في تقديم طلب الاستقالة:', error);
                    showAlert('حدث خطأ في تقديم طلب الاستقالة', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }

        // ===== دوال تحديث واجهة المستخدم =====
        function updateUserPanel() {
            if (!currentUser) return;
            
            document.getElementById('userGreeting').textContent = `مرحباً ${currentUser.name}`;
            document.getElementById('userDisplayName').textContent = currentUser.name;
            document.getElementById('userDisplayDepartment').textContent = currentUser.department;
            document.getElementById('userDisplayPhone').textContent = currentUser.phone;
            
            const statusIcon = document.getElementById('userStatusIcon');
            const statusText = document.getElementById('userStatusText');
            const loginBtn = document.getElementById('attendanceLoginBtn');
            const logoutBtn = document.getElementById('attendanceLogoutBtn');
            
            if (currentSession) {
                statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                statusText.textContent = 'مسجل دخول';
                statusText.className = 'badge badge-success';
                loginBtn.disabled = true;
                logoutBtn.disabled = false;
            } else {
                statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                statusText.textContent = 'غير مسجل';
                statusText.className = 'badge badge-danger';
                loginBtn.disabled = false;
                logoutBtn.disabled = true;
            }
            
            updateUserInterface();
            updateUserStats();
            updateUserAttendanceTable();
            updateCurrentTime();
            updateMyRequestsCount();
        }
        
        function updateUserStats() {
            try {
                const userSessions = sessions.filter(s => s.userId === currentUser.id && s.logoutTime);
                
                const uniqueDays = new Set(userSessions.map(s => s.loginTime.split('T')[0])).size;
                const totalMinutes = userSessions.reduce((sum, session) => sum + (session.totalMinutes || 0), 0);
                const totalHours = (totalMinutes / 60).toFixed(1);
                const avgHours = uniqueDays > 0 ? (totalMinutes / uniqueDays / 60).toFixed(1) : 0;
                
                document.getElementById('userDays').textContent = uniqueDays;
                document.getElementById('userHours').textContent = totalHours;
                document.getElementById('userAvg').textContent = avgHours;
            } catch (error) {
                console.error('خطأ في تحديث إحصائيات المستخدم:', error);
            }
        }
        
        function updateUserAttendanceTable() {
            try {
                const table = document.getElementById('userAttendanceTable');
                const userSessions = sessions
                    .filter(s => s.userId === currentUser.id && s.logoutTime)
                    .sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime))
                    .slice(0, 10);
                
                let html = '';
                
                if (userSessions.length === 0) {
                    html = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>لا توجد سجلات حضور سابقة</p>
                        </td>
                    </tr>
                    `;
                } else {
                    userSessions.forEach(session => {
                        const loginDate = new Date(session.loginTime);
                        const logoutDate = new Date(session.logoutTime);
                        
                        const dateStr = loginDate.toLocaleDateString('ar-SA');
                        const loginTimeStr = loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                        const logoutTimeStr = logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                        const durationStr = session.totalMinutes ? `${Math.floor(session.totalMinutes / 60)}:${(session.totalMinutes % 60).toString().padStart(2, '0')}` : '-';
                        
                        html += `
                        <tr>
                            <td class="text-gray-800 dark:text-white">${dateStr}</td>
                            <td class="text-gray-800 dark:text-white">${loginTimeStr}</td>
                            <td class="text-gray-800 dark:text-white">${logoutTimeStr}</td>
                            <td class="text-gray-800 dark:text-white">${durationStr}</td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحديث جدول الحضور:', error);
                document.getElementById('userAttendanceTable').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-red-500 py-4">
                            خطأ في تحميل سجلات الحضور
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateStr = now.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                if (document.getElementById('currentTime')) {
                    document.getElementById('currentTime').textContent = `${dateStr} - ${timeStr}`;
                }
                if (document.getElementById('adminCurrentTime')) {
                    document.getElementById('adminCurrentTime').textContent = `${dateStr} - ${timeStr}`;
                }
            } catch (error) {
                console.error('خطأ في تحديث الوقت:', error);
            }
        }

        // ===== دوال لوحة المدير =====
        function updateAdminPanel() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            document.getElementById('adminGreeting').textContent = `مرحباً ${currentUser.name}`;
            
            updateAdminStats();
            loadAdminUsersTable();
            loadAdminAttendanceTable();
            loadAdminRequestsTable();
            loadReports();
            loadRolesList();
            loadNotificationsHistory();
        }
        
        function updateAdminStats() {
            try {
                const totalUsers = users.filter(u => u.id !== currentUser?.id).length;
                const activeUsers = sessions.filter(s => !s.logoutTime).length;
                const pendingRequests = requests.filter(r => r.status === 'معلق').length;
                
                document.getElementById('adminTotalUsers').textContent = totalUsers;
                document.getElementById('adminActiveUsers').textContent = activeUsers;
                document.getElementById('adminPendingRequests').textContent = pendingRequests;
                document.getElementById('adminRankChanges').textContent = 0;
            } catch (error) {
                console.error('خطأ في تحديث إحصائيات المدير:', error);
            }
        }
        
        function showAdminTab(tabId) {
            try {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(tabId + 'Tab').classList.add('active');
                event.target.classList.add('active');
                
                if (tabId === 'users') {
                    loadAdminUsersTable();
                } else if (tabId === 'roles') {
                    loadRolesList();
                } else if (tabId === 'attendance') {
                    loadAdminAttendanceTable();
                } else if (tabId === 'requests') {
                    loadAdminRequestsTable();
                } else if (tabId === 'reports') {
                    loadReports();
                } else if (tabId === 'notifications') {
                    loadNotificationsHistory();
                }
            } catch (error) {
                console.error('خطأ في تبديل تبويبات المدير:', error);
            }
        }
        
        function loadAdminUsersTable() {
            try {
                const table = document.getElementById('adminUsersTable');
                const searchTerm = document.getElementById('searchUsers')?.value.toLowerCase() || '';
                
                let filteredUsers = users;
                
                if (searchTerm) {
                    filteredUsers = filteredUsers.filter(user => 
                        user.name.toLowerCase().includes(searchTerm) ||
                        user.phone.includes(searchTerm) ||
                        (user.department && user.department.toLowerCase().includes(searchTerm)) ||
                        (user.role && user.role.toLowerCase().includes(searchTerm))
                    );
                }
                
                let html = '';
                
                if (filteredUsers.length === 0) {
                    html = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>لا يوجد موظفين مسجلين</p>
                            <p class="text-sm text-gray-500">${searchTerm ? 'لم يتم العثور على نتائج للبحث' : 'قم بإضافة أول موظف'}</p>
                            ${!searchTerm ? `
                            <button onclick="openModal('registerModal')" class="btn btn-success mt-2">
                                <i class="fas fa-user-plus ml-2"></i> إضافة أول موظف
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                    `;
                } else {
                    filteredUsers.forEach(user => {
                        const roleInfo = getRoleInfo(user.role);
                        const isActive = sessions.some(s => s.userId === user.id && !s.logoutTime);
                        const statusBadge = isActive ? 
                            '<span class="badge badge-success">نشط</span>' : 
                            '<span class="badge badge-secondary">غير نشط</span>';
                        
                        const userPermissions = user.permissions || roleInfo.permissions;
                        const grantedPermissions = Object.values(userPermissions).filter(p => p === true).length;
                        const totalPermissions = Object.keys(userPermissions).length;
                        
                        html += `
                        <tr>
                            <td class="text-gray-800 dark:text-white">${user.name}</td>
                            <td><span class="role-badge ${roleInfo.badgeClass}">${roleInfo.name}</span></td>
                            <td class="text-gray-800 dark:text-white">${user.rank || roleInfo.name}</td>
                            <td class="text-gray-800 dark:text-white">${user.phone}</td>
                            <td>${statusBadge}</td>
                            <td class="text-gray-800 dark:text-white">
                                <span class="text-sm">${grantedPermissions}/${totalPermissions}</span>
                                <button onclick="viewUserPermissions(${user.id})" class="btn btn-info btn-sm mr-2">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                            <td>
                                <button onclick="openEditPermissions(${user.id})" class="btn btn-primary btn-sm mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteUser(${user.id}, '${user.name.replace(/'/g, "\\'")}')" class="btn btn-danger btn-sm" ${!checkPermission('deleteUsers') || (currentUser && currentUser.id === user.id) ? 'disabled style="opacity:0.5;"' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحميل جدول المستخدمين:', error);
                document.getElementById('adminUsersTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-red-500 py-4">
                            خطأ في تحميل بيانات المستخدمين
                        </td>
                    </tr>
                `;
            }
        }
        
        function viewUserPermissions(userId) {
            try {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const roleInfo = getRoleInfo(user.role);
                const permissions = user.permissions || roleInfo.permissions;
                
                let html = `
                    <h4 class="font-bold mb-2">${user.name}</h4>
                    <p><strong>الدور:</strong> ${roleInfo.name}</p>
                    <p><strong>الرتبة:</strong> ${user.rank || roleInfo.name}</p>
                    <p><strong>القسم:</strong> ${user.department || 'غير محدد'}</p>
                    <hr class="my-3">
                    <p><strong>الصلاحيات الممنوحة:</strong></p>
                    <ul class="list-disc pr-5 mt-2">
                `;
                
                for (const key in permissionNames) {
                    if (permissions[key]) {
                        html += `<li class="text-green-600">✓ ${permissionNames[key]}</li>`;
                    } else {
                        html += `<li class="text-gray-400">✗ ${permissionNames[key]}</li>`;
                    }
                }
                
                html += `</ul>`;
                
                document.getElementById('requestDetailsTitle').textContent = `صلاحيات الموظف: ${user.name}`;
                document.getElementById('requestDetailsContent').innerHTML = html;
                openModal('requestDetailsModal');
            } catch (error) {
                console.error('خطأ في عرض صلاحيات المستخدم:', error);
                alert('حدث خطأ في عرض الصلاحيات');
            }
        }
        
        function openEditPermissions(userId) {
            try {
                userId = parseInt(userId);
                
                const user = users.find(u => u.id === userId);
                
                if (!user) {
                    alert('المستخدم غير موجود');
                    return;
                }
                
                userToEditPermissions = userId;
                document.getElementById('editUserName').textContent = user.name;
                
                const roleInfo = getRoleInfo(user.role);
                document.getElementById('editUserRole').textContent = roleInfo.name;
                document.getElementById('editUserRole').className = `badge badge-info`;
                
                editingPermissions = {...user.permissions};
                
                let html = '';
                
                for (const key in permissionNames) {
                    const hasPermission = editingPermissions[key] === true;
                    const permissionName = permissionNames[key];
                    
                    html += `
                    <div class="permission-item">
                        <div class="permission-label text-gray-800 dark:text-white">
                            ${permissionName}
                        </div>
                        <div class="permission-buttons">
                            <button onclick="togglePermission('${key}')" 
                                    class="btn btn-success btn-sm ${hasPermission ? 'hidden' : ''}" id="addBtn_${key}">
                                <i class="fas fa-plus"></i> إضافة
                            </button>
                            <button onclick="togglePermission('${key}')" 
                                    class="btn btn-danger btn-sm ${!hasPermission ? 'hidden' : ''}" id="removeBtn_${key}">
                                <i class="fas fa-minus"></i> إزالة
                            </button>
                        </div>
                    </div>
                    `;
                }
                
                document.getElementById('permissionsList').innerHTML = html;
                openModal('editPermissionsModal');
            } catch (error) {
                console.error('خطأ في فتح تعديل الصلاحيات:', error);
                alert('حدث خطأ في فتح صفحة تعديل الصلاحيات');
            }
        }
        
        function togglePermission(permissionKey) {
            try {
                editingPermissions[permissionKey] = !editingPermissions[permissionKey];
                
                const addBtn = document.getElementById(`addBtn_${permissionKey}`);
                const removeBtn = document.getElementById(`removeBtn_${permissionKey}`);
                
                if (editingPermissions[permissionKey]) {
                    addBtn.classList.add('hidden');
                    removeBtn.classList.remove('hidden');
                } else {
                    removeBtn.classList.add('hidden');
                    addBtn.classList.remove('hidden');
                }
            } catch (error) {
                console.error('خطأ في تبديل الصلاحية:', error);
            }
        }
        
        function savePermissions() {
            if (!userToEditPermissions) return;
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    const userIndex = users.findIndex(u => u.id === userToEditPermissions);
                    if (userIndex !== -1) {
                        users[userIndex].permissions = editingPermissions;
                        
                        let newRole = 'employee';
                        
                        if (editingPermissions.addUsers && editingPermissions.editPermissions && 
                            editingPermissions.processRequests && editingPermissions.viewReports) {
                            newRole = 'admin';
                        } else if (editingPermissions.processRequests && editingPermissions.viewReports) {
                            newRole = 'manager';
                        } else if (editingPermissions.viewTeamAttendance && editingPermissions.viewTeamRequests) {
                            newRole = 'supervisor';
                        }
                        
                        users[userIndex].role = newRole;
                        
                        saveData();
                        
                        // إشعار بتعديل الصلاحيات
                        if (currentUser) {
                            showNotification(
                                'تعديل صلاحيات',
                                `قام ${currentUser.name} بتعديل صلاحيات الموظف ${users[userIndex].name}`,
                                'admin',
                                true
                            );
                        }
                        
                        if (currentUser && currentUser.id === userToEditPermissions) {
                            currentUser = users[userIndex];
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            updateUserInterface();
                        }
                        
                        loadAdminUsersTable();
                        
                        closeModal('editPermissionsModal');
                        showToast('تم تحديث صلاحيات الموظف بنجاح!', 'success');
                    }
                } catch (error) {
                    console.error('خطأ في حفظ الصلاحيات:', error);
                    showAlert('حدث خطأ في حفظ الصلاحيات', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }
        
        function loadAdminAttendanceTable() {
            try {
                const table = document.getElementById('adminAttendanceTable');
                const allSessions = sessions
                    .sort((a, b) => new Date(b.loginTime) - new Date(a.loginTime));
                
                let html = '';
                
                if (allSessions.length === 0) {
                    html = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>لا توجد سجلات حضور</p>
                            <p class="text-sm text-gray-500">سيظهر هنا سجلات الدخول والخروج للموظفين</p>
                        </td>
                    </tr>
                    `;
                } else {
                    allSessions.forEach(session => {
                        const user = users.find(u => u.id === session.userId);
                        if (!user) return;
                        
                        const roleInfo = getRoleInfo(user.role);
                        const loginDate = new Date(session.loginTime);
                        const logoutDate = session.logoutTime ? new Date(session.logoutTime) : null;
                        
                        const dateStr = loginDate.toLocaleDateString('ar-SA');
                        const loginTimeStr = loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                        const logoutTimeStr = logoutDate ? logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '-';
                        const durationStr = session.totalMinutes ? `${Math.floor(session.totalMinutes / 60)}:${(session.totalMinutes % 60).toString().padStart(2, '0')}` : '-';
                        const reportShort = session.report ? (session.report.length > 30 ? session.report.substring(0, 30) + '...' : session.report) : '-';
                        
                        let statusBadge = session.logoutTime ? 
                            '<span class="badge badge-success">مكتمل</span>' : 
                            '<span class="badge badge-warning">قيد العمل</span>';
                        
                        html += `
                        <tr>
                            <td class="text-gray-800 dark:text-white">${user.name}</td>
                            <td class="text-gray-800 dark:text-white">${user.rank || roleInfo.name}</td>
                            <td class="text-gray-800 dark:text-white">${dateStr}</td>
                            <td class="text-gray-800 dark:text-white">${loginTimeStr}</td>
                            <td class="text-gray-800 dark:text-white">${logoutTimeStr}</td>
                            <td class="text-gray-800 dark:text-white">${durationStr}</td>
                            <td class="text-gray-800 dark:text-white">
                                ${reportShort && reportShort !== '-' ? `
                                <button onclick="viewReportDetails(${session.id})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                    ${reportShort}
                                </button>
                                ` : '-'}
                            </td>
                            <td>${statusBadge}</td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحميل جدول الحضور:', error);
                document.getElementById('adminAttendanceTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-red-500 py-4">
                            خطأ في تحميل سجلات الحضور
                        </td>
                    </tr>
                `;
            }
        }
        
        function viewReportDetails(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;
                
                const user = users.find(u => u.id === session.userId);
                const loginDate = new Date(session.loginTime);
                const logoutDate = session.logoutTime ? new Date(session.logoutTime) : null;
                
                let html = `
                    <p><strong>الموظف:</strong> ${user?.name || 'غير معروف'}</p>
                    <p><strong>الرتبة:</strong> ${user?.rank || 'غير محدد'}</p>
                    <p><strong>تاريخ:</strong> ${loginDate.toLocaleDateString('ar-SA')}</p>
                    <p><strong>وقت الدخول:</strong> ${loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</p>
                    <p><strong>وقت الخروج:</strong> ${logoutDate ? logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : 'لم يسجل خروج'}</p>
                    <p><strong>المدة:</strong> ${session.totalMinutes ? `${Math.floor(session.totalMinutes / 60)} ساعة و ${session.totalMinutes % 60} دقيقة` : '-'}</p>
                    <hr class="my-3">
                    <p><strong>تقرير العمل:</strong></p>
                    <p class="mt-2">${session.report || 'لا يوجد تقرير'}</p>
                `;
                
                document.getElementById('reportDetailsContent').innerHTML = html;
                openModal('reportDetailsModal');
            } catch (error) {
                console.error('خطأ في عرض تفاصيل التقرير:', error);
                alert('حدث خطأ في عرض التقرير');
            }
        }
        
        function loadAdminRequestsTable() {
            try {
                const table = document.getElementById('adminRequestsTable');
                const allRequests = requests
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = '';
                
                if (allRequests.length === 0) {
                    html = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>لا توجد طلبات</p>
                            <p class="text-sm text-gray-500">ستظهر هنا طلبات الإجازة والاستقالة من الموظفين</p>
                        </td>
                    </tr>
                    `;
                } else {
                    allRequests.forEach(request => {
                        const user = users.find(u => u.id === request.userId);
                        const roleInfo = user ? getRoleInfo(user.role) : getRoleInfo('employee');
                        
                        const date = new Date(request.timestamp);
                        const dateStr = date.toLocaleDateString('ar-SA');
                        
                        let statusBadge = '';
                        if (request.status === 'معلق') {
                            statusBadge = '<span class="badge badge-warning">معلق</span>';
                        } else if (request.status === 'مقبول') {
                            statusBadge = '<span class="badge badge-success">مقبول</span>';
                        } else {
                            statusBadge = '<span class="badge badge-danger">مرفوض</span>';
                        }
                        
                        const reasonShort = request.reason.length > 30 ? request.reason.substring(0, 30) + '...' : request.reason;
                        
                        let actionBtn = '';
                        if (request.status === 'معلق') {
                            actionBtn = `
                                <button onclick="viewRequestDetails(${request.id})" class="btn btn-primary btn-sm mr-2">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="processUserRequest(${request.id})" class="btn btn-warning btn-sm">
                                    معالجة
                                </button>
                            `;
                        } else {
                            actionBtn = `
                                <button onclick="viewRequestDetails(${request.id})" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <span class="text-gray-500 dark:text-gray-400 text-sm">تمت المعالجة</span>
                            `;
                        }
                        
                        html += `
                        <tr>
                            <td class="text-gray-800 dark:text-white">${request.username}</td>
                            <td class="text-gray-800 dark:text-white">${user?.rank || roleInfo.name}</td>
                            <td class="text-gray-800 dark:text-white">${request.type}</td>
                            <td class="text-gray-800 dark:text-white" title="${request.reason}">${reasonShort}</td>
                            <td class="text-gray-800 dark:text-white">${dateStr}</td>
                            <td>${statusBadge}</td>
                            <td>${actionBtn}</td>
                        </tr>
                        `;
                    });
                }
                
                table.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحميل جدول الطلبات:', error);
                document.getElementById('adminRequestsTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-red-500 py-4">
                            خطأ في تحميل طلبات الموظفين
                        </td>
                    </tr>
                `;
            }
        }
        
        function viewRequestDetails(requestId) {
            try {
                const request = requests.find(r => r.id === requestId);
                if (!request) return;
                
                const date = new Date(request.timestamp);
                const dateStr = date.toLocaleDateString('ar-SA') + ' ' + 
                               date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                
                let details = '';
                if (request.type === 'إجازة') {
                    details = `
                        <p><strong>نوع الطلب:</strong> ${request.type}</p>
                        <p><strong>الموظف:</strong> ${request.username}</p>
                        <p><strong>القسم:</strong> ${request.department}</p>
                        <p><strong>سبب الإجازة:</strong> ${request.reason}</p>
                        <p><strong>المدة:</strong> ${request.duration}</p>
                        <p><strong>تاريخ البدء:</strong> ${request.startDate}</p>
                        <p><strong>تاريخ الطلب:</strong> ${dateStr}</p>
                        <p><strong>الحالة:</strong> ${request.status}</p>
                    `;
                } else if (request.type === 'استقالة') {
                    details = `
                        <p><strong>نوع الطلب:</strong> ${request.type}</p>
                        <p><strong>الموظف:</strong> ${request.username}</p>
                        <p><strong>القسم:</strong> ${request.department}</p>
                        <p><strong>سبب الاستقالة:</strong> ${request.reason}</p>
                        <p><strong>تاريخ إنهاء العمل:</strong> ${request.endDate}</p>
                        <p><strong>تاريخ الطلب:</strong> ${dateStr}</p>
                        <p><strong>الحالة:</strong> ${request.status}</p>
                    `;
                }
                
                document.getElementById('requestDetailsTitle').textContent = `تفاصيل الطلب`;
                document.getElementById('requestDetailsContent').innerHTML = details;
                openModal('requestDetailsModal');
            } catch (error) {
                console.error('خطأ في عرض تفاصيل الطلب:', error);
                alert('حدث خطأ في عرض تفاصيل الطلب');
            }
        }
        
        function filterRequests() {
            try {
                const typeFilter = document.getElementById('filterRequestType').value;
                const statusFilter = document.getElementById('filterRequestStatus').value;
                const rows = document.querySelectorAll('#adminRequestsTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 7) return;
                    
                    const type = row.cells[2].textContent;
                    const status = row.cells[5].querySelector('span')?.textContent || '';
                    
                    const typeMatch = !typeFilter || type === typeFilter;
                    const statusMatch = !statusFilter || status === statusFilter;
                    
                    row.style.display = (typeMatch && statusMatch) ? '' : 'none';
                });
            } catch (error) {
                console.error('خطأ في تصفية الطلبات:', error);
            }
        }
        
        function processUserRequest(requestId) {
            try {
                requestToProcess = requestId;
                const request = requests.find(r => r.id === requestId);
                if (!request) return;
                
                document.getElementById('processMessage').textContent = `معالجة طلب ${request.type} للموظف "${request.username}"`;
                openModal('processModal');
            } catch (error) {
                console.error('خطأ في معالجة الطلب:', error);
                alert('حدث خطأ في معالجة الطلب');
            }
        }
        
        function showRejectReason() {
            try {
                document.getElementById('processReasonField').style.display = 'block';
            } catch (error) {
                console.error('خطأ في عرض سبب الرفض:', error);
            }
        }
        
        function processRequest(status) {
            if (!requestToProcess) return;
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    const requestIndex = requests.findIndex(r => r.id === requestToProcess);
                    if (requestIndex !== -1) {
                        requests[requestIndex].status = status;
                        
                        if (status === 'مرفوض') {
                            const rejectReason = document.getElementById('rejectReason').value.trim();
                            if (rejectReason) {
                                requests[requestIndex].rejectReason = rejectReason;
                            }
                        }
                        
                        saveData();
                        
                        // إشعار بمعالجة الطلب
                        const request = requests[requestIndex];
                        showNotification(
                            'معالجة طلب',
                            `تم ${status === 'مقبول' ? 'قبول' : 'رفض'} طلب ${request.type} للموظف ${request.username}`,
                            'admin',
                            true
                        );
                        
                        loadAdminRequestsTable();
                        updateAdminStats();
                        
                        closeModal('processModal');
                        showToast(`تم ${status === 'مقبول' ? 'قبول' : 'رفض'} الطلب بنجاح!`, 'success');
                    }
                } catch (error) {
                    console.error('خطأ في معالجة الطلب:', error);
                    showAlert('حدث خطأ في معالجة الطلب', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }

        // ===== دوال إدارة الرتب =====
        function getAllRoles() {
            return { ...rolePermissions, ...customRoles };
        }
        
        function getRoleInfo(roleKey) {
            const allRoles = getAllRoles();
            return allRoles[roleKey] || rolePermissions.employee;
        }
        
        function loadRolesList() {
            try {
                const rolesList = document.getElementById('rolesList');
                if (!rolesList) return;
                
                let html = '';
                
                const allRoles = getAllRoles();
                
                Object.entries(allRoles).forEach(([roleKey, role]) => {
                    const isSelected = currentEditingRole === roleKey;
                    const isCustom = customRoles[roleKey];
                    
                    html += `
                        <div class="role-item ${isSelected ? 'selected' : ''}" 
                             onclick="editRole('${roleKey}')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-lg">${role.name}</h4>
                                    <div class="flex gap-2 items-center">
                                        <p class="text-sm text-gray-500">${roleKey}</p>
                                        ${isCustom ? 
                                            '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">مخصصة</span>' : 
                                            '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">أساسية</span>'}
                                    </div>
                                </div>
                                <span class="${isSelected ? 'text-white' : 'text-blue-500'}">
                                    <i class="fas fa-chevron-left"></i>
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                rolesList.innerHTML = html;
                
                if (!currentEditingRole && Object.keys(allRoles).length > 0) {
                    const firstRole = Object.keys(allRoles)[0];
                    editRole(firstRole);
                }
            } catch (error) {
                console.error('خطأ في تحميل قائمة الرتب:', error);
            }
        }
        
        function editRole(roleKey) {
            try {
                roleKey = roleKey.replace(/['"]/g, '');
                currentEditingRole = roleKey;
                const allRoles = getAllRoles();
                const role = allRoles[roleKey];
                
                if (!role) {
                    alert(`الرتبة ${roleKey} غير موجودة`);
                    return;
                }
                
                document.getElementById('editRoleName').value = role.name;
                document.getElementById('editingRoleTitle').textContent = `تعديل صلاحيات: ${role.name}`;
                
                let permissionsHtml = '';
                for (const key in permissionNames) {
                    const hasPermission = role.permissions ? (role.permissions[key] === true) : false;
                    permissionsHtml += `
                        <div class="flex items-center justify-between p-2 border-b border-gray-200 dark:border-gray-700">
                            <span class="text-gray-800 dark:text-white">${permissionNames[key]}</span>
                            <input type="checkbox" 
                                   id="perm_${key}" 
                                   ${hasPermission ? 'checked' : ''}
                                   class="w-5 h-5 rounded text-blue-600 dark:text-blue-400">
                        </div>
                    `;
                }
                
                document.getElementById('rolePermissionsList').innerHTML = permissionsHtml;
                
                const deleteBtn = document.getElementById('deleteRoleBtn');
                if (deleteBtn) {
                    const isCustomRole = customRoles[roleKey];
                    deleteBtn.disabled = !isCustomRole;
                    deleteBtn.title = isCustomRole ? "حذف الرتبة المخصصة" : "لا يمكن حذف الرتبة الأساسية";
                }
                
                document.querySelectorAll('#rolesList .role-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                const selectedItem = document.querySelector(`[onclick*="${roleKey}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
            } catch (error) {
                console.error('خطأ في editRole:', error);
                alert('حدث خطأ في تحميل الرتبة');
            }
        }
        
        function saveRolePermissions() {
            if (!currentEditingRole) return;
            
            const roleKey = currentEditingRole;
            const allRoles = getAllRoles();
            const role = allRoles[roleKey];
            
            if (!role) {
                alert('الرتبة غير موجودة');
                return;
            }
            
            for (const key in permissionNames) {
                const checkbox = document.getElementById(`perm_${key}`);
                role.permissions[key] = checkbox.checked;
            }
            
            if (rolePermissions[roleKey]) {
                rolePermissions[roleKey].permissions = { ...role.permissions };
            } else if (customRoles[roleKey]) {
                customRoles[roleKey].permissions = { ...role.permissions };
            }
            
            users.forEach(user => {
                if (user.role === roleKey) {
                    user.permissions = { ...role.permissions };
                }
            });
            
            saveData();
            
            // إشعار بتعديل الرتبة
            if (currentUser) {
                showNotification(
                    'تعديل رتبة',
                    `قام ${currentUser.name} بتعديل صلاحيات رتبة ${role.name}`,
                    'admin',
                    true
                );
            }
            
            if (currentUser && currentUser.role === roleKey) {
                currentUser.permissions = { ...role.permissions };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUserInterface();
            }
            
            showToast('تم تحديث صلاحيات الرتبة بنجاح!', 'success');
        }
        
        function deleteRole() {
            if (!currentEditingRole) return;
            
            const roleKey = currentEditingRole;
            
            if (rolePermissions[roleKey]) {
                alert('لا يمكن حذف الرتب الأساسية. يمكنك فقط تعديل صلاحياتها.');
                return;
            }
            
            if (customRoles[roleKey]) {
                if (confirm(`هل أنت متأكد من حذف الرتبة "${customRoles[roleKey].name}"؟`)) {
                    const usersWithThisRole = users.filter(u => u.role === roleKey);
                    
                    if (usersWithThisRole.length > 0) {
                        alert(`لا يمكن حذف الرتبة لأن ${usersWithThisRole.length} موظف يستخدمونها. قم بتغيير رتبتهم أولاً.`);
                        return;
                    }
                    
                    delete customRoles[roleKey];
                    currentEditingRole = null;
                    saveData();
                    
                    // إشعار بحذف الرتبة
                    if (currentUser) {
                        showNotification(
                            'حذف رتبة',
                            `قام ${currentUser.name} بحذف رتبة ${customRoles[roleKey]?.name || roleKey}`,
                            'admin',
                            true
                        );
                    }
                    
                    document.getElementById('editRoleName').value = '';
                    document.getElementById('editingRoleTitle').textContent = 'تعديل صلاحيات الرتبة';
                    document.getElementById('rolePermissionsList').innerHTML = '';
                    document.getElementById('deleteRoleBtn').disabled = true;
                    
                    loadRolesList();
                    
                    showToast('تم حذف الرتبة بنجاح!', 'success');
                }
            }
        }
        
        document.getElementById('addRoleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewRole();
        });
        
        function addNewRole() {
            try {
                const name = document.getElementById('newRoleName').value.trim();
                const key = document.getElementById('newRoleKey').value.trim();
                
                if (!name || !key) {
                    showAlert('يرجى ملء جميع الحقول', 'error');
                    return;
                }
                
                const allRoles = getAllRoles();
                if (allRoles[key]) {
                    showAlert('مفتاح الرتبة موجود مسبقاً', 'error');
                    return;
                }
                
                const newRole = {
                    name: name,
                    badgeClass: "role-badge-custom",
                    permissions: {
                        attendance: true,
                        leave: true,
                        resign: true,
                        viewHistory: true,
                        viewStats: true,
                        viewTeamAttendance: false,
                        viewTeamRequests: false,
                        addUsers: false,
                        editPermissions: false,
                        viewAllAttendance: false,
                        processRequests: false,
                        viewReports: false,
                        deleteUsers: false,
                        requestPromotion: false
                    }
                };
                
                customRoles[key] = newRole;
                saveData();
                
                // إشعار بإضافة رتبة جديدة
                if (currentUser) {
                    showNotification(
                        'إضافة رتبة جديدة',
                        `قام ${currentUser.name} بإضافة رتبة جديدة: ${name}`,
                        'admin',
                        true
                    );
                }
                
                document.getElementById('newRoleName').value = '';
                document.getElementById('newRoleKey').value = '';
                closeModal('addRoleModal');
                
                loadRolesList();
                
                showToast('تم إضافة الرتبة الجديدة بنجاح!', 'success');
            } catch (error) {
                console.error('خطأ في إضافة رتبة جديدة:', error);
                showAlert('حدث خطأ في إضافة الرتبة الجديدة', 'error');
            }
        }

        // ===== دوال التقارير =====
        function loadReports() {
            try {
                const userStats = users
                    .filter(u => u.role !== 'admin')
                    .map(user => {
                        const userSessions = sessions.filter(s => s.userId === user.id && s.logoutTime);
                        const totalMinutes = userSessions.reduce((sum, session) => sum + (session.totalMinutes || 0), 0);
                        return { user, totalMinutes };
                    })
                    .sort((a, b) => b.totalMinutes - a.totalMinutes)
                    .slice(0, 5);
                
                let topUsersHtml = '';
                if (userStats.length === 0) {
                    topUsersHtml = '<p class="text-gray-500 dark:text-gray-400 text-center">لا توجد بيانات عن الموظفين</p>';
                } else {
                    userStats.forEach((stat, index) => {
                        const hours = (stat.totalMinutes / 60).toFixed(1);
                        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '👤';
                        topUsersHtml += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                            <div class="text-gray-800 dark:text-white">
                                <span class="ml-2">${medal}</span>
                                <span>${stat.user.name}</span>
                                <span class="text-gray-500 dark:text-gray-400 text-sm">(${stat.user.rank})</span>
                            </div>
                            <span class="font-bold text-gray-800 dark:text-white">${hours} ساعة</span>
                        </div>
                        `;
                    });
                }
                
                document.getElementById('topEmployeesList').innerHTML = topUsersHtml;
                
                const ranks = {};
                users.forEach(user => {
                    if (user.role !== 'admin') {
                        const rank = user.rank || 'موظف عادي';
                        if (!ranks[rank]) ranks[rank] = { count: 0, hours: 0 };
                        ranks[rank].count++;
                        
                        const userSessions = sessions.filter(s => s.userId === user.id && s.logoutTime);
                        const totalMinutes = userSessions.reduce((sum, session) => sum + (session.totalMinutes || 0), 0);
                        ranks[rank].hours += totalMinutes / 60;
                    }
                });
                
                let rankStatsHtml = '';
                for (const [rank, data] of Object.entries(ranks)) {
                    rankStatsHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                        <span class="text-gray-800 dark:text-white">${rank}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500 dark:text-gray-400">${data.count} موظف</span>
                            <span class="font-bold text-gray-800 dark:text-white">${data.hours.toFixed(1)} ساعة</span>
                        </div>
                    </div>
                    `;
                }
                
                if (Object.keys(ranks).length === 0) {
                    rankStatsHtml = '<p class="text-gray-500 dark:text-gray-400 text-center">لا توجد بيانات عن الرتب</p>';
                }
                
                document.getElementById('rankStats').innerHTML = rankStatsHtml;
                
                const today = new Date();
                const lastWeek = new Date();
                lastWeek.setDate(lastWeek.getDate() - 7);
                
                document.getElementById('reportFromDate').value = lastWeek.toISOString().split('T')[0];
                document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
                
                document.getElementById('attendanceReportResult').innerHTML = '';
            } catch (error) {
                console.error('خطأ في تحميل التقارير:', error);
            }
        }
        
        function generateAttendanceReport() {
            try {
                const fromDate = document.getElementById('reportFromDate').value;
                const toDate = document.getElementById('reportToDate').value;
                
                if (!fromDate || !toDate) {
                    alert('يرجى تحديد تاريخ البداية والنهاية');
                    return;
                }
                
                const filteredSessions = sessions.filter(s => {
                    const sessionDate = s.loginTime.split('T')[0];
                    return sessionDate >= fromDate && sessionDate <= toDate && s.logoutTime;
                });
                
                if (filteredSessions.length === 0) {
                    document.getElementById('attendanceReportResult').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle ml-1"></i>
                            لا توجد سجلات حضور في الفترة المحددة
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 text-gray-800 dark:text-white">تقرير الحضور من ${fromDate} إلى ${toDate}</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800 dark:text-white">${filteredSessions.length}</div>
                                <div class="text-gray-600 dark:text-gray-400">سجلات حضور</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800 dark:text-white">${new Set(filteredSessions.map(s => s.userId)).size}</div>
                                <div class="text-gray-600 dark:text-gray-400">موظف</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800 dark:text-white">${(filteredSessions.reduce((sum, s) => sum + s.totalMinutes, 0) / 60).toFixed(1)}</div>
                                <div class="text-gray-600 dark:text-gray-400">إجمالي الساعات</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800 dark:text-white">${(filteredSessions.reduce((sum, s) => sum + s.totalMinutes, 0) / filteredSessions.length / 60).toFixed(1)}</div>
                                <div class="text-gray-600 dark:text-gray-400">متوسط اليوم</div>
                            </div>
                        </div>
                        <button onclick="downloadReport(${JSON.stringify(filteredSessions).replace(/"/g, '&quot;')}, '${fromDate}', '${toDate}')" 
                                class="btn btn-success mt-2">
                            <i class="fas fa-download ml-2"></i> تحميل التقرير
                        </button>
                    </div>
                `;
                
                document.getElementById('attendanceReportResult').innerHTML = html;
            } catch (error) {
                console.error('خطأ في إنشاء التقرير:', error);
                document.getElementById('attendanceReportResult').innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle ml-1"></i>
                        حدث خطأ في إنشاء التقرير
                    </div>
                `;
            }
        }
        
        function downloadReport(sessionsData, fromDate, toDate) {
            try {
                let reportText = `تقرير الحضور والانصراف\n`;
                reportText += `من: ${fromDate} إلى: ${toDate}\n`;
                reportText += `========================\n\n`;
                
                sessionsData.forEach(session => {
                    const user = users.find(u => u.id === session.userId);
                    const loginDate = new Date(session.loginTime);
                    const logoutDate = new Date(session.logoutTime);
                    
                    reportText += `الموظف: ${user?.name || 'غير معروف'}\n`;
                    reportText += `الرتبة: ${user?.rank || 'غير محدد'}\n`;
                    reportText += `التاريخ: ${loginDate.toLocaleDateString('ar-SA')}\n`;
                    reportText += `الدخول: ${loginDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n`;
                    reportText += `الخروج: ${logoutDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n`;
                    reportText += `المدة: ${Math.floor(session.totalMinutes / 60)}:${(session.totalMinutes % 60).toString().padStart(2, '0')}\n`;
                    reportText += `تقرير العمل: ${session.report || 'لا يوجد'}\n`;
                    reportText += `------------------------\n`;
                });
                
                const blob = new Blob([reportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `تقرير_الحضور_${fromDate}_إلى_${toDate}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('تم تحميل التقرير بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تحميل التقرير:', error);
                showAlert('حدث خطأ في تحميل التقرير', 'error');
            }
        }

        // ===== دوال إدارة الموظفين =====
        function deleteUser(userId, userName) {
            if (!checkPermission('deleteUsers')) {
                alert('ليس لديك صلاحية لحذف الموظفين');
                return;
            }
            
            if (currentUser && currentUser.id === userId) {
                alert('لا يمكنك حذف حسابك الخاص!');
                return;
            }
            
            userToDelete = userId;
            document.getElementById('deleteMessage').textContent = `هل أنت متأكد من حذف الموظف "${userName}"؟ سيتم حذف جميع بياناته أيضًا.`;
            openModal('deleteModal');
        }
        
        function confirmDelete() {
            if (!userToDelete) return;
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    const userToDeleteObj = users.find(u => u.id === userToDelete);
                    
                    users = users.filter(u => u.id !== userToDelete);
                    sessions = sessions.filter(s => s.userId !== userToDelete);
                    requests = requests.filter(r => r.userId !== userToDelete);
                    logs = logs.filter(l => l.userId !== userToDelete);
                    promotions = promotions.filter(p => p.userId !== userToDelete);
                    
                    saveData();
                    
                    // إشعار بحذف موظف
                    if (currentUser && userToDeleteObj) {
                        showNotification(
                            'حذف موظف',
                            `قام ${currentUser.name} بحذف الموظف ${userToDeleteObj.name}`,
                            'user',
                            true
                        );
                    }
                    
                    updateAdminStats();
                    loadAdminUsersTable();
                    loadAdminAttendanceTable();
                    loadAdminRequestsTable();
                    loadReports();
                    
                    closeModal('deleteModal');
                    showToast('تم حذف الموظف بنجاح!', 'success');
                } catch (error) {
                    console.error('خطأ في تأكيد الحذف:', error);
                    showAlert('حدث خطأ في حذف الموظف', 'error');
                } finally {
                    showLoading(false);
                }
            }, 500);
        }

        // ===== دوال خاصة =====
        function showMainPage() {
            // التحقق من الصلاحيات أولاً
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager')) {
                // إذا كان لديه صلاحيات المدير، عرض لوحة المدير
                document.getElementById('userPanel').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('mainPage').classList.add('hidden');
                updateAdminPanel();
                showToast('مرحباً بك في لوحة المدير', 'success');
            } else {
                // إذا لم يكن لديه صلاحيات، عرض رسالة
                alert('ليس لديك صلاحية للوصول إلى لوحة المدير');
                // البقاء في صفحة المستخدم العادي
                document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('mainPage').classList.add('hidden');
                updateUserPanel();
            }
        }

        // ===== البحث في الجداول =====
        document.getElementById('searchUsers')?.addEventListener('input', function(e) {
            loadAdminUsersTable();
        });
        
        document.getElementById('searchAttendance')?.addEventListener('input', function(e) {
            try {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#adminAttendanceTable tr');
                
                rows.forEach(row => {
                    if (row.cells.length < 8) return;
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } catch (error) {
                console.error('خطأ في البحث:', error);
            }
        });

        // ===== الوضع الليلي =====
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            updateDarkModeUI();
        }
        
        function updateDarkModeUI() {
            const toggleBtn = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                toggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                toggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // ===== تهيئة النظام =====
        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadData();
                initNotifications();
                
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    currentSession = sessions.find(s => s.userId === currentUser.id && !s.logoutTime);
                    
                    document.getElementById('mainPage').classList.add('hidden');
                    
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminPanel').classList.remove('hidden');
                        updateAdminPanel();
                    } else {
                        document.getElementById('userPanel').classList.remove('hidden');
                        updateUserPanel();
                    }
                }
                
                // إعداد تواريخ الإجازة والاستقالة
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                if (document.getElementById('leaveStartDate')) {
                    document.getElementById('leaveStartDate').valueAsDate = tomorrow;
                    document.getElementById('leaveStartDate').min = tomorrow.toISOString().split('T')[0];
                }
                
                if (document.getElementById('resignEndDate')) {
                    document.getElementById('resignEndDate').valueAsDate = tomorrow;
                    document.getElementById('resignEndDate').min = tomorrow.toISOString().split('T')[0];
                }
                
                // تحديث الوقت الحالي كل ثانية
                setInterval(updateCurrentTime, 1000);
                updateCurrentTime();
                
                // الوضع الليلي
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('click', toggleDarkMode);
                    updateDarkModeUI();
                }
            } catch (error) {
                console.error('خطأ في تهيئة النظام:', error);
            }
        });
    </script>
</body>
</html>
